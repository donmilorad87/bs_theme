/* empty css          */const q=100,j=20,D=100,K=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;class O{constructor(e){this._parent=e,this._pointerEditIndex=null,this._currentPage=1}initContact(){const e=document.querySelector(".ct-contact-admin");e&&(this._section=e,this._restUrl=e.getAttribute("data-rest-url")||"",this._initSubTabs(),this._bindFilters(),this._bindPointerForm(),this._bindPointerListButtons(),this.loadUnreadCount(),this.loadMessages(1))}_initSubTabs(){const e=this._section.querySelectorAll(".ct-contact-tabs__btn"),t=5;let n=0;e.forEach(s=>{n>=t||(n++,s.addEventListener("click",()=>{const a=s.getAttribute("data-tab");this._switchTab(a,e)}))})}_switchTab(e,t){let s=0;t.forEach(o=>{s>=5||(s++,o.classList.toggle("ct-contact-tabs__btn--active",o.getAttribute("data-tab")===e))});const a=document.getElementById("ct_contact_messages_panel"),i=document.getElementById("ct_contact_config_panel");a&&(a.style.display=e==="messages"?"":"none"),i&&(i.style.display=e==="config"?"":"none")}_bindFilters(){const e=document.getElementById("ct_contact_pointer_filter"),t=document.getElementById("ct_contact_status_filter");e&&e.addEventListener("change",()=>{this._currentPage=1,this.loadMessages(1)}),t&&t.addEventListener("change",()=>{this._currentPage=1,this.loadMessages(1)})}async loadMessages(e){const t=document.getElementById("ct_contact_messages_list");if(!t)return;const n=document.getElementById("ct_contact_pointer_filter"),s=document.getElementById("ct_contact_status_filter"),a=n?n.value:"",i=s?s.value:"all",o=new URLSearchParams({page:e,pointer:a,status:i});try{const l=await(await fetch(this._restUrl+"/contact/messages?"+o.toString(),{method:"GET",headers:{"X-WP-Nonce":this._getRestNonce()},credentials:"same-origin"})).json();l.success&&l.data?(this._currentPage=l.data.current_page,this.renderMessagesList(l.data.messages,t),this._renderPagination(l.data),this.updateBadge(l.data.unread_count)):t.innerHTML='<p class="ct-admin-no-items">Error loading messages.</p>'}catch{t.innerHTML='<p class="ct-admin-no-items">Network error.</p>'}}renderMessagesList(e,t){if(!t)return;if(!e||e.length===0){t.innerHTML='<p class="ct-admin-no-items">No messages found.</p>';return}let n="";const s=Math.min(e.length,q);for(let a=0;a<s;a++){const i=e[a],o=i.is_read?"ct-contact-card--read":"ct-contact-card--unread",c=new Date(i.date).toLocaleString(),l=i.user_id>0;if(n+='<div class="ct-contact-card '+o+'" data-id="'+i.id+'">',n+='<div class="ct-contact-card__header">',n+="<strong>"+this._parent.escapeHtml(i.sender_name)+"</strong>",n+='<span class="ct-contact-card__email">'+this._parent.escapeHtml(i.sender_email)+"</span>",i.sender_phone&&(n+='<span class="ct-contact-card__phone">'+this._parent.escapeHtml(i.sender_phone)+"</span>"),n+='<span class="ct-contact-card__date">'+this._parent.escapeHtml(c)+"</span>",n+='<span class="ct-contact-card__pointer">'+this._parent.escapeHtml(i.pointer)+"</span>",n+="</div>",n+='<div class="ct-contact-card__body"><p>'+this._parent.escapeHtml(i.body)+"</p></div>",i.replies&&i.replies.length>0){n+='<div class="ct-contact-card__replies">';const r=Math.min(i.replies.length,D);for(let d=0;d<r;d++){const m=i.replies[d],u=new Date(m.date).toLocaleString();n+='<div class="ct-contact-card__reply">',n+="<strong>"+this._parent.escapeHtml(m.author_name)+"</strong>",n+='<span class="ct-contact-card__reply-date">'+this._parent.escapeHtml(u)+"</span>",n+="<p>"+this._parent.escapeHtml(m.body)+"</p>",n+="</div>"}n+="</div>"}n+='<div class="ct-contact-card__actions">',n+='<button type="button" class="button ct-contact-toggle-read" data-id="'+i.id+'" data-read="'+(i.is_read?"1":"0")+'">',n+=i.is_read?"Mark Unread":"Mark Read",n+="</button>",l&&(n+='<button type="button" class="button ct-contact-reply-btn" data-id="'+i.id+'">Reply</button>'),n+='<button type="button" class="button ct-contact-delete-btn" data-id="'+i.id+'">Delete</button>',n+="</div>",n+='<div class="ct-contact-card__reply-form" id="ct_reply_form_'+i.id+'" style="display:none;">',n+='<textarea class="ct-admin-input ct-contact-reply-text" rows="3" placeholder="Type your reply..."></textarea>',n+='<button type="button" class="button button-primary ct-contact-send-reply" data-id="'+i.id+'">Send Reply</button>',n+="</div>",n+="</div>"}t.innerHTML=n,this._bindMessageActions()}_bindMessageActions(){let t=0;this._section.querySelectorAll(".ct-contact-toggle-read").forEach(o=>{t>=200||(t++,o.addEventListener("click",()=>{const c=parseInt(o.getAttribute("data-id"),10),l=o.getAttribute("data-read")==="1";this.markRead(c,!l)}))}),t=0,this._section.querySelectorAll(".ct-contact-delete-btn").forEach(o=>{t>=200||(t++,o.addEventListener("click",()=>{const c=parseInt(o.getAttribute("data-id"),10);this.deleteMessage(c)}))}),t=0,this._section.querySelectorAll(".ct-contact-reply-btn").forEach(o=>{t>=200||(t++,o.addEventListener("click",()=>{const c=parseInt(o.getAttribute("data-id"),10);this.showReplyForm(c)}))}),t=0,this._section.querySelectorAll(".ct-contact-send-reply").forEach(o=>{t>=200||(t++,o.addEventListener("click",()=>{const c=parseInt(o.getAttribute("data-id"),10),l=document.getElementById("ct_reply_form_"+c),r=l?l.querySelector(".ct-contact-reply-text"):null;r&&this.replyToMessage(c,r.value.trim())}))})}async markRead(e,t){try{const s=await(await fetch(this._restUrl+"/contact/mark-read",{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":this._getRestNonce()},credentials:"same-origin",body:JSON.stringify({message_id:e,is_read:t})})).json();s.success?(this._parent.showNotice(s.message,"success"),this.loadMessages(this._currentPage)):this._parent.showNotice(s.message||"Error.","error")}catch{this._parent.showNotice("Network error.","error")}}async deleteMessage(e){try{const n=await(await fetch(this._restUrl+"/contact/delete",{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":this._getRestNonce()},credentials:"same-origin",body:JSON.stringify({message_id:e})})).json();n.success?(this._parent.showNotice(n.message,"success"),this.loadMessages(this._currentPage)):this._parent.showNotice(n.message||"Error.","error")}catch{this._parent.showNotice("Network error.","error")}}showReplyForm(e){const t=document.getElementById("ct_reply_form_"+e);t&&(t.style.display=t.style.display==="none"?"":"none")}async replyToMessage(e,t){if(!t){this._parent.showNotice("Reply cannot be empty.","error");return}try{const s=await(await fetch(this._restUrl+"/contact/reply",{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":this._getRestNonce()},credentials:"same-origin",body:JSON.stringify({message_id:e,reply_body:t})})).json();s.success?(this._parent.showNotice(s.message,"success"),this.loadMessages(this._currentPage)):this._parent.showNotice(s.message||"Error.","error")}catch{this._parent.showNotice("Network error.","error")}}_renderPagination(e){const t=document.getElementById("ct_contact_pagination");if(!t)return;if(e.total_pages<=1){t.innerHTML="";return}let n="";const s=Math.min(e.total_pages,50);for(let o=1;o<=s;o++){const c=o===e.current_page?" ct-contact-pagination__btn--active":"";n+='<button type="button" class="button ct-contact-pagination__btn'+c+'" data-page="'+o+'">'+o+"</button>"}t.innerHTML=n;const a=t.querySelectorAll(".ct-contact-pagination__btn");let i=0;a.forEach(o=>{i>=s||(i++,o.addEventListener("click",()=>{const c=parseInt(o.getAttribute("data-page"),10);this.loadMessages(c)}))})}async loadUnreadCount(){const e=document.querySelector("#admin_get_contact_messages_count_nonce");if(!e)return;const t=new URLSearchParams({nonce:e.value,action:"admin_get_contact_messages_count"});try{const s=await(await fetch(ajaxurl,{method:"POST",body:t})).json();s.success&&s.data&&this.updateBadge(s.data.count)}catch{}}updateBadge(e){const t=document.getElementById("ct_unread_badge");t&&(e>0?(t.textContent=e,t.style.display=""):t.style.display="none")}_bindPointerForm(){const e=document.getElementById("add_contact_pointer_form");if(!e)return;const t=document.getElementById("add_pointer_btn");t&&t.addEventListener("click",c=>{c.preventDefault(),this.addPointer()});const n=document.getElementById("save_pointer_edit_btn");n&&n.addEventListener("click",c=>{c.preventDefault(),this.addPointer()});const s=document.getElementById("cancel_pointer_edit_btn");s&&s.addEventListener("click",c=>{c.preventDefault(),this._cancelPointerEdit()});const a=e.elements.pointer_slug,i=e.elements.pointer_label,o=e.elements.pointer_emails;a&&a.addEventListener("input",()=>this._validatePointerForm()),i&&i.addEventListener("input",()=>this._validatePointerForm()),o&&o.addEventListener("input",()=>this._validatePointerForm())}_bindPointerListButtons(){let t=0;document.querySelectorAll(".ct-admin-edit-pointer").forEach(a=>{t>=50||(t++,a.addEventListener("click",i=>{i.preventDefault();const o=parseInt(a.getAttribute("data-index"),10);isNaN(o)||this.editPointer(o)}))}),t=0,document.querySelectorAll(".ct-admin-remove-pointer").forEach(a=>{t>=50||(t++,a.addEventListener("click",i=>{i.preventDefault();const o=parseInt(a.getAttribute("data-index"),10);isNaN(o)||this.removePointer(o,a)}))})}_validatePointerForm(){const e=document.getElementById("add_contact_pointer_form");if(!e)return!1;const t=e.elements.pointer_slug,n=e.elements.pointer_label,s=e.elements.pointer_emails,a=t?t.value.trim():"",i=n?n.value.trim():"",o=s?s.value.trim():"";let c=!0;const l=t?t.closest(".ct-admin-field"):null,r=document.getElementById("pointer_slug_error");a?(l&&l.classList.remove("ct-field--invalid"),r&&(r.textContent="")):(l&&l.classList.add("ct-field--invalid"),r&&(r.textContent="Slug is required."),c=!1);const d=n?n.closest(".ct-admin-field"):null,m=document.getElementById("pointer_label_error");i?(d&&d.classList.remove("ct-field--invalid"),m&&(m.textContent="")):(d&&d.classList.add("ct-field--invalid"),m&&(m.textContent="Label is required."),c=!1);const u=s?s.closest(".ct-admin-field"):null,g=document.getElementById("pointer_emails_error");if(!o)u&&u.classList.add("ct-field--invalid"),g&&(g.textContent="At least one email is required."),c=!1;else{const v=o.split(",").map(E=>E.trim()).filter(E=>E.length>0),B=[],y=20;let L=0;for(let E=0;E<v.length&&!(L>=y);E++)L++,K.test(v[E])||B.push(v[E]);v.length===0?(u&&u.classList.add("ct-field--invalid"),g&&(g.textContent="At least one email is required."),c=!1):B.length>0?(u&&u.classList.add("ct-field--invalid"),g&&(g.textContent="Invalid email: "+B[0]),c=!1):(u&&u.classList.remove("ct-field--invalid"),g&&(g.textContent=""))}const p=document.getElementById("add_pointer_btn"),_=document.getElementById("save_pointer_edit_btn");return p&&(p.disabled=!c),_&&(_.disabled=!c),c}async addPointer(){const e=document.getElementById("add_contact_pointer_form");if(!e||!this._validatePointerForm())return;const t=document.getElementById("add_pointer_btn"),n=e.elements.pointer_slug.value.trim().replace(/\s+/g,"_").toLowerCase(),s=e.elements.pointer_label.value.trim(),i=e.elements.pointer_emails.value.trim().split(",").map(d=>d.trim()).filter(d=>d.length>0),o=document.getElementById("contact_pointers_list");let c=this._getPointersData(o);const l={slug:n,label:s,emails:i},r=this._pointerEditIndex!==null;if(r&&this._pointerEditIndex>=0&&this._pointerEditIndex<c.length)c[this._pointerEditIndex]=l;else{if(c.length>=j){this._parent.showNotice("Maximum pointers reached.","error");return}c.push(l)}await this.savePointers(c,o,t,r),this._clearPointerForm(e),this._setPointerFormMode("add")}editPointer(e){const t=document.getElementById("contact_pointers_list"),n=this._getPointersData(t);if(e<0||e>=n.length)return;const s=n[e],a=document.getElementById("add_contact_pointer_form");a&&(a.elements.pointer_slug.value=s.slug,a.elements.pointer_label.value=s.label,a.elements.pointer_emails.value=(s.emails||[]).join(", "),this._setPointerFormMode("edit"),this._pointerEditIndex=e,this._validatePointerForm(),a.scrollIntoView({behavior:"smooth",block:"center"}))}async removePointer(e,t){const n=document.getElementById("contact_pointers_list");let s=this._getPointersData(n);e<0||e>=s.length||(s.splice(e,1),this._pointerEditIndex===e?this._cancelPointerEdit():this._pointerEditIndex!==null&&this._pointerEditIndex>e&&this._pointerEditIndex--,await this.savePointers(s,n,t,!1))}async savePointers(e,t,n,s){const a=document.querySelector('#add_contact_pointer_form input[name="admin_save_contact_pointers_nonce"]');if(!a)return;const i=new URLSearchParams({nonce:a.value,action:"admin_save_contact_pointers",input:JSON.stringify(e)});this._parent.setButtonState(n,"loading");try{(await(await fetch(ajaxurl,{method:"POST",body:i})).json()).success?(this._parent.setButtonState(n,"success"),t&&(t.dataset.pointers=JSON.stringify(e)),this.renderPointerList(e,t),this._parent.showNotice(s?"Pointer updated.":"Pointer saved.","success")):(this._parent.setButtonState(n,"error"),this._parent.showNotice("Error saving pointer.","error"))}catch{this._parent.setButtonState(n,"error"),this._parent.showNotice("Network error.","error")}}renderPointerList(e,t){if(!t)return;if(!e||e.length===0){t.innerHTML='<p class="ct-admin-no-items">No pointers configured yet.</p>';return}let n='<ul class="ct-admin-pointer-list">';const s=Math.min(e.length,j);for(let a=0;a<s;a++){const i=e[a];n+='<li class="ct-admin-pointer-item"><span class="ct-admin-pointer-num">'+(a+1)+'.</span><span class="ct-admin-pointer-slug">'+this._parent.escapeHtml(i.slug)+'</span><span class="ct-admin-pointer-label">'+this._parent.escapeHtml(i.label)+'</span><span class="ct-admin-pointer-emails">'+this._parent.escapeHtml((i.emails||[]).join(", "))+'</span><div class="ct-admin-pointer-actions"><button type="button" class="button ct-admin-edit-pointer" data-index="'+a+'">Edit</button><button type="button" class="button ct-admin-remove-pointer" data-index="'+a+'">Remove</button></div></li>'}n+="</ul>",t.innerHTML=n,this._bindPointerListButtons()}_getPointersData(e){if(!e||!e.dataset.pointers)return[];try{return JSON.parse(e.dataset.pointers)}catch{return[]}}_clearPointerForm(e){if(!e)return;e.elements.pointer_slug.value="",e.elements.pointer_label.value="",e.elements.pointer_emails.value="";const t=e.querySelectorAll(".ct-admin-field"),n=10;let s=0;t.forEach(o=>{s>=n||(s++,o.classList.remove("ct-field--invalid"))});const a=e.querySelectorAll(".ct-pointer-form__error");s=0,a.forEach(o=>{s>=n||(s++,o.textContent="")});const i=document.getElementById("add_pointer_btn");i&&(i.disabled=!0)}_setPointerFormMode(e){const t=document.getElementById("pointer_form_heading"),n=document.getElementById("add_pointer_btn"),s=document.getElementById("save_pointer_edit_btn"),a=document.getElementById("cancel_pointer_edit_btn");e==="edit"?(t&&(t.textContent="Edit Pointer"),n&&(n.style.display="none"),s&&(s.style.display=""),a&&(a.style.display="")):(this._pointerEditIndex=null,t&&(t.textContent="Add New Pointer"),n&&(n.style.display=""),s&&(s.style.display="none"),a&&(a.style.display="none"))}_cancelPointerEdit(){const e=document.getElementById("add_contact_pointer_form");this._clearPointerForm(e),this._setPointerFormMode("add")}_getRestNonce(){return typeof wpApiSettings<"u"?wpApiSettings.nonce:""}}class U{constructor(){this.btnResetTimers=new WeakMap,this.initExportImport(),this.initEmailSettings(),this.initJwtAuth(),this._contact=new O(this),this._contact.initContact()}setButtonState(e,t){if(!e)return;const n=this.btnResetTimers.get(e);if(n&&(clearTimeout(n),this.btnResetTimers.delete(e)),e.dataset.originalText||(e.dataset.originalText=e.textContent),e.classList.remove("ct-btn--loading","ct-btn--success","ct-btn--error"),!t){e.textContent=e.dataset.originalText,e.disabled=!1;return}if(t==="loading")e.textContent="",e.classList.add("ct-btn--loading"),e.disabled=!0;else if(t==="success"){e.textContent="",e.classList.add("ct-btn--success"),e.disabled=!0;const s=setTimeout(()=>{this.setButtonState(e,null)},2e3);this.btnResetTimers.set(e,s)}else if(t==="error"){e.textContent="",e.classList.add("ct-btn--error"),e.disabled=!0;const s=setTimeout(()=>{this.setButtonState(e,null)},2e3);this.btnResetTimers.set(e,s)}}initEmailSettings(){this.ecDebounceTimer=null,this.ecSaving=!1,this.ecActiveFields=new Set,this.ecFieldResetTimers=new Map,this.initEmailConfigForm()}initEmailConfigForm(){const e=document.querySelector("#email_config_form");if(!e)return;const t=e.querySelectorAll(".emailConfigInputs"),n=20;let s=0;t.forEach(a=>{s>=n||(s++,a.addEventListener("input",()=>{this.addFieldToSet(a.closest(".ct-admin-field"),this.ecActiveFields,this.ecFieldResetTimers),this.debounceEmailConfigSave(e)}),a.addEventListener("change",()=>{this.addFieldToSet(a.closest(".ct-admin-field"),this.ecActiveFields,this.ecFieldResetTimers),this.debounceEmailConfigSave(e)}))})}debounceEmailConfigSave(e){this.ecDebounceTimer&&clearTimeout(this.ecDebounceTimer),this.ecDebounceTimer=setTimeout(()=>{this.saveEmailConfig(e)},500)}async saveEmailConfig(e){if(this.ecSaving)return;this.ecSaving=!0;const t=new Set(this.ecActiveFields),n=e.elements.admin_save_email_config_nonce.value,s=JSON.stringify({host:(e.elements.ec_host||{}).value||"",port:parseInt((e.elements.ec_port||{}).value,10)||587,username:(e.elements.ec_username||{}).value||"",password:(e.elements.ec_password||{}).value||"",encryption:(e.elements.ec_encryption||{}).value||"tls",from_email:(e.elements.ec_from_email||{}).value||"",from_name:(e.elements.ec_from_name||{}).value||""}),a=new URLSearchParams({nonce:n,action:"admin_save_email_config",input:s});try{if((await(await fetch(ajaxurl,{method:"POST",body:a})).json()).success){this.setFieldsState("saved",t,this.ecActiveFields,this.ecFieldResetTimers),this.showNotice("Email configuration saved.","success");const c=e.elements.ec_password;c&&(c.value="")}else this.setFieldsState("error",t,this.ecActiveFields,this.ecFieldResetTimers),this.showNotice("Error saving email configuration.","error")}catch{this.setFieldsState("error",t,this.ecActiveFields,this.ecFieldResetTimers),this.showNotice("Network error. Please try again.","error")}finally{this.ecSaving=!1,this.ecActiveFields.size>0&&this.debounceEmailConfigSave(e)}}initJwtAuth(){this.jwtDebounceTimer=null,this.jwtSaving=!1,this.jwtActiveFields=new Set,this.jwtFieldResetTimers=new Map;const e=document.querySelector("#jwt_auth_form");if(!e)return;const t=e.querySelectorAll(".jwtAuthInputs"),n=10;let s=0;t.forEach(i=>{s>=n||(s++,i.addEventListener("input",()=>{this.addFieldToSet(i.closest(".ct-admin-field"),this.jwtActiveFields,this.jwtFieldResetTimers),this.debounceJwtSave(e)}),i.addEventListener("change",()=>{this.addFieldToSet(i.closest(".ct-admin-field"),this.jwtActiveFields,this.jwtFieldResetTimers),this.debounceJwtSave(e)}))});const a=document.querySelector("#generate_jwt_secret_btn");a&&a.addEventListener("click",i=>{i.preventDefault();const o=document.querySelector("#jwt_secret");if(o){const c=new Uint8Array(32);crypto.getRandomValues(c);const l=Array.from(c,r=>r.toString(16).padStart(2,"0")).join("");o.value=l,o.dispatchEvent(new Event("input",{bubbles:!0}))}})}debounceJwtSave(e){this.jwtDebounceTimer&&clearTimeout(this.jwtDebounceTimer),this.jwtDebounceTimer=setTimeout(()=>{this.saveJwtAuth(e)},500)}async saveJwtAuth(e){if(this.jwtSaving)return;this.jwtSaving=!0;const t=new Set(this.jwtActiveFields),n=e.elements.admin_save_jwt_auth_nonce.value,s=JSON.stringify({secret:(e.elements.jwt_secret||{}).value||"",expiration_hours:parseInt((e.elements.jwt_expiration_hours||{}).value,10)||24}),a=new URLSearchParams({nonce:n,action:"admin_save_jwt_auth",input:s});try{(await(await fetch(ajaxurl,{method:"POST",body:a})).json()).success?(this.setFieldsState("saved",t,this.jwtActiveFields,this.jwtFieldResetTimers),this.showNotice("JWT auth settings saved.","success")):(this.setFieldsState("error",t,this.jwtActiveFields,this.jwtFieldResetTimers),this.showNotice("Error saving JWT auth settings.","error"))}catch{this.setFieldsState("error",t,this.jwtActiveFields,this.jwtFieldResetTimers),this.showNotice("Network error. Please try again.","error")}finally{this.jwtSaving=!1,this.jwtActiveFields.size>0&&this.debounceJwtSave(e)}}addFieldToSet(e,t,n){if(!e)return;const s=n.get(e);s&&(clearTimeout(s),n.delete(e)),e.classList.remove("ct-field--saved","ct-field--error"),e.classList.add("ct-field--saving"),t.add(e)}setFieldsState(e,t,n,s){const a=t||n;for(const i of a){const o=s.get(i);if(o&&(clearTimeout(o),s.delete(i)),i.classList.remove("ct-field--saving","ct-field--saved","ct-field--error"),e&&(i.classList.add("ct-field--"+e),e==="saved"||e==="error")){const c=setTimeout(()=>{i.classList.remove("ct-field--saved","ct-field--error"),s.delete(i)},2e3);s.set(i,c)}n.delete(i)}}initExportImport(){const e=document.querySelector("#export_settings_btn");e&&e.addEventListener("click",s=>{s.preventDefault(),this.exportSettings()});const t=document.querySelector("#import_settings_file"),n=document.querySelector("#import_settings_btn");t&&n&&(t.addEventListener("change",()=>{const s=t.files[0],a=document.querySelector("#import_file_info"),i=document.querySelector("#import_file_name");s&&s.name.endsWith(".json")?(n.disabled=!1,a&&i&&(i.textContent=s.name,a.style.display="block")):(n.disabled=!0,a&&(a.style.display="none"))}),n.addEventListener("click",s=>{s.preventDefault(),this.importSettings()}))}async exportSettings(){const e=document.querySelector("#export_settings_form");if(!e)return;const t=document.querySelector("#export_settings_btn"),n=e.elements.admin_export_settings_nonce.value,s=new URLSearchParams({nonce:n,action:"admin_export_settings",input:"1"});this.setButtonState(t,"loading");try{const i=await(await fetch(ajaxurl,{method:"POST",body:s})).json();if(i.success){const o=JSON.stringify(i.data,null,2),c=new Blob([o],{type:"application/json"}),l=URL.createObjectURL(c),r=document.createElement("a");r.href=l,r.download="ct-custom-settings-"+this.getDateStamp()+".json",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(l),this.setButtonState(t,"success"),this.showNotice("Settings exported successfully.","success")}else this.setButtonState(t,"error"),this.showNotice("Error exporting settings.","error")}catch{this.setButtonState(t,"error"),this.showNotice("Network error. Please try again.","error")}}importSettings(){const e=document.querySelector("#import_settings_form"),t=document.querySelector("#import_settings_file"),n=document.querySelector("#import_settings_btn");if(!e||!t||!t.files[0])return;const s=e.elements.admin_import_settings_nonce.value,a=t.files[0],i=new FileReader;i.onload=async o=>{const c=o.target.result;let l;try{l=JSON.parse(c)}catch{this.showNotice("Invalid JSON file.","error");return}if(!l.theme||l.theme!=="ct-custom"){this.showNotice("This file is not a valid CT Custom theme export.","error");return}const r=new URLSearchParams({nonce:s,action:"admin_import_settings",input:c});this.setButtonState(n,"loading");try{const m=await(await fetch(ajaxurl,{method:"POST",body:r})).json();if(m.success)this.setButtonState(n,"success"),this.showNotice("Settings imported successfully. Reloading page...","success"),setTimeout(()=>{window.location.reload()},1500);else{const u=m.data&&m.data.message?m.data.message:"Error importing settings.";this.setButtonState(n,"error"),this.showNotice(u,"error")}}catch{this.setButtonState(n,"error"),this.showNotice("Network error. Please try again.","error")}},i.readAsText(a)}getDateStamp(){const e=new Date,t=n=>String(n).padStart(2,"0");return e.getFullYear()+"-"+t(e.getMonth()+1)+"-"+t(e.getDate())}escapeHtml(e){const t=document.createElement("div");return t.appendChild(document.createTextNode(e)),t.innerHTML}showNotice(e,t){const n=document.querySelector(".ct-admin-notice");n&&n.remove();const s=document.createElement("div");s.className="ct-admin-notice ct-admin-notice--"+t,s.textContent=e,document.querySelector(".wrap").prepend(s),setTimeout(()=>{s.remove()},4e3)}}class H{constructor(){this.section=document.querySelector(".ct-lang-section"),this.section&&(this.nonce=this.section.dataset.nonce||"",this.ajaxUrl=this.section.dataset.ajaxUrl||"",this.currentTransKey="",this.allKeys=[],this.debounceTimer=null,this.currentKeyIsPlural=!1,this.initLanguages(),this.initTranslationEditor(),this.initPageTranslations())}initLanguages(){const e=document.getElementById("ct_add_language_form");e&&(e.addEventListener("submit",l=>this.handleAddLanguage(l)),this._bindLangFormValidation(e));const t=document.getElementById("ct_lang_flag_btn");t&&t.addEventListener("click",()=>this.openMediaPicker());const n=document.getElementById("ct_lang_flag_remove");n&&n.addEventListener("click",()=>this.clearFlag());const s=document.getElementById("ct_edit_language_form");s&&s.addEventListener("submit",l=>this.handleUpdateLanguage(l));const a=document.getElementById("ct_edit_cancel");a&&a.addEventListener("click",()=>this.closeEditModal());const i=document.querySelector(".ct-lang-edit-modal__backdrop");i&&i.addEventListener("click",()=>this.closeEditModal());const o=document.getElementById("ct_edit_flag_btn");o&&o.addEventListener("click",()=>this.openEditMediaPicker());const c=document.getElementById("ct_edit_flag_remove");c&&c.addEventListener("click",()=>this.clearEditFlag()),this.bindTableActions()}bindTableActions(){const e=document.getElementById("ct_language_table");e&&(e.addEventListener("click",t=>{const n=t.target,s=n.closest("tr[data-iso2]");if(!s)return;const a=s.dataset.iso2;n.classList.contains("ct-lang-edit")?this.openEditModal(n):n.classList.contains("ct-lang-set-default")?this.setDefaultLanguage(a):n.classList.contains("ct-lang-remove")&&this.removeLanguage(a)}),e.addEventListener("change",t=>{if(t.target.classList.contains("ct-lang-enable-toggle")){const n=t.target.closest("tr[data-iso2]"),s=n?n.dataset.iso2:"";s&&this.toggleLanguageEnabled(s,t.target.checked)}}))}_bindLangFormValidation(e){const t=["ct_lang_iso2","ct_lang_iso3","ct_lang_native_name","ct_lang_locale"];let s=0;for(const a of t){if(s>=4)break;s++;const i=document.getElementById(a);i&&i.addEventListener("input",()=>this._validateLangForm())}}_validateLangForm(){const e=document.getElementById("ct_lang_iso2"),t=document.getElementById("ct_lang_iso3"),n=document.getElementById("ct_lang_native_name"),s=document.getElementById("ct_lang_locale"),a=document.getElementById("ct_lang_submit_btn"),i=e?e.value.trim():"",o=t?t.value.trim():"",c=n?n.value.trim():"",l=s?s.value.trim():"";let r=!0;const d=e?e.closest(".ct-lang-add-form__field"):null,m=document.getElementById("ct_lang_iso2_error");i?/^[a-z]{2}$/.test(i)?(d&&d.classList.remove("ct-field--invalid"),m&&(m.textContent="")):(d&&d.classList.add("ct-field--invalid"),m&&(m.textContent="Must be exactly 2 lowercase letters."),r=!1):(d&&d.classList.add("ct-field--invalid"),m&&(m.textContent="ISO code is required."),r=!1);const u=t?t.closest(".ct-lang-add-form__field"):null,g=document.getElementById("ct_lang_iso3_error");o&&!/^[a-z]{3}$/.test(o)?(u&&u.classList.add("ct-field--invalid"),g&&(g.textContent="Must be exactly 3 lowercase letters."),r=!1):(u&&u.classList.remove("ct-field--invalid"),g&&(g.textContent=""));const p=n?n.closest(".ct-lang-add-form__field"):null,_=document.getElementById("ct_lang_native_name_error");c?(p&&p.classList.remove("ct-field--invalid"),_&&(_.textContent="")):(p&&p.classList.add("ct-field--invalid"),_&&(_.textContent="Native name is required."),r=!1);const v=s?s.closest(".ct-lang-add-form__field"):null,B=document.getElementById("ct_lang_locale_error");return l&&!/^[a-z]{2}_[A-Z]{2}$/.test(l)?(v&&v.classList.add("ct-field--invalid"),B&&(B.textContent="Must match format: xx_XX (e.g. fr_FR)."),r=!1):(v&&v.classList.remove("ct-field--invalid"),B&&(B.textContent="")),a&&(a.disabled=!r),r}async handleAddLanguage(e){if(e.preventDefault(),!this._validateLangForm())return;const t=document.getElementById("ct_lang_iso2").value.trim().toLowerCase(),n=document.getElementById("ct_lang_iso3").value.trim().toLowerCase(),s=document.getElementById("ct_lang_native_name").value.trim(),a=document.getElementById("ct_lang_locale").value.trim(),i=document.getElementById("ct_lang_flag").value.trim(),o={iso2:t,iso3:n,native_name:s,locale:a,flag:i},c=await this.ajaxPost("admin_add_language",JSON.stringify(o));if(c.success){window.ctToast.show(c.data.message||"Language added.","success"),document.getElementById("ct_add_language_form").reset(),this.clearFlag();const l=document.getElementById("ct_lang_submit_btn");l&&(l.disabled=!0);const r=document.querySelectorAll("#ct_add_language_form .ct-field--invalid"),d=10;let m=0;for(const u of r){if(m>=d)break;m++,u.classList.remove("ct-field--invalid")}c.data.language&&this.appendLanguageRow(c.data.language)}else{const l=c.data?.type||"error";window.ctToast.show(c.data?.message||"Error adding language.",l)}}async setDefaultLanguage(e){const t=new FormData;t.append("action","admin_set_default_language"),t.append("nonce",this.nonce),t.append("iso2",e);const n=await this.ajaxPostForm(t);if(n.success)window.ctToast.show(n.data.message||"Default language updated.","success"),this.updateDefaultInTable(e);else{const s=n.data?.type||"error";window.ctToast.show(n.data?.message||"Failed to set default language.",s)}}removeLanguage(e){this.showConfirmModal("Remove Language",`Are you sure you want to remove the language <strong>${this.escapeHtml(e.toUpperCase())}</strong>?`,"Remove",()=>this.showRemovePagesModal(e))}showRemovePagesModal(e){this.showConfirmModal("Remove Language",`<p>The language <strong>${this.escapeHtml(e.toUpperCase())}</strong>, its pages, menus and widgets will be removed.</p><label class="ct-confirm-modal__checkbox-label"><input type="checkbox" id="ct_remove_force_delete" class="ct-confirm-modal__checkbox" checked><span>Delete pages permanently (skip trash)</span></label><label class="ct-confirm-modal__checkbox-label"><input type="checkbox" id="ct_remove_menus" class="ct-confirm-modal__checkbox" checked><span>Remove menus</span></label><label class="ct-confirm-modal__checkbox-label"><input type="checkbox" id="ct_remove_widgets" class="ct-confirm-modal__checkbox" checked><span>Remove widgets</span></label>`,"Remove Language",()=>{const t=!!document.getElementById("ct_remove_force_delete")?.checked,n=!!document.getElementById("ct_remove_menus")?.checked,s=!!document.getElementById("ct_remove_widgets")?.checked;this.executeRemoveLanguage(e,t,n,s)})}async executeRemoveLanguage(e,t,n=!0,s=!0){const a=new FormData;a.append("action","admin_remove_language"),a.append("nonce",this.nonce),a.append("iso2",e),a.append("force_delete",t?"true":"false"),a.append("remove_menus",n?"true":"false"),a.append("remove_widgets",s?"true":"false");const i=await this.ajaxPostForm(a);if(i.success)window.ctToast.show(i.data.message||"Language removed.","success"),this.removeLanguageRow(e);else{const o=i.data?.type||"error";window.ctToast.show(i.data?.message||"Failed to remove language.",o)}}showConfirmModal(e,t,n,s,a="",i=null){this.closeConfirmModal();const o=document.createElement("div");o.className="ct-confirm-modal__backdrop";const c=document.createElement("div");c.className="ct-confirm-modal__panel";const l=document.createElement("h3");l.className="ct-confirm-modal__title",l.textContent=e;const r=document.createElement("div");r.className="ct-confirm-modal__body",r.innerHTML=t;const d=document.createElement("div");d.className="ct-confirm-modal__actions";const m=document.createElement("button");m.type="button",m.className="button ct-confirm-modal__cancel",m.textContent="Cancel";const u=document.createElement("button");if(u.type="button",u.className="button button-primary ct-confirm-modal__confirm",u.textContent=n,d.appendChild(m),a&&i){const _=document.createElement("button");_.type="button",_.className="button ct-confirm-modal__alt",_.textContent=a,d.appendChild(_),_.addEventListener("click",()=>{i(),p()})}d.appendChild(u),c.appendChild(l),c.appendChild(r),c.appendChild(d);const g=document.createElement("div");g.className="ct-confirm-modal",g.id="ct_confirm_modal",g.setAttribute("role","dialog"),g.setAttribute("aria-modal","true"),g.appendChild(o),g.appendChild(c);const p=()=>g.remove();m.addEventListener("click",p),o.addEventListener("click",p),u.addEventListener("click",()=>{s(),p()}),document.body.appendChild(g),u.focus()}closeConfirmModal(){const e=document.getElementById("ct_confirm_modal");e&&e.remove()}async toggleLanguageEnabled(e,t){(await this.ajaxPost("admin_save_languages",JSON.stringify(this.getUpdatedLanguagesArray(e,"enabled",t)))).success||window.location.reload()}getUpdatedLanguagesArray(e,t,n){const s=document.querySelectorAll("#ct_language_table tbody tr[data-iso2]"),a=[],i=50;let o=0;for(const c of s){if(o>=i)break;o++;const l=c.dataset.iso2,r=c.querySelectorAll("td"),d={iso2:l,native_name:r[2]?r[2].textContent.trim():"",enabled:l===e?n:!!c.querySelector(".ct-lang-enable-toggle:checked")};a.push(d)}return a}openMediaPicker(){if(!wp||!wp.media)return;const e=wp.media({title:"Choose Flag",multiple:!1,library:{type:"image"}});e.on("select",()=>{const t=e.state().get("selection").first().toJSON();document.getElementById("ct_lang_flag").value=t.url||"";const n=document.getElementById("ct_lang_flag_preview");n&&(n.src=t.url||"",n.style.display=t.url?"block":"none");const s=document.getElementById("ct_lang_flag_remove");s&&(s.style.display=t.url?"inline-block":"none")}),e.open()}clearFlag(){document.getElementById("ct_lang_flag").value="";const e=document.getElementById("ct_lang_flag_preview");e&&(e.style.display="none");const t=document.getElementById("ct_lang_flag_remove");t&&(t.style.display="none")}appendLanguageRow(e){const t=document.querySelector("#ct_language_table tbody");if(!t)return;const n=this.buildLanguageRow(e);t.appendChild(n)}removeLanguageRow(e){const t=document.querySelector(`#ct_language_table tbody tr[data-iso2="${e}"]`);t&&t.remove()}updateDefaultInTable(e){const t=document.querySelectorAll("#ct_language_table tbody tr[data-iso2]"),n=50;let s=0;for(const a of t){if(s>=n)break;s++;const i=a.dataset.iso2,o=a.querySelectorAll("td")[4],c=a.querySelectorAll("td")[5],l=a.querySelectorAll("td")[6];if(!(!o||!c||!l))if(i===e){o.innerHTML='<span class="ct-lang-table__badge ct-lang-table__badge--default">Default</span>';const r=c.querySelector(".ct-lang-enable-toggle");r&&(r.checked=!0,r.disabled=!0);const d=l.querySelector(".ct-lang-remove");d&&d.remove()}else{o.querySelector(".ct-lang-table__badge--default")&&(o.innerHTML='<button type="button" class="button button-small ct-lang-set-default">Set Default</button>');const d=c.querySelector(".ct-lang-enable-toggle");if(d&&(d.disabled=!1),l.querySelector(".ct-lang-edit")&&!l.querySelector(".ct-lang-remove")){const u=document.createElement("button");u.type="button",u.className="button button-small ct-lang-remove",u.title="Remove",u.textContent="×",l.appendChild(u)}}}}updateLanguageRow(e,t){const n=document.querySelector(`#ct_language_table tbody tr[data-iso2="${e}"]`);if(!n)return;const s=n.querySelectorAll("td");s[0]&&t.flag!==void 0&&(t.flag?s[0].innerHTML=`<img src="${this.escapeAttr(t.flag)}" alt="" class="ct-lang-table__flag">`:s[0].innerHTML=`<span class="ct-lang-table__flag-placeholder">${this.escapeHtml(e.toUpperCase())}</span>`),s[2]&&t.native_name&&(s[2].textContent=t.native_name),s[3]&&t.locale!==void 0&&(s[3].textContent=t.locale||"");const a=n.querySelector(".ct-lang-edit");a&&(a.dataset.iso2=e,a.dataset.iso3=t.iso3||"",a.dataset.nativeName=t.native_name||"",a.dataset.locale=t.locale||"",a.dataset.flag=t.flag||"")}buildLanguageRow(e){const t=document.createElement("tr");t.dataset.iso2=e.iso2;const n=e.iso2||"",s=e.native_name||"",a=e.flag||"",i=Array.isArray(e.locales)?e.locales.join(", "):"",o=!!e.is_default,c=e.enabled!==!1,l=e.iso3||"",r=Array.isArray(e.locales)&&e.locales.length>0?e.locales[0]:"",d=document.createElement("td");if(a){const f=document.createElement("img");f.src=a,f.alt="",f.className="ct-lang-table__flag",d.appendChild(f)}else{const f=document.createElement("span");f.className="ct-lang-table__flag-placeholder",f.textContent=n.toUpperCase(),d.appendChild(f)}const m=document.createElement("td"),u=document.createElement("code");u.textContent=n,m.appendChild(u);const g=document.createElement("td");g.textContent=s;const p=document.createElement("td");p.textContent=i;const _=document.createElement("td");if(o)_.innerHTML='<span class="ct-lang-table__badge ct-lang-table__badge--default">Default</span>';else{const f=document.createElement("button");f.type="button",f.className="button button-small ct-lang-set-default",f.textContent="Set Default",_.appendChild(f)}const v=document.createElement("td"),B=document.createElement("label");B.className="ct-lang-toggle";const y=document.createElement("input");y.type="checkbox",y.className="ct-lang-toggle__input ct-lang-enable-toggle",y.checked=c,o&&(y.disabled=!0);const L=document.createElement("span");L.className="ct-lang-toggle__slider",B.appendChild(y),B.appendChild(L),v.appendChild(B);const E=document.createElement("td"),h=document.createElement("button");if(h.type="button",h.className="button button-small ct-lang-edit",h.dataset.iso2=n,h.dataset.iso3=l,h.dataset.nativeName=s,h.dataset.locale=r,h.dataset.flag=a,h.title="Edit",h.textContent="Edit",E.appendChild(h),!o){const f=document.createElement("button");f.type="button",f.className="button button-small ct-lang-remove",f.title="Remove",f.textContent="×",E.appendChild(f)}return t.appendChild(d),t.appendChild(m),t.appendChild(g),t.appendChild(p),t.appendChild(_),t.appendChild(v),t.appendChild(E),t}openEditModal(e){const t=document.getElementById("ct_lang_edit_modal");if(!t)return;document.getElementById("ct_edit_iso2").value=e.dataset.iso2||"",document.getElementById("ct_edit_iso2_badge").textContent=(e.dataset.iso2||"").toUpperCase(),document.getElementById("ct_edit_native_name").value=e.dataset.nativeName||"",document.getElementById("ct_edit_iso3").value=e.dataset.iso3||"",document.getElementById("ct_edit_locale").value=e.dataset.locale||"",document.getElementById("ct_edit_flag").value=e.dataset.flag||"";const n=document.getElementById("ct_edit_flag_preview"),s=document.getElementById("ct_edit_flag_remove");e.dataset.flag?(n.src=e.dataset.flag,n.style.display="block",s.style.display="inline-block"):(n.style.display="none",s.style.display="none");const a=document.getElementById("ct_edit_status");a&&(a.textContent=""),t.style.display="flex"}closeEditModal(){const e=document.getElementById("ct_lang_edit_modal");e&&(e.style.display="none")}async handleUpdateLanguage(e){e.preventDefault();const t=document.getElementById("ct_edit_iso2").value.trim(),n=document.getElementById("ct_edit_native_name").value.trim(),s=document.getElementById("ct_edit_iso3").value.trim().toLowerCase(),a=document.getElementById("ct_edit_locale").value.trim(),i=document.getElementById("ct_edit_flag").value.trim();if(!t||!n)return;const o={iso2:t,iso3:s,native_name:n,locale:a,flag:i},c=await this.ajaxPost("admin_update_language",JSON.stringify(o));if(c.success)window.ctToast.show(c.data.message||"Language updated.","success"),this.updateLanguageRow(t,{iso3:s,native_name:n,locale:a,flag:i}),this.closeEditModal();else{const l=c.data?.type||"error";window.ctToast.show(c.data?.message||"Failed to update language.",l)}}openEditMediaPicker(){if(!wp||!wp.media)return;const e=wp.media({title:"Choose Flag",multiple:!1,library:{type:"image"}});e.on("select",()=>{const t=e.state().get("selection").first().toJSON();document.getElementById("ct_edit_flag").value=t.url||"";const n=document.getElementById("ct_edit_flag_preview");n&&(n.src=t.url||"",n.style.display=t.url?"block":"none");const s=document.getElementById("ct_edit_flag_remove");s&&(s.style.display=t.url?"inline-block":"none")}),e.open()}clearEditFlag(){document.getElementById("ct_edit_flag").value="";const e=document.getElementById("ct_edit_flag_preview");e&&(e.style.display="none");const t=document.getElementById("ct_edit_flag_remove");t&&(t.style.display="none")}initTranslationEditor(){this.loadTranslationKeys();const e=document.getElementById("ct_trans_search");e&&e.addEventListener("input",()=>this.filterKeys(e.value));const t=document.getElementById("ct_trans_add_key");t&&t.addEventListener("click",()=>this.openAddKeyModal()),this.initAddKeyModal();const n=document.getElementById("ct_trans_delete_key");n&&n.addEventListener("click",()=>this.deleteCurrentKey());const s=document.getElementById("ct_trans_type_singular");s&&s.addEventListener("click",()=>this.toggleKeyType("singular"));const a=document.getElementById("ct_trans_type_plural");a&&a.addEventListener("click",()=>this.toggleKeyType("plural"));const i=document.getElementById("ct_trans_export");i&&i.addEventListener("click",()=>this.exportTranslations());const o=document.getElementById("ct_trans_import");o&&o.addEventListener("click",()=>{document.getElementById("ct_trans_import_file")?.click()});const c=document.getElementById("ct_trans_import_file");c&&c.addEventListener("change",l=>this.importTranslations(l))}async loadTranslationKeys(){const e=await this.ajaxPostSimple("admin_get_translation_keys");e.success&&e.data.keys&&(this.allKeys=e.data.keys,this.renderKeyList(this.allKeys))}renderKeyList(e){const t=document.getElementById("ct_trans_key_list");if(!t)return;t.innerHTML="";const n=500;let s=0;for(const a of e){if(s>=n)break;s++;const i=document.createElement("li");i.className="ct-trans-editor__key-item",i.textContent=a,i.dataset.key=a,a===this.currentTransKey&&i.classList.add("ct-trans-editor__key-item--active"),i.addEventListener("click",()=>this.selectKey(a)),t.appendChild(i)}e.length===0&&(t.innerHTML='<li class="ct-trans-editor__key-empty">No keys found</li>')}filterKeys(e){const t=e.toLowerCase(),n=this.allKeys.filter(s=>s.toLowerCase().includes(t));this.renderKeyList(n)}async selectKey(e){this.currentTransKey=e;const t=document.getElementById("ct_trans_placeholder"),n=document.getElementById("ct_trans_fields"),s=document.getElementById("ct_trans_current_key");t&&(t.style.display="none"),n&&(n.style.display="block"),s&&(s.textContent=e),this.renderKeyList(this.allKeys.filter(g=>{const p=document.getElementById("ct_trans_search");return!p||!p.value?!0:g.toLowerCase().includes(p.value.toLowerCase())}));const a=document.getElementById("ct_trans_lang_fields");if(!a)return;a.innerHTML="<p>Loading...</p>";const i=await this.ajaxPostSimple("admin_export_translations");if(!i.success){a.innerHTML="<p>Error loading translations.</p>";return}const o=i.data.translations||{},c=i.data.languages||[];this.currentKeyIsPlural=!1;const l=50;let r=0;for(const g of c){if(r>=l)break;r++;const p=(o[g.iso2]||{})[e];if(typeof p=="object"&&p!==null){this.currentKeyIsPlural=!0;break}}this.updateToggleUI(),a.innerHTML="";const d=this.currentKeyIsPlural,m=50;let u=0;for(const g of c){if(u>=m)break;u++;const p=g.iso2,_=(o[p]||{})[e];let v="";const B={};if(typeof _=="string")v=_;else if(typeof _=="object"&&_!==null){v=_.singular||"";const T=["zero","one","two","few","many","other"],I=6;let S=0;for(const b of T){if(S>=I)break;S++,B[b]=_[b]||""}}const y=document.createElement("div");y.className="ct-trans-editor__lang-field";const L=document.createElement("label");L.textContent=`${g.native_name} (${p})`,y.appendChild(L);const E=document.createElement("div");E.className="ct-trans-editor__singular-wrap",E.style.display=d?"none":"block";const h=document.createElement("input");h.type="text",h.value=v,h.dataset.iso2=p,h.dataset.singular="true",h.addEventListener("input",()=>{this.debounceSaveTranslation(e,p),this.detectPlaceholders()}),E.appendChild(h),y.appendChild(E);const f=document.createElement("div");f.className="ct-trans-editor__plural-wrap",f.style.display=d?"block":"none";const F=["zero","one","two","few","many","other"],x=6;let N=0;for(const T of F){if(N>=x)break;N++;const I=document.createElement("div");I.className="ct-trans-editor__plural-form";const S=document.createElement("span");S.className="ct-trans-editor__plural-label",S.textContent=T;const b=document.createElement("input");b.type="text",b.value=B[T]||"",b.dataset.iso2=p,b.dataset.form=T,b.dataset.plural="true",b.addEventListener("input",()=>{this.debounceSaveTranslation(e,p),this.detectPlaceholders()}),I.appendChild(S),I.appendChild(b),f.appendChild(I)}y.appendChild(f),a.appendChild(y)}this.detectPlaceholders()}debounceSaveTranslation(e,t){this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.saveTranslation(e,t)},500)}async saveTranslation(e,t){const n=document.getElementById("ct_trans_lang_fields");if(!n)return;const s=n.querySelector(`input[data-iso2="${t}"][data-singular]`),a=s?s.value:"",i=n.querySelectorAll(`input[data-iso2="${t}"][data-plural="true"]`),o={},c=6;let l=0;for(const m of i){if(l>=c)break;l++,o[m.dataset.form]=m.value,m.value.trim()}let r;if(this.currentKeyIsPlural){r={singular:a};const m=["zero","one","two","few","many","other"],u=6;let g=0;for(const p of m){if(g>=u)break;g++,o[p]&&(r[p]=o[p])}}else r=a;const d=await this.ajaxPost("admin_save_translation",JSON.stringify({key:e,iso2:t,value:r}));d.success?window.ctToast.show("Saved","success"):window.ctToast.show(d.data?.message||"Error saving translation.","error")}initAddKeyModal(){const e=document.getElementById("ct_add_key_modal"),t=e?e.querySelector(".ct-add-key-modal__backdrop"):null,n=document.getElementById("ct_add_key_cancel"),s=document.getElementById("ct_add_key_confirm"),a=document.getElementById("ct_add_key_input");e&&(t&&t.addEventListener("click",()=>this.closeAddKeyModal()),n&&n.addEventListener("click",()=>this.closeAddKeyModal()),s&&s.addEventListener("click",()=>this.addTranslationKey()),a&&a.addEventListener("keydown",i=>{i.key==="Enter"&&this.addTranslationKey(),i.key==="Escape"&&this.closeAddKeyModal()}))}openAddKeyModal(){const e=document.getElementById("ct_add_key_modal"),t=document.getElementById("ct_add_key_input");e&&(e.style.display="flex",t&&(t.value="",t.focus()))}closeAddKeyModal(){const e=document.getElementById("ct_add_key_modal");e&&(e.style.display="none")}async addTranslationKey(){const e=document.getElementById("ct_add_key_input"),t=e?e.value:"";if(!t||!t.trim())return;const n=t.trim().toUpperCase().replace(/[^A-Z0-9_]/g,"_"),s=new FormData;s.append("action","admin_add_translation_key"),s.append("nonce",this.nonce),s.append("key",n),(await this.ajaxPostForm(s)).success&&(this.closeAddKeyModal(),await this.loadTranslationKeys(),this.selectKey(n))}async deleteCurrentKey(){if(!this.currentTransKey||!confirm(`Delete key "${this.currentTransKey}" from all languages?`))return;const e=new FormData;e.append("action","admin_delete_translation_key"),e.append("nonce",this.nonce),e.append("key",this.currentTransKey),(await this.ajaxPostForm(e)).success&&(this.currentTransKey="",document.getElementById("ct_trans_placeholder").style.display="block",document.getElementById("ct_trans_fields").style.display="none",await this.loadTranslationKeys())}updateToggleUI(){const e=document.getElementById("ct_trans_type_singular"),t=document.getElementById("ct_trans_type_plural");!e||!t||(this.currentKeyIsPlural?(e.classList.remove("ct-trans-type-toggle__btn--active"),t.classList.add("ct-trans-type-toggle__btn--active")):(e.classList.add("ct-trans-type-toggle__btn--active"),t.classList.remove("ct-trans-type-toggle__btn--active")))}toggleKeyType(e){const t=e==="plural";if(t===this.currentKeyIsPlural)return;this.currentKeyIsPlural=t,this.updateToggleUI();const n=document.getElementById("ct_trans_lang_fields");if(!n)return;const s=n.querySelectorAll(".ct-trans-editor__singular-wrap"),a=n.querySelectorAll(".ct-trans-editor__plural-wrap"),i=50;let o=0;for(const c of s){if(o>=i)break;o++,c.style.display=t?"none":"block"}o=0;for(const c of a){if(o>=i)break;o++,c.style.display=t?"block":"none"}this.detectPlaceholders()}async saveAllLanguagesForKey(e){const t=document.getElementById("ct_trans_lang_fields");if(!t)return;const n=t.querySelectorAll(".ct-trans-editor__lang-field"),s=50;let a=0;for(const i of n){if(a>=s)break;a++;const o=i.querySelector("input[data-singular]");if(!o)continue;const c=o.dataset.iso2;await this.saveTranslation(e,c)}}detectPlaceholders(){const e=document.getElementById("ct_trans_lang_fields");if(!e)return;const t=e.querySelectorAll('input[type="text"]'),n=new Set,s=/##([a-zA-Z0-9_]+)##/g,a=500;let i=0;for(const o of t){if(i>=a)break;i++,s.lastIndex=0;let c;for(;(c=s.exec(o.value))!==null;)n.add(c[1])}this.renderPlaceholderBadges(n)}renderPlaceholderBadges(e){const t=document.getElementById("ct_trans_placeholders"),n=document.getElementById("ct_trans_placeholder_list");if(!t||!n)return;if(e.size===0){t.style.display="none";return}t.style.display="flex",n.innerHTML="";const s=20;let a=0;for(const i of e){if(a>=s)break;a++;const o=document.createElement("span");o.className="ct-trans-placeholders__badge",o.textContent=`##${i}##`,n.appendChild(o)}}async exportTranslations(){const e=await this.ajaxPostSimple("admin_export_translations");if(e.success){const t=new Blob([JSON.stringify(e.data,null,2)],{type:"application/json"}),n=URL.createObjectURL(t),s=document.createElement("a");s.href=n,s.download="ct-translations-export.json",s.click(),URL.revokeObjectURL(n)}}async importTranslations(e){const t=e.target.files[0];if(!t)return;const n=await t.text(),s=await this.ajaxPost("admin_import_translations",n);s.success?(window.ctToast.show(s.data.message||"Translations imported.","success"),window.location.reload()):window.ctToast.show(s.data?.message||"Import failed.","error"),e.target.value=""}initPageTranslations(){const e=document.getElementById("ct_page_lang_filter");e&&(e.addEventListener("change",()=>this.loadPagesForLanguage(e.value)),e.value&&this.loadPagesForLanguage(e.value))}async loadPagesForLanguage(e){const t=document.getElementById("ct_page_list");if(!t)return;t.innerHTML='<p class="ct-page-trans__loading">Loading pages...</p>';const n=new FormData;n.append("action","admin_get_pages_by_language"),n.append("nonce",this.nonce),n.append("iso2",e);const s=await this.ajaxPostForm(n);if(!s.success){t.innerHTML="<p>Error loading pages.</p>";return}const a=s.data.pages||[];if(t.innerHTML="",a.length===0){t.innerHTML="<p>No pages found for this language.</p>";return}const i=200;let o=0;for(const c of a){if(o>=i)break;o++;const l=document.createElement("div");l.className="ct-page-trans__card";const r=document.createElement("div");r.className="ct-page-trans__card-header";const d=document.createElement("strong");d.className="ct-page-trans__card-title",d.textContent=c.title;const m=document.createElement("span");m.className="ct-page-trans__card-status ct-page-trans__card-status--"+this.escapeAttr(c.status),m.textContent=c.status;const u=document.createElement("span");u.className="ct-page-trans__card-slug",u.textContent="/"+(c.slug||"")+"/";const g=document.createElement("span");g.className="ct-page-trans__card-actions";const p=document.createElement("button");if(p.type="button",p.className="button button-small ct-page-trans__quick-edit-btn",p.textContent="Quick Edit",g.appendChild(p),c.edit_url){const w=document.createElement("a");w.href=c.edit_url,w.className="button button-small",w.target="_blank",w.textContent="Edit in WP",w.addEventListener("click",C=>C.stopPropagation()),g.appendChild(w)}r.appendChild(d),r.appendChild(m),r.appendChild(u),r.appendChild(g);const _=document.createElement("div");_.className="ct-page-trans__quick-edit",_.style.display="none";const v=document.createElement("div");v.className="ct-page-trans__quick-edit-group";const B=document.createElement("label");B.textContent="Title:";const y=document.createElement("input");y.type="text",y.className="ct-page-trans__title",y.value=c.title,v.appendChild(B),v.appendChild(y);const L=document.createElement("div");L.className="ct-page-trans__quick-edit-group";const E=document.createElement("label");E.textContent="Slug:";const h=document.createElement("input");h.type="text",h.className="ct-page-trans__slug",h.value=c.slug||"",L.appendChild(E),L.appendChild(h);const f=document.createElement("div");f.className="ct-page-trans__quick-edit-group";const F=document.createElement("label");F.textContent="Parent:";const x=document.createElement("select");x.className="ct-page-trans__parent";const N=document.createElement("option");N.value="0",N.textContent="(no parent)",x.appendChild(N);const T=200;let I=0;for(const w of a){if(I>=T)break;if(w.id===c.id)continue;I++;const C=document.createElement("option");C.value=w.id,C.textContent=w.title,w.id===c.parent_id&&(C.selected=!0),x.appendChild(C)}f.appendChild(F),f.appendChild(x);const S=document.createElement("div");S.className="ct-page-trans__quick-edit-buttons";const b=document.createElement("button");b.type="button",b.className="button button-primary button-small ct-page-trans__save",b.textContent="Save";const A=document.createElement("button");A.type="button",A.className="button button-small ct-page-trans__cancel",A.textContent="Cancel",S.appendChild(b),S.appendChild(A),_.appendChild(v),_.appendChild(L),_.appendChild(f),_.appendChild(S),l.appendChild(r),l.appendChild(_),p.addEventListener("click",w=>{w.stopPropagation();const C=_.style.display!=="none";_.style.display=C?"none":"flex",p.textContent=C?"Quick Edit":"Close"}),A.addEventListener("click",()=>{y.value=d.textContent,h.value=u.textContent.replace(/^\/|\/$/g,""),x.value=String(c.parent_id||0),_.style.display="none",p.textContent="Quick Edit"}),b.addEventListener("click",async()=>{b.disabled=!0,b.textContent="Saving...";const w=await this.ajaxPost("admin_save_page_translation",JSON.stringify({post_id:c.id,title:y.value,slug:h.value,parent_id:parseInt(x.value,10)||0}));if(b.disabled=!1,b.textContent="Save",w.success){const C=w.data.title||y.value,M=w.data.slug||h.value;d.textContent=C,u.textContent="/"+M+"/",y.value=C,h.value=M,w.data.parent_id!==void 0&&(c.parent_id=w.data.parent_id,x.value=String(w.data.parent_id)),_.style.display="none",p.textContent="Quick Edit"}}),t.appendChild(l)}}async ajaxPost(e,t){const n=new FormData;return n.append("action",e),n.append("nonce",this.nonce),n.append("input",t),this.ajaxPostForm(n)}async ajaxPostSimple(e){const t=new FormData;return t.append("action",e),t.append("nonce",this.nonce),this.ajaxPostForm(t)}async ajaxPostForm(e){try{return await(await fetch(this.ajaxUrl,{method:"POST",body:e})).json()}catch(t){return{success:!1,data:{message:t.message}}}}escapeHtml(e){const t=document.createElement("div");return t.textContent=e||"",t.innerHTML}escapeAttr(e){return(e||"").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}}class k{static MAX_TOASTS=5;static DURATION_MS=4e3;static ICONS={success:`<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="10" cy="10" r="10" fill="currentColor" opacity="0.15"/>
            <path d="M6 10.5L8.5 13L14 7.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>`,warning:`<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M10 2L1 18H19L10 2Z" fill="currentColor" opacity="0.15" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>
            <path d="M10 8V12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <circle cx="10" cy="15" r="1" fill="currentColor"/>
        </svg>`,error:`<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="10" cy="10" r="10" fill="currentColor" opacity="0.15"/>
            <path d="M7 7L13 13M13 7L7 13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>`};constructor(){this.container=null,this.toasts=[],this.ensureContainer()}ensureContainer(){this.container||(this.container=document.createElement("div"),this.container.className="ct-toast-container",this.container.setAttribute("aria-live","polite"),this.container.setAttribute("role","status"),document.body.appendChild(this.container))}show(e,t){R(typeof e=="string","Toast message must be a string"),R(["success","warning","error"].includes(t),"Toast type must be success, warning, or error"),this.ensureContainer(),this.toasts.length>=k.MAX_TOASTS&&this.dismiss(this.toasts[0]);const n=document.createElement("div");n.className=`ct-toast ct-toast--${t}`;const s=document.createElement("span");s.className="ct-toast__icon",s.innerHTML=k.ICONS[t]||k.ICONS.error;const a=document.createElement("span");a.className="ct-toast__message",a.textContent=e;const i=document.createElement("button");i.className="ct-toast__close",i.type="button",i.setAttribute("aria-label","Close notification"),i.innerHTML=`<svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 3L11 11M11 3L3 11" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>`,i.addEventListener("click",()=>this.dismiss(n));const o=document.createElement("div");o.className="ct-toast__progress";const c=document.createElement("div");c.className="ct-toast__progress-bar",o.appendChild(c),n.appendChild(s),n.appendChild(a),n.appendChild(i),n.appendChild(o),this.container.appendChild(n),this.toasts.push(n),requestAnimationFrame(()=>{n.classList.add("ct-toast--visible"),c.style.transition=`width ${k.DURATION_MS}ms linear`,c.style.width="0%"}),n._dismissTimer=setTimeout(()=>{this.dismiss(n)},k.DURATION_MS)}dismiss(e){if(!e||!e.parentNode)return;e._dismissTimer&&(clearTimeout(e._dismissTimer),e._dismissTimer=null),e.classList.remove("ct-toast--visible"),e.classList.add("ct-toast--exiting");const t=this.toasts.indexOf(e);t!==-1&&this.toasts.splice(t,1),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300)}}function R(P,e){P||console.warn("[Toast assert]",e)}class J{constructor(){window.ctToast=new k,this.admin=new U,this.languages=new H}}document.addEventListener("DOMContentLoaded",()=>{new J});
