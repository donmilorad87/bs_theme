/* empty css          */const R=100,D=100;class O{constructor(e){this._parent=e,this._pointerEditIndex=null,this._currentPage=1}initContact(){const e=document.querySelector(".ct-contact-admin");e&&(this._section=e,this._restUrl=e.getAttribute("data-rest-url")||"",this._syncSettingsFlags(),this._initSubTabs(),this._bindFilters(),this._initFormBuilder(),this.loadUnreadCount(),this.loadMessages(1),this._section.addEventListener("ct-contact-settings-updated",()=>{this._syncSettingsFlags(),this.loadMessages(this._currentPage||1)}))}_initSubTabs(){const e=this._section.querySelectorAll(".ct-contact-tabs__btn"),t=5;let s=0;e.forEach(n=>{s>=t||(s++,n.addEventListener("click",()=>{const a=n.getAttribute("data-tab");this._switchTab(a,e)}))})}_switchTab(e,t){let n=0;t.forEach(c=>{n>=5||(n++,c.classList.toggle("ct-contact-tabs__btn--active",c.getAttribute("data-tab")===e))});const a=document.getElementById("bs_contact_messages_panel"),o=document.getElementById("bs_contact_config_panel");a&&(a.style.display=e==="messages"?"":"none"),o&&(o.style.display=e==="config"?"":"none")}_bindFilters(){const e=document.getElementById("bs_contact_form_filter"),t=document.getElementById("bs_contact_status_filter");e&&e.addEventListener("change",()=>{this._currentPage=1,this.loadMessages(1)}),t&&t.addEventListener("change",()=>{this._currentPage=1,this.loadMessages(1)})}async loadMessages(e){const t=document.getElementById("bs_contact_messages_list");if(!t)return;this._syncSettingsFlags();const s=document.getElementById("bs_contact_form_filter"),n=document.getElementById("bs_contact_status_filter"),a=s?s.value:"",o=n?n.value:"all",c=new URLSearchParams({page:e,status:o});a!==""?c.set("form_id",a):c.set("form_id","0");try{const l=await(await fetch(this._restUrl+"/contact/messages?"+c.toString(),{method:"GET",headers:{"X-WP-Nonce":this._getRestNonce()},credentials:"same-origin"})).json();l.success&&l.data?(this._currentPage=l.data.current_page,this.renderMessagesList(l.data.messages,t),this._renderPagination(l.data),this.updateBadge(l.data.unread_count)):t.innerHTML='<p class="ct-admin-no-items">Error loading messages.</p>'}catch{t.innerHTML='<p class="ct-admin-no-items">Network error.</p>'}}renderMessagesList(e,t){if(!t)return;if(!e||e.length===0){t.innerHTML='<p class="ct-admin-no-items">No messages found.</p>';return}let s="";const n=Math.min(e.length,R);for(let a=0;a<n;a++){const o=e[a],c=o.is_read?"ct-contact-card--read":"ct-contact-card--unread",i=new Date(o.date).toLocaleString(),l=o.user_id>0,r=this._userManagementEnabled&&l,d=this._emailEnabled&&!l&&o.sender_email,u=r||d;if(s+='<div class="ct-contact-card '+c+'" data-id="'+o.id+'">',s+='<div class="ct-contact-card__header">',s+="<strong>"+this._parent.escapeHtml(o.sender_name)+"</strong>",s+='<span class="ct-contact-card__email">'+this._parent.escapeHtml(o.sender_email)+"</span>",o.sender_phone&&(s+='<span class="ct-contact-card__phone">'+this._parent.escapeHtml(o.sender_phone)+"</span>"),s+='<span class="ct-contact-card__date">'+this._parent.escapeHtml(i)+"</span>",s+='<span class="ct-contact-card__pointer">'+this._parent.escapeHtml(o.form_label||o.pointer)+"</span>",s+="</div>",s+='<div class="ct-contact-card__body"><p>'+this._parent.escapeHtml(o.body)+"</p></div>",o.attachments&&o.attachments.length>0){s+='<div class="ct-contact-card__attachments">',s+="<strong>Attachments:</strong>",s+='<ul class="ct-contact-card__attachments-list">';const m=Math.min(o.attachments.length,10);for(let _=0;_<m;_++){const p=o.attachments[_];if(p&&p.url){const g=p.name||p.url;this._isImageAttachment(p)?(s+='<li class="ct-contact-card__attachment ct-contact-card__attachment--image">',s+='<a class="ct-contact-card__attachment-link" href="'+this._escapeAttr(p.url)+'" target="_blank" rel="noopener">',s+='<img class="ct-contact-card__attachment-img" src="'+this._escapeAttr(p.url)+'" alt="'+this._escapeAttr(g)+'">',s+="</a>",s+='<span class="ct-contact-card__attachment-name">'+this._parent.escapeHtml(g)+"</span>",s+="</li>"):(s+='<li class="ct-contact-card__attachment">',s+='<a class="ct-contact-card__attachment-link" href="'+this._escapeAttr(p.url)+'" target="_blank" rel="noopener">'+this._parent.escapeHtml(g)+"</a>",s+="</li>")}}s+="</ul></div>"}if(o.replies&&o.replies.length>0){s+='<div class="ct-contact-card__replies">';const m=Math.min(o.replies.length,D);for(let _=0;_<m;_++){const p=o.replies[_],g=new Date(p.date).toLocaleString();s+='<div class="ct-contact-card__reply">',s+="<strong>"+this._parent.escapeHtml(p.author_name)+"</strong>",s+='<span class="ct-contact-card__reply-date">'+this._parent.escapeHtml(g)+"</span>",s+="<p>"+this._parent.escapeHtml(p.body)+"</p>",s+="</div>"}s+="</div>"}s+='<div class="ct-contact-card__actions">',s+='<button type="button" class="button ct-contact-toggle-read" data-id="'+o.id+'" data-read="'+(o.is_read?"1":"0")+'">',s+=o.is_read?"Mark Unread":"Mark Read",s+="</button>",u&&(s+='<button type="button" class="button ct-contact-reply-btn" data-id="'+o.id+'">Reply</button>'),s+='<button type="button" class="button ct-contact-delete-btn" data-id="'+o.id+'">Delete</button>',s+="</div>",u&&(s+='<div class="ct-contact-card__reply-form" id="bs_reply_form_'+o.id+'" style="display:none;">',s+='<textarea class="ct-admin-input ct-contact-reply-text" rows="3" placeholder="Type your reply..."></textarea>',s+='<button type="button" class="button button-primary ct-contact-send-reply" data-id="'+o.id+'">Send Reply</button>',s+="</div>"),s+="</div>"}t.innerHTML=s,this._bindMessageActions()}_bindMessageActions(){let t=0;this._section.querySelectorAll(".ct-contact-toggle-read").forEach(c=>{t>=200||(t++,c.addEventListener("click",()=>{const i=parseInt(c.getAttribute("data-id"),10),l=c.getAttribute("data-read")==="1";this.markRead(i,!l)}))}),t=0,this._section.querySelectorAll(".ct-contact-delete-btn").forEach(c=>{t>=200||(t++,c.addEventListener("click",()=>{const i=parseInt(c.getAttribute("data-id"),10);this.deleteMessage(i)}))}),t=0,this._section.querySelectorAll(".ct-contact-reply-btn").forEach(c=>{t>=200||(t++,c.addEventListener("click",()=>{const i=parseInt(c.getAttribute("data-id"),10);this.showReplyForm(i)}))}),t=0,this._section.querySelectorAll(".ct-contact-send-reply").forEach(c=>{t>=200||(t++,c.addEventListener("click",()=>{const i=parseInt(c.getAttribute("data-id"),10),l=document.getElementById("bs_reply_form_"+i),r=l?l.querySelector(".ct-contact-reply-text"):null;r&&this.replyToMessage(i,r.value.trim())}))})}async markRead(e,t){try{const n=await(await fetch(this._restUrl+"/contact/mark-read",{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":this._getRestNonce()},credentials:"same-origin",body:JSON.stringify({message_id:e,is_read:t})})).json();n.success?(this._parent.showNotice(n.message,"success"),this.loadMessages(this._currentPage)):this._parent.showNotice(n.message||"Error.","error")}catch{this._parent.showNotice("Network error.","error")}}async deleteMessage(e){try{const s=await(await fetch(this._restUrl+"/contact/delete",{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":this._getRestNonce()},credentials:"same-origin",body:JSON.stringify({message_id:e})})).json();s.success?(this._parent.showNotice(s.message,"success"),this.loadMessages(this._currentPage)):this._parent.showNotice(s.message||"Error.","error")}catch{this._parent.showNotice("Network error.","error")}}showReplyForm(e){const t=document.getElementById("bs_reply_form_"+e);t&&(t.style.display=t.style.display==="none"?"":"none")}async replyToMessage(e,t){if(!t){this._parent.showNotice("Reply cannot be empty.","error");return}try{const n=await(await fetch(this._restUrl+"/contact/reply",{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":this._getRestNonce()},credentials:"same-origin",body:JSON.stringify({message_id:e,reply_body:t})})).json();n.success?(this._parent.showNotice(n.message,"success"),this.loadMessages(this._currentPage)):this._parent.showNotice(n.message||"Error.","error")}catch{this._parent.showNotice("Network error.","error")}}_renderPagination(e){const t=document.getElementById("bs_contact_pagination");if(!t)return;if(e.total_pages<=1){t.innerHTML="";return}let s="";const n=Math.min(e.total_pages,50);for(let c=1;c<=n;c++){const i=c===e.current_page?" ct-contact-pagination__btn--active":"";s+='<button type="button" class="button ct-contact-pagination__btn'+i+'" data-page="'+c+'">'+c+"</button>"}t.innerHTML=s;const a=t.querySelectorAll(".ct-contact-pagination__btn");let o=0;a.forEach(c=>{o>=n||(o++,c.addEventListener("click",()=>{const i=parseInt(c.getAttribute("data-page"),10);this.loadMessages(i)}))})}async loadUnreadCount(){const e=document.querySelector("#admin_get_contact_messages_count_nonce");if(!e)return;const t=new URLSearchParams({nonce:e.value,action:"admin_get_contact_messages_count"});try{const n=await(await fetch(ajaxurl,{method:"POST",body:t})).json();n.success&&n.data&&this.updateBadge(n.data.count)}catch{}}updateBadge(e){const t=document.getElementById("bs_unread_badge");t&&(e>0?(t.textContent=e,t.style.display=""):t.style.display="none")}_initFormBuilder(){const e=document.getElementById("bs_contact_form_builder");e&&(this._builder=e,this._formListEl=e.querySelector("#bs_contact_form_list"),this._formEditor=e.querySelector("#bs_contact_form_editor"),this._editorWrap=e.querySelector("#bs_contact_form_editor_wrap"),this._fieldsListEl=e.querySelector("#bs_contact_fields_list"),this._currentFormId=null,this._currentFields=[],this._isNewForm=!0,this._bindFormBuilderActions(),this._loadInitialForms())}_bindFormBuilderActions(){const e=document.getElementById("bs_contact_form_add");e&&e.addEventListener("click",i=>{i.preventDefault(),this._resetFormEditor(!0)});const t=document.getElementById("bs_contact_form_save");t&&t.addEventListener("click",i=>{i.preventDefault(),this._saveForm()});const s=document.getElementById("bs_contact_form_delete");s&&s.addEventListener("click",i=>{i.preventDefault(),this._deleteForm()});const n=document.getElementById("bs_contact_form_cancel");n&&n.addEventListener("click",i=>{i.preventDefault(),this._cancelFormEdit()});const a=document.getElementById("bs_contact_field_add");a&&a.addEventListener("click",i=>{i.preventDefault(),this._addField()});const o=document.getElementById("bs_contact_form_uploads"),c=document.getElementById("bs_contact_form_upload_storage");o&&o.addEventListener("change",()=>this._updateUploadSettingsUI()),c&&c.addEventListener("change",()=>this._updateUploadSettingsUI())}_loadInitialForms(){let e=[];try{e=JSON.parse(this._builder.getAttribute("data-forms")||"[]")}catch{e=[]}Array.isArray(e)||(e=[]),this._forms=e,this._renderFormList(),this._hideEditor()}_renderFormList(){if(!this._formListEl)return;if(!this._forms||this._forms.length===0){this._formListEl.innerHTML='<p class="ct-admin-no-items">No forms created yet.</p>';return}let e='<ul class="ct-admin-form-list">';const t=Math.min(this._forms.length,50);for(let n=0;n<t;n++){const a=this._forms[n],o=this._currentFormId===a.id;e+='<li class="ct-admin-form-item'+(o?" is-active":"")+'" data-id="'+a.id+'"><div class="ct-admin-form-item__title">'+this._parent.escapeHtml(a.title||"Untitled Form")+'</div><div class="ct-admin-form-item__meta">[bs_contact_form id="'+a.id+'"]</div><button type="button" class="button ct-admin-form-edit" data-id="'+a.id+'">Edit</button></li>'}e+="</ul>",this._formListEl.innerHTML=e,this._formListEl.querySelectorAll(".ct-admin-form-edit").forEach(n=>{n.addEventListener("click",()=>{const a=parseInt(n.getAttribute("data-id"),10);isNaN(a)||this._loadForm(a)})}),this._renderFormFilterOptions()}_renderFormFilterOptions(){const e=document.getElementById("bs_contact_form_filter");if(!e)return;const t=e.value;if(e.innerHTML='<option value="">All Forms</option>',Array.isArray(this._forms))for(let s=0;s<this._forms.length&&s<50;s++){const n=this._forms[s],a=document.createElement("option");a.value=String(n.id),a.textContent=n.title||"Untitled Form",String(n.id)===t&&(a.selected=!0),e.appendChild(a)}}async _loadForm(e){const t=document.querySelector('#bs_contact_form_editor input[name="admin_save_contact_form_nonce"]');if(!t)return;const s=new URLSearchParams({action:"admin_get_contact_form",nonce:t.value,form_id:String(e)});try{const a=await(await fetch(ajaxurl,{method:"POST",body:s})).json();if(!a.success||!a.data){this._parent.showNotice("Unable to load form.","error");return}this._applyFormData(a.data),this._showEditor()}catch{this._parent.showNotice("Network error loading form.","error")}}_applyFormData(e){this._currentFormId=e.id||null,this._isNewForm=!e.id;const t=document.getElementById("bs_contact_form_title"),s=document.getElementById("bs_contact_form_id"),n=document.getElementById("bs_contact_form_shortcode"),a=document.getElementById("bs_contact_form_emails"),o=document.getElementById("bs_contact_form_logged_in"),c=document.getElementById("bs_contact_form_captcha"),i=document.getElementById("bs_contact_form_uploads"),l=document.getElementById("bs_contact_form_upload_storage"),r=document.getElementById("bs_contact_form_s3_bucket"),d=document.getElementById("bs_contact_form_s3_key"),u=document.getElementById("bs_contact_form_s3_secret");t&&(t.value=e.title||""),s&&(s.value=e.id?String(e.id):""),n&&(n.value=e.id?'[bs_contact_form id="'+e.id+'"]':"");const m=e.settings||{};a&&(a.value=Array.isArray(m.emails)?m.emails.join(", "):"",this._emailEnabled?(a.disabled=!1,a.closest(".ct-admin-field")?.classList.remove("ct-admin-field--disabled")):(a.value="",a.disabled=!0,a.closest(".ct-admin-field")?.classList.add("ct-admin-field--disabled"))),o&&(o.checked=!!m.logged_in_only),c&&(c.checked=!!m.captcha_enabled),i&&(i.checked=!!(m.file_uploads&&m.file_uploads.enabled)),l&&(l.value=m.file_uploads&&m.file_uploads.storage?m.file_uploads.storage:"wordpress"),r&&(r.value=m.file_uploads&&m.file_uploads.s3&&m.file_uploads.s3.bucket||""),d&&(d.value=m.file_uploads&&m.file_uploads.s3&&m.file_uploads.s3.access_key||""),u&&(u.value=m.file_uploads&&m.file_uploads.s3&&m.file_uploads.s3.secret_key||""),this._updateUploadSettingsUI(),this._currentFields=Array.isArray(e.fields)?e.fields:[],this._renderFields(),this._renderFormList(),this._updateFormActionButtons()}_updateUploadSettingsUI(){const e=document.getElementById("bs_contact_form_uploads"),t=document.getElementById("bs_contact_form_upload_storage"),s=document.getElementById("bs_contact_form_s3_bucket"),n=document.getElementById("bs_contact_form_s3_key"),a=document.getElementById("bs_contact_form_s3_secret"),o=e?e.checked:!1,c=t?t.value==="s3":!1;t&&(t.closest(".ct-admin-field")?.classList.toggle("ct-admin-field--disabled",!o),t.disabled=!o),[s,n,a].forEach(l=>{if(!l)return;const r=o&&c,d=l.closest(".ct-admin-field");d&&(d.style.display=r?"":"none")})}_resetFormEditor(e=!1){this._currentFormId=null,this._currentFields=[],this._isNewForm=!0,this._applyFormData({id:null,title:"",settings:{emails:[],logged_in_only:!1,captcha_enabled:!1,file_uploads:{enabled:!1,storage:"wordpress",s3:{bucket:"",access_key:"",secret_key:""}}},fields:[]}),e?this._showEditor():this._hideEditor()}_addField(){this._currentFields.push(this._getDefaultField()),this._renderFields()}_getDefaultField(){return{id:"field_"+Math.random().toString(36).slice(2,8),type:"text",label:"New Field",name:"field_"+(this._currentFields.length+1),placeholder:"",required:!1,options:[],conditions:{enabled:!1,relation:"all",rules:[]},min:"",max:"",step:"",default:"",accept:""}}_renderFields(){if(!this._fieldsListEl)return;if(!this._currentFields||this._currentFields.length===0){this._fieldsListEl.innerHTML='<p class="ct-admin-no-items">No fields added yet.</p>';return}const e=this._getFieldOptionsList();let t="";const s=Math.min(this._currentFields.length,200);for(let n=0;n<s;n++){const a=this._currentFields[n],o=Array.isArray(a.options)?a.options.map(l=>l.value?l.value+"|"+l.label:l.label).join("\\n"):"",c=a.conditions||{enabled:!1,relation:"all",rules:[]},i=Array.isArray(c.rules)?c.rules:[];t+='<div class="ct-form-field" data-index="'+n+'"><div class="ct-form-field__row"><input type="text" class="ct-field-label" placeholder="Label" value="'+this._escapeAttr(a.label||"")+'"><input type="text" class="ct-field-name" placeholder="name" value="'+this._escapeAttr(a.name||"")+'"><select class="ct-field-type">'+this._renderFieldTypeOptions(a.type)+'</select><label class="ct-field-required"><input type="checkbox"'+(a.required?" checked":"")+'> Required</label></div><div class="ct-form-field__row"><input type="text" class="ct-field-placeholder" placeholder="Placeholder" value="'+this._escapeAttr(a.placeholder||"")+'"><input type="text" class="ct-field-default" placeholder="Default" value="'+this._escapeAttr(a.default||"")+'"></div><div class="ct-form-field__row ct-field-options"'+(this._typeNeedsOptions(a.type)?"":' style="display:none;"')+'><textarea class="ct-field-options-input" placeholder="value|Label per line">'+this._parent.escapeHtml(o)+'</textarea></div><div class="ct-form-field__row ct-field-range"'+(this._typeNeedsRange(a.type)?"":' style="display:none;"')+'><input type="number" class="ct-field-min" placeholder="Min" value="'+this._escapeAttr(a.min||"")+'"><input type="number" class="ct-field-max" placeholder="Max" value="'+this._escapeAttr(a.max||"")+'"><input type="number" class="ct-field-step" placeholder="Step" value="'+this._escapeAttr(a.step||"")+'"></div><div class="ct-form-field__row ct-field-accept"'+(a.type==="file"?"":' style="display:none;"')+'><input type="text" class="ct-field-accept-input" placeholder="Allowed types (comma separated)" value="'+this._escapeAttr(a.accept||"")+'"></div><div class="ct-form-field__conditions"><label><input type="checkbox" class="ct-field-conditions-enabled"'+(c.enabled?" checked":"")+'> Conditional logic</label><select class="ct-field-conditions-relation"><option value="all"'+(c.relation==="all"?" selected":"")+'>All rules</option><option value="any"'+(c.relation==="any"?" selected":"")+'>Any rule</option></select><div class="ct-field-conditions-list">'+this._renderConditionRows(i,e)+'</div><button type="button" class="button ct-field-add-rule">Add Rule</button></div><div class="ct-form-field__actions"><button type="button" class="button ct-field-move-up">↑</button><button type="button" class="button ct-field-move-down">↓</button><button type="button" class="button ct-field-remove">Remove</button></div></div>'}this._fieldsListEl.innerHTML=t,this._bindFieldEvents()}_renderFieldTypeOptions(e){const t=[{value:"text",label:"Text"},{value:"email",label:"Email"},{value:"tel",label:"Phone"},{value:"url",label:"URL"},{value:"number",label:"Number"},{value:"textarea",label:"Textarea"},{value:"select",label:"Select"},{value:"radio",label:"Radio"},{value:"checkbox",label:"Checkbox"},{value:"checkbox_group",label:"Checkbox Group"},{value:"range",label:"Range"},{value:"date",label:"Date"},{value:"file",label:"File Upload"},{value:"hidden",label:"Hidden"}];let s="";for(let n=0;n<t.length;n++){const a=t[n];s+='<option value="'+a.value+'"'+(a.value===e?" selected":"")+">"+a.label+"</option>"}return s}_typeNeedsOptions(e){return e==="select"||e==="radio"||e==="checkbox_group"}_typeNeedsRange(e){return e==="number"||e==="range"}_getFieldOptionsList(){const e=[];for(let t=0;t<this._currentFields.length;t++){const s=this._currentFields[t];!s||!s.name||e.push({value:s.name,label:s.label||s.name})}return e}_renderConditionRows(e,t){if(!e||e.length===0)return"";let s="";for(let n=0;n<e.length;n++){const a=e[n]||{};s+='<div class="ct-field-condition" data-rule-index="'+n+'"><select class="ct-field-condition-field">'+this._renderConditionFieldOptions(t,a.field)+'</select><select class="ct-field-condition-operator">'+this._renderConditionOperatorOptions(a.operator)+'</select><input type="text" class="ct-field-condition-value" value="'+this._escapeAttr(a.value||"")+'"><button type="button" class="button ct-field-remove-rule">Remove</button></div>'}return s}_renderConditionFieldOptions(e,t){let s='<option value="">Select field</option>';for(let n=0;n<e.length;n++){const a=e[n];s+='<option value="'+this._escapeAttr(a.value)+'"'+(a.value===t?" selected":"")+">"+this._parent.escapeHtml(a.label)+"</option>"}return s}_renderConditionOperatorOptions(e){const t=[{value:"equals",label:"Equals"},{value:"not_equals",label:"Not equals"},{value:"contains",label:"Contains"},{value:"greater",label:"Greater than"},{value:"less",label:"Less than"},{value:"checked",label:"Is checked"},{value:"not_checked",label:"Is not checked"}];let s="";for(let n=0;n<t.length;n++){const a=t[n];s+='<option value="'+a.value+'"'+(a.value===e?" selected":"")+">"+a.label+"</option>"}return s}_bindFieldEvents(){this._fieldsListEl.querySelectorAll(".ct-form-field").forEach(t=>{const s=parseInt(t.getAttribute("data-index"),10);if(isNaN(s)||!this._currentFields[s])return;const n=this._currentFields[s],a=t.querySelector(".ct-field-label"),o=t.querySelector(".ct-field-name"),c=t.querySelector(".ct-field-type"),i=t.querySelector(".ct-field-required input"),l=t.querySelector(".ct-field-placeholder"),r=t.querySelector(".ct-field-default"),d=t.querySelector(".ct-field-options-input"),u=t.querySelector(".ct-field-min"),m=t.querySelector(".ct-field-max"),_=t.querySelector(".ct-field-step"),p=t.querySelector(".ct-field-accept-input"),g=t.querySelector(".ct-field-conditions-enabled"),b=t.querySelector(".ct-field-conditions-relation"),y=t.querySelector(".ct-field-add-rule");a&&a.addEventListener("input",()=>{n.label=a.value,this._renderFormList()}),o&&o.addEventListener("input",()=>{n.name=o.value}),c&&c.addEventListener("change",()=>{n.type=c.value,this._renderFields()}),i&&i.addEventListener("change",()=>{n.required=i.checked}),l&&l.addEventListener("input",()=>{n.placeholder=l.value}),r&&r.addEventListener("input",()=>{n.default=r.value}),d&&d.addEventListener("input",()=>{n.options=this._parseOptions(d.value)}),u&&u.addEventListener("input",()=>{n.min=u.value}),m&&m.addEventListener("input",()=>{n.max=m.value}),_&&_.addEventListener("input",()=>{n.step=_.value}),p&&p.addEventListener("input",()=>{n.accept=p.value}),n.conditions||(n.conditions={enabled:!1,relation:"all",rules:[]}),g&&g.addEventListener("change",()=>{n.conditions.enabled=g.checked}),b&&b.addEventListener("change",()=>{n.conditions.relation=b.value}),y&&y.addEventListener("click",h=>{h.preventDefault(),n.conditions.rules.push({field:"",operator:"equals",value:""}),this._renderFields()}),t.querySelectorAll(".ct-field-condition").forEach(h=>{const B=parseInt(h.getAttribute("data-rule-index"),10),S=n.conditions.rules[B];if(!S)return;const F=h.querySelector(".ct-field-condition-field"),T=h.querySelector(".ct-field-condition-operator"),I=h.querySelector(".ct-field-condition-value"),L=h.querySelector(".ct-field-remove-rule");F&&F.addEventListener("change",()=>{S.field=F.value}),T&&T.addEventListener("change",()=>{S.operator=T.value}),I&&I.addEventListener("input",()=>{S.value=I.value}),L&&L.addEventListener("click",E=>{E.preventDefault(),n.conditions.rules.splice(B,1),this._renderFields()})});const w=t.querySelector(".ct-field-move-up"),x=t.querySelector(".ct-field-move-down"),f=t.querySelector(".ct-field-remove");w&&w.addEventListener("click",h=>{if(h.preventDefault(),s>0){const B=this._currentFields[s-1];this._currentFields[s-1]=this._currentFields[s],this._currentFields[s]=B,this._renderFields()}}),x&&x.addEventListener("click",h=>{if(h.preventDefault(),s<this._currentFields.length-1){const B=this._currentFields[s+1];this._currentFields[s+1]=this._currentFields[s],this._currentFields[s]=B,this._renderFields()}}),f&&f.addEventListener("click",h=>{h.preventDefault(),this._currentFields.splice(s,1),this._renderFields()})})}_parseOptions(e){const t=e.split("\\n"),s=[];for(let n=0;n<t.length;n++){const a=t[n].trim();if(a)if(a.includes("|")){const o=a.split("|"),c=o[0].trim(),i=o.slice(1).join("|").trim()||c;s.push({value:c,label:i})}else s.push({value:a,label:a})}return s}async _saveForm(){const e=document.querySelector('#bs_contact_form_editor input[name="admin_save_contact_form_nonce"]');if(!e)return;const t=document.getElementById("bs_contact_form_title"),s=document.getElementById("bs_contact_form_id"),n=document.getElementById("bs_contact_form_emails"),a=document.getElementById("bs_contact_form_logged_in"),o=document.getElementById("bs_contact_form_captcha"),c=document.getElementById("bs_contact_form_uploads"),i=document.getElementById("bs_contact_form_upload_storage"),l=document.getElementById("bs_contact_form_s3_bucket"),r=document.getElementById("bs_contact_form_s3_key"),d=document.getElementById("bs_contact_form_s3_secret"),u={id:s&&s.value?parseInt(s.value,10):0,title:t?t.value.trim():"",settings:{emails:n?n.value.split(",").map(_=>_.trim()).filter(_=>_.length>0):[],logged_in_only:a?!!a.checked:!1,captcha_enabled:o?!!o.checked:!1,file_uploads:{enabled:c?!!c.checked:!1,storage:i?i.value:"wordpress",s3:{bucket:l?l.value.trim():"",access_key:r?r.value.trim():"",secret_key:d?d.value.trim():""}}},fields:this._currentFields},m=new URLSearchParams({action:"admin_save_contact_form",nonce:e.value,input:JSON.stringify(u)});try{const p=await(await fetch(ajaxurl,{method:"POST",body:m})).json();p.success&&p.data?(this._parent.showNotice(p.data.message||"Form saved.","success"),p.data.forms&&(this._forms=p.data.forms),p.data.form&&this._applyFormData(p.data.form),this._hideEditor()):this._parent.showNotice(p.data&&p.data.message?p.data.message:"Error saving form.","error")}catch{this._parent.showNotice("Network error.","error")}}async _deleteForm(){const e=document.getElementById("bs_contact_form_id"),t=document.querySelector('#bs_contact_form_editor input[name="admin_save_contact_form_nonce"]');if(!e||!e.value||!t)return;const s=new URLSearchParams({action:"admin_delete_contact_form",nonce:t.value,form_id:e.value});try{const a=await(await fetch(ajaxurl,{method:"POST",body:s})).json();a.success&&a.data?(this._parent.showNotice(a.data.message||"Form deleted.","success"),this._forms=a.data.forms||[],this._resetFormEditor(!1),this._renderFormList()):this._parent.showNotice(a.data&&a.data.message?a.data.message:"Error deleting form.","error")}catch{this._parent.showNotice("Network error.","error")}}_cancelFormEdit(){this._resetFormEditor(!1)}_showEditor(){this._editorWrap&&this._editorWrap.classList.remove("is-hidden"),this._hideList()}_hideEditor(){this._editorWrap&&this._editorWrap.classList.add("is-hidden"),this._showList()}_showList(){const e=this._builder?this._builder.querySelector(".ct-admin-form-builder__list"):null;e&&(e.style.display="")}_hideList(){const e=this._builder?this._builder.querySelector(".ct-admin-form-builder__list"):null;e&&(e.style.display="none")}_updateFormActionButtons(){const e=document.getElementById("bs_contact_form_delete"),t=document.getElementById("bs_contact_form_cancel"),s=document.getElementById("bs_contact_form_shortcode_field");!e||!t||(this._isNewForm?(e.style.display="none",t.style.display="",t.textContent="Cancel Add",s&&(s.style.display="none")):(e.style.display="",t.style.display="none",s&&(s.style.display="")))}_escapeAttr(e){return e===null||typeof e>"u"?"":String(e).replace(/&/g,"&amp;").replace(/\"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}_syncSettingsFlags(){this._section&&(this._userManagementEnabled=this._section.getAttribute("data-user-management-enabled")!=="0",this._emailEnabled=this._section.getAttribute("data-email-enabled")!=="0")}_isImageAttachment(e){if(!e)return!1;if((e.type||"").toLowerCase().indexOf("image/")===0)return!0;const s=(e.url||"").toLowerCase().split("?")[0];return/\.(png|jpe?g|gif|webp|bmp|svg)$/.test(s)}_getRestNonce(){return typeof wpApiSettings<"u"?wpApiSettings.nonce:""}}class U{constructor(){this.btnResetTimers=new WeakMap,this.initExportImport(),this.initEmailSettings(),this.initJwtAuth(),this._contact=new O(this),this._contact.initContact()}setButtonState(e,t){if(!e)return;const s=this.btnResetTimers.get(e);if(s&&(clearTimeout(s),this.btnResetTimers.delete(e)),e.dataset.originalText||(e.dataset.originalText=e.textContent),e.classList.remove("ct-btn--loading","ct-btn--success","ct-btn--error"),!t){e.textContent=e.dataset.originalText,e.disabled=!1;return}if(t==="loading")e.textContent="",e.classList.add("ct-btn--loading"),e.disabled=!0;else if(t==="success"){e.textContent="",e.classList.add("ct-btn--success"),e.disabled=!0;const n=setTimeout(()=>{this.setButtonState(e,null)},2e3);this.btnResetTimers.set(e,n)}else if(t==="error"){e.textContent="",e.classList.add("ct-btn--error"),e.disabled=!0;const n=setTimeout(()=>{this.setButtonState(e,null)},2e3);this.btnResetTimers.set(e,n)}}initEmailSettings(){this.ecDebounceTimer=null,this.ecSaving=!1,this.ecActiveFields=new Set,this.ecFieldResetTimers=new Map,this.initEmailConfigForm()}initEmailConfigForm(){const e=document.querySelector("#email_config_form");if(!e)return;const t=e.querySelectorAll(".emailConfigInputs"),s=20;let n=0;t.forEach(a=>{n>=s||(n++,a.addEventListener("input",()=>{this.addFieldToSet(a.closest(".ct-admin-field"),this.ecActiveFields,this.ecFieldResetTimers),this.debounceEmailConfigSave(e)}),a.addEventListener("change",()=>{this.addFieldToSet(a.closest(".ct-admin-field"),this.ecActiveFields,this.ecFieldResetTimers),this.debounceEmailConfigSave(e)}))})}debounceEmailConfigSave(e){this.ecDebounceTimer&&clearTimeout(this.ecDebounceTimer),this.ecDebounceTimer=setTimeout(()=>{this.saveEmailConfig(e)},500)}async saveEmailConfig(e){if(this.ecSaving)return;this.ecSaving=!0;const t=new Set(this.ecActiveFields),s=e.elements.admin_save_email_config_nonce.value,n=JSON.stringify({host:(e.elements.ec_host||{}).value||"",port:parseInt((e.elements.ec_port||{}).value,10)||587,username:(e.elements.ec_username||{}).value||"",password:(e.elements.ec_password||{}).value||"",encryption:(e.elements.ec_encryption||{}).value||"tls",from_email:(e.elements.ec_from_email||{}).value||"",from_name:(e.elements.ec_from_name||{}).value||""}),a=new URLSearchParams({nonce:s,action:"admin_save_email_config",input:n});try{if((await(await fetch(ajaxurl,{method:"POST",body:a})).json()).success){this.setFieldsState("saved",t,this.ecActiveFields,this.ecFieldResetTimers),this.showNotice("Email configuration saved.","success");const i=e.elements.ec_password;i&&(i.value="")}else this.setFieldsState("error",t,this.ecActiveFields,this.ecFieldResetTimers),this.showNotice("Error saving email configuration.","error")}catch{this.setFieldsState("error",t,this.ecActiveFields,this.ecFieldResetTimers),this.showNotice("Network error. Please try again.","error")}finally{this.ecSaving=!1,this.ecActiveFields.size>0&&this.debounceEmailConfigSave(e)}}initJwtAuth(){this.jwtDebounceTimer=null,this.jwtSaving=!1,this.jwtActiveFields=new Set,this.jwtFieldResetTimers=new Map;const e=document.querySelector("#jwt_auth_form");if(!e)return;const t=e.querySelectorAll(".jwtAuthInputs"),s=e.querySelector("#jwt_secret"),n=e.querySelector("#jwt_expiration_hours"),a=e.querySelector("#generate_jwt_secret_btn"),o=10;let c=0;t.forEach(l=>{c>=o||(c++,l.addEventListener("input",()=>{this.addFieldToSet(l.closest(".ct-admin-field"),this.jwtActiveFields,this.jwtFieldResetTimers),this.debounceJwtSave(e)}),l.addEventListener("change",()=>{this.addFieldToSet(l.closest(".ct-admin-field"),this.jwtActiveFields,this.jwtFieldResetTimers),this.debounceJwtSave(e)}))}),a&&a.addEventListener("click",l=>{l.preventDefault();const r=document.querySelector("#jwt_secret");if(r){const d=new Uint8Array(32);crypto.getRandomValues(d);const u=Array.from(d,m=>m.toString(16).padStart(2,"0")).join("");r.value=u,r.dispatchEvent(new Event("input",{bubbles:!0}))}}),(()=>{const l=e.getAttribute("data-user-management-enabled")!=="0";s&&(s.disabled=!l),n&&(n.disabled=!l),a&&(a.disabled=!l)})()}debounceJwtSave(e){this.jwtDebounceTimer&&clearTimeout(this.jwtDebounceTimer),this.jwtDebounceTimer=setTimeout(()=>{this.saveJwtAuth(e)},500)}async saveJwtAuth(e){if(this.jwtSaving)return;const t=document.querySelector("#bs_user_management_enabled");if(t&&!t.checked||e.getAttribute("data-user-management-enabled")==="0")return;this.jwtSaving=!0;const s=new Set(this.jwtActiveFields),n=e.elements.admin_save_jwt_auth_nonce.value,a=JSON.stringify({secret:(e.elements.jwt_secret||{}).value||"",expiration_hours:parseInt((e.elements.jwt_expiration_hours||{}).value,10)||24}),o=new URLSearchParams({nonce:n,action:"admin_save_jwt_auth",input:a});try{(await(await fetch(ajaxurl,{method:"POST",body:o})).json()).success?(this.setFieldsState("saved",s,this.jwtActiveFields,this.jwtFieldResetTimers),this.showNotice("JWT auth settings saved.","success")):(this.setFieldsState("error",s,this.jwtActiveFields,this.jwtFieldResetTimers),this.showNotice("Error saving JWT auth settings.","error"))}catch{this.setFieldsState("error",s,this.jwtActiveFields,this.jwtFieldResetTimers),this.showNotice("Network error. Please try again.","error")}finally{this.jwtSaving=!1,this.jwtActiveFields.size>0&&this.debounceJwtSave(e)}}addFieldToSet(e,t,s){if(!e)return;const n=s.get(e);n&&(clearTimeout(n),s.delete(e)),e.classList.remove("ct-field--saved","ct-field--error"),e.classList.add("ct-field--saving"),t.add(e)}setFieldsState(e,t,s,n){const a=t||s;for(const o of a){const c=n.get(o);if(c&&(clearTimeout(c),n.delete(o)),o.classList.remove("ct-field--saving","ct-field--saved","ct-field--error"),e&&(o.classList.add("ct-field--"+e),e==="saved"||e==="error")){const i=setTimeout(()=>{o.classList.remove("ct-field--saved","ct-field--error"),n.delete(o)},2e3);n.set(o,i)}s.delete(o)}}initExportImport(){const e=document.querySelector("#export_settings_btn");e&&e.addEventListener("click",n=>{n.preventDefault(),this.exportSettings()});const t=document.querySelector("#import_settings_file"),s=document.querySelector("#import_settings_btn");t&&s&&(t.addEventListener("change",()=>{const n=t.files[0],a=document.querySelector("#import_file_info"),o=document.querySelector("#import_file_name");n&&n.name.endsWith(".json")?(s.disabled=!1,a&&o&&(o.textContent=n.name,a.style.display="block")):(s.disabled=!0,a&&(a.style.display="none"))}),s.addEventListener("click",n=>{n.preventDefault(),this.importSettings()}))}async exportSettings(){const e=document.querySelector("#export_settings_form");if(!e)return;const t=document.querySelector("#export_settings_btn"),s=e.elements.admin_export_settings_nonce.value,n=new URLSearchParams({nonce:s,action:"admin_export_settings",input:"1"});this.setButtonState(t,"loading");try{const o=await(await fetch(ajaxurl,{method:"POST",body:n})).json();if(o.success){const c=JSON.stringify(o.data,null,2),i=new Blob([c],{type:"application/json"}),l=URL.createObjectURL(i),r=document.createElement("a");r.href=l,r.download="ct-custom-settings-"+this.getDateStamp()+".json",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(l),this.setButtonState(t,"success"),this.showNotice("Settings exported successfully.","success")}else this.setButtonState(t,"error"),this.showNotice("Error exporting settings.","error")}catch{this.setButtonState(t,"error"),this.showNotice("Network error. Please try again.","error")}}importSettings(){const e=document.querySelector("#import_settings_form"),t=document.querySelector("#import_settings_file"),s=document.querySelector("#import_settings_btn");if(!e||!t||!t.files[0])return;const n=e.elements.admin_import_settings_nonce.value,a=t.files[0],o=new FileReader;o.onload=async c=>{const i=c.target.result;let l;try{l=JSON.parse(i)}catch{this.showNotice("Invalid JSON file.","error");return}if(!l.theme||l.theme!=="ct-custom"){this.showNotice("This file is not a valid BS Custom theme export.","error");return}const r=new URLSearchParams({nonce:n,action:"admin_import_settings",input:i});this.setButtonState(s,"loading");try{const u=await(await fetch(ajaxurl,{method:"POST",body:r})).json();if(u.success)this.setButtonState(s,"success"),this.showNotice("Settings imported successfully. Reloading page...","success"),setTimeout(()=>{window.location.reload()},1500);else{const m=u.data&&u.data.message?u.data.message:"Error importing settings.";this.setButtonState(s,"error"),this.showNotice(m,"error")}}catch{this.setButtonState(s,"error"),this.showNotice("Network error. Please try again.","error")}},o.readAsText(a)}getDateStamp(){const e=new Date,t=s=>String(s).padStart(2,"0");return e.getFullYear()+"-"+t(e.getMonth()+1)+"-"+t(e.getDate())}escapeHtml(e){const t=document.createElement("div");return t.appendChild(document.createTextNode(e)),t.innerHTML}showNotice(e,t){const s=document.querySelector(".ct-admin-notice");s&&s.remove();const n=document.createElement("div");n.className="ct-admin-notice ct-admin-notice--"+t,n.textContent=e,document.querySelector(".wrap").prepend(n),setTimeout(()=>{n.remove()},4e3)}}class H{constructor(){this.section=document.querySelector(".ct-lang-section"),this.section&&(this.nonce=this.section.dataset.nonce||"",this.ajaxUrl=this.section.dataset.ajaxUrl||"",this.currentTransKey="",this.allKeys=[],this.debounceTimer=null,this.currentKeyIsPlural=!1,this.initLanguages(),this.initTranslationEditor(),this.initPageTranslations())}initLanguages(){const e=document.getElementById("bs_add_language_form");e&&(e.addEventListener("submit",l=>this.handleAddLanguage(l)),this._bindLangFormValidation(e));const t=document.getElementById("bs_lang_flag_btn");t&&t.addEventListener("click",()=>this.openMediaPicker());const s=document.getElementById("bs_lang_flag_remove");s&&s.addEventListener("click",()=>this.clearFlag());const n=document.getElementById("bs_edit_language_form");n&&n.addEventListener("submit",l=>this.handleUpdateLanguage(l));const a=document.getElementById("bs_edit_cancel");a&&a.addEventListener("click",()=>this.closeEditModal());const o=document.querySelector(".ct-lang-edit-modal__backdrop");o&&o.addEventListener("click",()=>this.closeEditModal());const c=document.getElementById("bs_edit_flag_btn");c&&c.addEventListener("click",()=>this.openEditMediaPicker());const i=document.getElementById("bs_edit_flag_remove");i&&i.addEventListener("click",()=>this.clearEditFlag()),this.bindTableActions()}bindTableActions(){const e=document.getElementById("bs_language_table");e&&(e.addEventListener("click",t=>{const s=t.target,n=s.closest("tr[data-iso2]");if(!n)return;const a=n.dataset.iso2;s.classList.contains("ct-lang-edit")?this.openEditModal(s):s.classList.contains("ct-lang-set-default")?this.setDefaultLanguage(a):s.classList.contains("ct-lang-remove")&&this.removeLanguage(a)}),e.addEventListener("change",t=>{if(t.target.classList.contains("ct-lang-enable-toggle")){const s=t.target.closest("tr[data-iso2]"),n=s?s.dataset.iso2:"";n&&this.toggleLanguageEnabled(n,t.target.checked)}}))}_bindLangFormValidation(e){const t=["bs_lang_iso2","bs_lang_iso3","bs_lang_native_name","bs_lang_locale"];let n=0;for(const a of t){if(n>=4)break;n++;const o=document.getElementById(a);o&&o.addEventListener("input",()=>this._validateLangForm())}}_validateLangForm(){const e=document.getElementById("bs_lang_iso2"),t=document.getElementById("bs_lang_iso3"),s=document.getElementById("bs_lang_native_name"),n=document.getElementById("bs_lang_locale"),a=document.getElementById("bs_lang_submit_btn"),o=e?e.value.trim():"",c=t?t.value.trim():"",i=s?s.value.trim():"",l=n?n.value.trim():"";let r=!0;const d=e?e.closest(".ct-lang-add-form__field"):null,u=document.getElementById("bs_lang_iso2_error");o?/^[a-z]{2}$/.test(o)?(d&&d.classList.remove("ct-field--invalid"),u&&(u.textContent="")):(d&&d.classList.add("ct-field--invalid"),u&&(u.textContent="Must be exactly 2 lowercase letters."),r=!1):(d&&d.classList.add("ct-field--invalid"),u&&(u.textContent="ISO code is required."),r=!1);const m=t?t.closest(".ct-lang-add-form__field"):null,_=document.getElementById("bs_lang_iso3_error");c&&!/^[a-z]{3}$/.test(c)?(m&&m.classList.add("ct-field--invalid"),_&&(_.textContent="Must be exactly 3 lowercase letters."),r=!1):(m&&m.classList.remove("ct-field--invalid"),_&&(_.textContent=""));const p=s?s.closest(".ct-lang-add-form__field"):null,g=document.getElementById("bs_lang_native_name_error");i?(p&&p.classList.remove("ct-field--invalid"),g&&(g.textContent="")):(p&&p.classList.add("ct-field--invalid"),g&&(g.textContent="Native name is required."),r=!1);const b=n?n.closest(".ct-lang-add-form__field"):null,y=document.getElementById("bs_lang_locale_error");return l&&!/^[a-z]{2}_[A-Z]{2}$/.test(l)?(b&&b.classList.add("ct-field--invalid"),y&&(y.textContent="Must match format: xx_XX (e.g. fr_FR)."),r=!1):(b&&b.classList.remove("ct-field--invalid"),y&&(y.textContent="")),a&&(a.disabled=!r),r}async handleAddLanguage(e){if(e.preventDefault(),!this._validateLangForm())return;const t=document.getElementById("bs_lang_iso2").value.trim().toLowerCase(),s=document.getElementById("bs_lang_iso3").value.trim().toLowerCase(),n=document.getElementById("bs_lang_native_name").value.trim(),a=document.getElementById("bs_lang_locale").value.trim(),o=document.getElementById("bs_lang_flag").value.trim(),c={iso2:t,iso3:s,native_name:n,locale:a,flag:o},i=await this.ajaxPost("admin_add_language",JSON.stringify(c));if(i.success){window.ctToast.show(i.data.message||"Language added.","success"),document.getElementById("bs_add_language_form").reset(),this.clearFlag();const l=document.getElementById("bs_lang_submit_btn");l&&(l.disabled=!0);const r=document.querySelectorAll("#bs_add_language_form .ct-field--invalid"),d=10;let u=0;for(const m of r){if(u>=d)break;u++,m.classList.remove("ct-field--invalid")}i.data.language&&this.appendLanguageRow(i.data.language)}else{const l=i.data?.type||"error";window.ctToast.show(i.data?.message||"Error adding language.",l)}}async setDefaultLanguage(e){const t=new FormData;t.append("action","admin_set_default_language"),t.append("nonce",this.nonce),t.append("iso2",e);const s=await this.ajaxPostForm(t);if(s.success)window.ctToast.show(s.data.message||"Default language updated.","success"),this.updateDefaultInTable(e);else{const n=s.data?.type||"error";window.ctToast.show(s.data?.message||"Failed to set default language.",n)}}removeLanguage(e){this.showConfirmModal("Remove Language",`Are you sure you want to remove the language <strong>${this.escapeHtml(e.toUpperCase())}</strong>?`,"Remove",()=>this.showRemovePagesModal(e))}showRemovePagesModal(e){this.showConfirmModal("Remove Language",`<p>The language <strong>${this.escapeHtml(e.toUpperCase())}</strong>, its pages, menus and widgets will be removed.</p><label class="ct-confirm-modal__checkbox-label"><input type="checkbox" id="bs_remove_force_delete" class="ct-confirm-modal__checkbox" checked><span>Delete pages permanently (skip trash)</span></label><label class="ct-confirm-modal__checkbox-label"><input type="checkbox" id="bs_remove_posts" class="ct-confirm-modal__checkbox" checked><span>Remove posts</span></label><label class="ct-confirm-modal__checkbox-label"><input type="checkbox" id="bs_remove_tags" class="ct-confirm-modal__checkbox" checked><span>Remove tags</span></label><label class="ct-confirm-modal__checkbox-label"><input type="checkbox" id="bs_remove_categories" class="ct-confirm-modal__checkbox" checked><span>Remove categories</span></label><label class="ct-confirm-modal__checkbox-label"><input type="checkbox" id="bs_remove_menus" class="ct-confirm-modal__checkbox" checked><span>Remove menus</span></label><label class="ct-confirm-modal__checkbox-label"><input type="checkbox" id="bs_remove_widgets" class="ct-confirm-modal__checkbox" checked><span>Remove widgets</span></label>`,"Remove Language",()=>{const t=!!document.getElementById("bs_remove_force_delete")?.checked,s=!!document.getElementById("bs_remove_posts")?.checked,n=!!document.getElementById("bs_remove_tags")?.checked,a=!!document.getElementById("bs_remove_categories")?.checked,o=!!document.getElementById("bs_remove_menus")?.checked,c=!!document.getElementById("bs_remove_widgets")?.checked;this.executeRemoveLanguage(e,t,o,c,s,n,a)})}async executeRemoveLanguage(e,t,s=!0,n=!0,a=!0,o=!0,c=!0){const i=new FormData;i.append("action","admin_remove_language"),i.append("nonce",this.nonce),i.append("iso2",e),i.append("force_delete",t?"true":"false"),i.append("remove_menus",s?"true":"false"),i.append("remove_widgets",n?"true":"false"),i.append("remove_posts",a?"true":"false"),i.append("remove_tags",o?"true":"false"),i.append("remove_categories",c?"true":"false");const l=await this.ajaxPostForm(i);if(l.success)window.ctToast.show(l.data.message||"Language removed.","success"),this.removeLanguageRow(e);else{const r=l.data?.type||"error";window.ctToast.show(l.data?.message||"Failed to remove language.",r)}}showConfirmModal(e,t,s,n,a="",o=null){this.closeConfirmModal();const c=document.createElement("div");c.className="ct-confirm-modal__backdrop";const i=document.createElement("div");i.className="ct-confirm-modal__panel";const l=document.createElement("h3");l.className="ct-confirm-modal__title",l.textContent=e;const r=document.createElement("div");r.className="ct-confirm-modal__body",r.innerHTML=t;const d=document.createElement("div");d.className="ct-confirm-modal__actions";const u=document.createElement("button");u.type="button",u.className="button ct-confirm-modal__cancel",u.textContent="Cancel";const m=document.createElement("button");if(m.type="button",m.className="button button-primary ct-confirm-modal__confirm",m.textContent=s,d.appendChild(u),a&&o){const g=document.createElement("button");g.type="button",g.className="button ct-confirm-modal__alt",g.textContent=a,d.appendChild(g),g.addEventListener("click",()=>{o(),p()})}d.appendChild(m),i.appendChild(l),i.appendChild(r),i.appendChild(d);const _=document.createElement("div");_.className="ct-confirm-modal",_.id="bs_confirm_modal",_.setAttribute("role","dialog"),_.setAttribute("aria-modal","true"),_.appendChild(c),_.appendChild(i);const p=()=>_.remove();u.addEventListener("click",p),c.addEventListener("click",p),m.addEventListener("click",()=>{n(),p()}),document.body.appendChild(_),m.focus()}closeConfirmModal(){const e=document.getElementById("bs_confirm_modal");e&&e.remove()}async toggleLanguageEnabled(e,t){(await this.ajaxPost("admin_save_languages",JSON.stringify(this.getUpdatedLanguagesArray(e,"enabled",t)))).success||window.location.reload()}getUpdatedLanguagesArray(e,t,s){const n=document.querySelectorAll("#bs_language_table tbody tr[data-iso2]"),a=[],o=50;let c=0;for(const i of n){if(c>=o)break;c++;const l=i.dataset.iso2,r=i.querySelectorAll("td"),d={iso2:l,native_name:r[2]?r[2].textContent.trim():"",enabled:l===e?s:!!i.querySelector(".ct-lang-enable-toggle:checked")};a.push(d)}return a}openMediaPicker(){if(!wp||!wp.media)return;const e=wp.media({title:"Choose Flag",multiple:!1,library:{type:"image"}});e.on("select",()=>{const t=e.state().get("selection").first().toJSON();document.getElementById("bs_lang_flag").value=t.url||"";const s=document.getElementById("bs_lang_flag_preview");s&&(s.src=t.url||"",s.style.display=t.url?"block":"none");const n=document.getElementById("bs_lang_flag_remove");n&&(n.style.display=t.url?"inline-block":"none")}),e.open()}clearFlag(){document.getElementById("bs_lang_flag").value="";const e=document.getElementById("bs_lang_flag_preview");e&&(e.style.display="none");const t=document.getElementById("bs_lang_flag_remove");t&&(t.style.display="none")}appendLanguageRow(e){const t=document.querySelector("#bs_language_table tbody");if(!t)return;const s=this.buildLanguageRow(e);t.appendChild(s)}removeLanguageRow(e){const t=document.querySelector(`#bs_language_table tbody tr[data-iso2="${e}"]`);t&&t.remove()}updateDefaultInTable(e){const t=document.querySelectorAll("#bs_language_table tbody tr[data-iso2]"),s=50;let n=0;for(const a of t){if(n>=s)break;n++;const o=a.dataset.iso2,c=a.querySelectorAll("td")[4],i=a.querySelectorAll("td")[5],l=a.querySelectorAll("td")[6];if(!(!c||!i||!l))if(o===e){c.innerHTML='<span class="ct-lang-table__badge ct-lang-table__badge--default">Default</span>';const r=i.querySelector(".ct-lang-enable-toggle");r&&(r.checked=!0,r.disabled=!0);const d=l.querySelector(".ct-lang-remove");d&&d.remove()}else{c.querySelector(".ct-lang-table__badge--default")&&(c.innerHTML='<button type="button" class="button button-small ct-lang-set-default">Set Default</button>');const d=i.querySelector(".ct-lang-enable-toggle");if(d&&(d.disabled=!1),l.querySelector(".ct-lang-edit")&&!l.querySelector(".ct-lang-remove")){const m=document.createElement("button");m.type="button",m.className="button button-small ct-lang-remove",m.title="Remove",m.textContent="×",l.appendChild(m)}}}}updateLanguageRow(e,t){const s=document.querySelector(`#bs_language_table tbody tr[data-iso2="${e}"]`);if(!s)return;const n=s.querySelectorAll("td");n[0]&&t.flag!==void 0&&(t.flag?n[0].innerHTML=`<img src="${this.escapeAttr(t.flag)}" alt="" class="ct-lang-table__flag">`:n[0].innerHTML=`<span class="ct-lang-table__flag-placeholder">${this.escapeHtml(e.toUpperCase())}</span>`),n[2]&&t.native_name&&(n[2].textContent=t.native_name),n[3]&&t.locale!==void 0&&(n[3].textContent=t.locale||"");const a=s.querySelector(".ct-lang-edit");a&&(a.dataset.iso2=e,a.dataset.iso3=t.iso3||"",a.dataset.nativeName=t.native_name||"",a.dataset.locale=t.locale||"",a.dataset.flag=t.flag||"")}buildLanguageRow(e){const t=document.createElement("tr");t.dataset.iso2=e.iso2;const s=e.iso2||"",n=e.native_name||"",a=e.flag||"",o=Array.isArray(e.locales)?e.locales.join(", "):"",c=!!e.is_default,i=e.enabled!==!1,l=e.iso3||"",r=Array.isArray(e.locales)&&e.locales.length>0?e.locales[0]:"",d=document.createElement("td");if(a){const h=document.createElement("img");h.src=a,h.alt="",h.className="ct-lang-table__flag",d.appendChild(h)}else{const h=document.createElement("span");h.className="ct-lang-table__flag-placeholder",h.textContent=s.toUpperCase(),d.appendChild(h)}const u=document.createElement("td"),m=document.createElement("code");m.textContent=s,u.appendChild(m);const _=document.createElement("td");_.textContent=n;const p=document.createElement("td");p.textContent=o;const g=document.createElement("td");if(c)g.innerHTML='<span class="ct-lang-table__badge ct-lang-table__badge--default">Default</span>';else{const h=document.createElement("button");h.type="button",h.className="button button-small ct-lang-set-default",h.textContent="Set Default",g.appendChild(h)}const b=document.createElement("td"),y=document.createElement("label");y.className="ct-lang-toggle";const v=document.createElement("input");v.type="checkbox",v.className="ct-lang-toggle__input ct-lang-enable-toggle",v.checked=i,c&&(v.disabled=!0);const w=document.createElement("span");w.className="ct-lang-toggle__slider",y.appendChild(v),y.appendChild(w),b.appendChild(y);const x=document.createElement("td"),f=document.createElement("button");if(f.type="button",f.className="button button-small ct-lang-edit",f.dataset.iso2=s,f.dataset.iso3=l,f.dataset.nativeName=n,f.dataset.locale=r,f.dataset.flag=a,f.title="Edit",f.textContent="Edit",x.appendChild(f),!c){const h=document.createElement("button");h.type="button",h.className="button button-small ct-lang-remove",h.title="Remove",h.textContent="×",x.appendChild(h)}return t.appendChild(d),t.appendChild(u),t.appendChild(_),t.appendChild(p),t.appendChild(g),t.appendChild(b),t.appendChild(x),t}openEditModal(e){const t=document.getElementById("bs_lang_edit_modal");if(!t)return;document.getElementById("bs_edit_iso2").value=e.dataset.iso2||"",document.getElementById("bs_edit_iso2_badge").textContent=(e.dataset.iso2||"").toUpperCase(),document.getElementById("bs_edit_native_name").value=e.dataset.nativeName||"",document.getElementById("bs_edit_iso3").value=e.dataset.iso3||"",document.getElementById("bs_edit_locale").value=e.dataset.locale||"",document.getElementById("bs_edit_flag").value=e.dataset.flag||"";const s=document.getElementById("bs_edit_flag_preview"),n=document.getElementById("bs_edit_flag_remove");e.dataset.flag?(s.src=e.dataset.flag,s.style.display="block",n.style.display="inline-block"):(s.style.display="none",n.style.display="none");const a=document.getElementById("bs_edit_status");a&&(a.textContent=""),t.style.display="flex"}closeEditModal(){const e=document.getElementById("bs_lang_edit_modal");e&&(e.style.display="none")}async handleUpdateLanguage(e){e.preventDefault();const t=document.getElementById("bs_edit_iso2").value.trim(),s=document.getElementById("bs_edit_native_name").value.trim(),n=document.getElementById("bs_edit_iso3").value.trim().toLowerCase(),a=document.getElementById("bs_edit_locale").value.trim(),o=document.getElementById("bs_edit_flag").value.trim();if(!t||!s)return;const c={iso2:t,iso3:n,native_name:s,locale:a,flag:o},i=await this.ajaxPost("admin_update_language",JSON.stringify(c));if(i.success)window.ctToast.show(i.data.message||"Language updated.","success"),this.updateLanguageRow(t,{iso3:n,native_name:s,locale:a,flag:o}),this.closeEditModal();else{const l=i.data?.type||"error";window.ctToast.show(i.data?.message||"Failed to update language.",l)}}openEditMediaPicker(){if(!wp||!wp.media)return;const e=wp.media({title:"Choose Flag",multiple:!1,library:{type:"image"}});e.on("select",()=>{const t=e.state().get("selection").first().toJSON();document.getElementById("bs_edit_flag").value=t.url||"";const s=document.getElementById("bs_edit_flag_preview");s&&(s.src=t.url||"",s.style.display=t.url?"block":"none");const n=document.getElementById("bs_edit_flag_remove");n&&(n.style.display=t.url?"inline-block":"none")}),e.open()}clearEditFlag(){document.getElementById("bs_edit_flag").value="";const e=document.getElementById("bs_edit_flag_preview");e&&(e.style.display="none");const t=document.getElementById("bs_edit_flag_remove");t&&(t.style.display="none")}initTranslationEditor(){this.loadTranslationKeys();const e=document.getElementById("bs_trans_search");e&&e.addEventListener("input",()=>this.filterKeys(e.value));const t=document.getElementById("bs_trans_add_key");t&&t.addEventListener("click",()=>this.openAddKeyModal()),this.initAddKeyModal();const s=document.getElementById("bs_trans_delete_key");s&&s.addEventListener("click",()=>this.deleteCurrentKey());const n=document.getElementById("bs_trans_type_singular");n&&n.addEventListener("click",()=>this.toggleKeyType("singular"));const a=document.getElementById("bs_trans_type_plural");a&&a.addEventListener("click",()=>this.toggleKeyType("plural"));const o=document.getElementById("bs_trans_export");o&&o.addEventListener("click",()=>this.exportTranslations());const c=document.getElementById("bs_trans_import");c&&c.addEventListener("click",()=>{document.getElementById("bs_trans_import_file")?.click()});const i=document.getElementById("bs_trans_import_file");i&&i.addEventListener("change",l=>this.importTranslations(l))}async loadTranslationKeys(){const e=await this.ajaxPostSimple("admin_get_translation_keys");e.success&&e.data.keys&&(this.allKeys=e.data.keys,this.renderKeyList(this.allKeys))}renderKeyList(e){const t=document.getElementById("bs_trans_key_list");if(!t)return;t.innerHTML="";const s=500;let n=0;for(const a of e){if(n>=s)break;n++;const o=document.createElement("li");o.className="ct-trans-editor__key-item",o.textContent=a,o.dataset.key=a,a===this.currentTransKey&&o.classList.add("ct-trans-editor__key-item--active"),o.addEventListener("click",()=>this.selectKey(a)),t.appendChild(o)}e.length===0&&(t.innerHTML='<li class="ct-trans-editor__key-empty">No keys found</li>')}filterKeys(e){const t=e.toLowerCase(),s=this.allKeys.filter(n=>n.toLowerCase().includes(t));this.renderKeyList(s)}async selectKey(e){this.currentTransKey=e;const t=document.getElementById("bs_trans_placeholder"),s=document.getElementById("bs_trans_fields"),n=document.getElementById("bs_trans_current_key");t&&(t.style.display="none"),s&&(s.style.display="block"),n&&(n.textContent=e),this.renderKeyList(this.allKeys.filter(_=>{const p=document.getElementById("bs_trans_search");return!p||!p.value?!0:_.toLowerCase().includes(p.value.toLowerCase())}));const a=document.getElementById("bs_trans_lang_fields");if(!a)return;a.innerHTML="<p>Loading...</p>";const o=await this.ajaxPostSimple("admin_export_translations");if(!o.success){a.innerHTML="<p>Error loading translations.</p>";return}const c=o.data.translations||{},i=o.data.languages||[];this.currentKeyIsPlural=!1;const l=50;let r=0;for(const _ of i){if(r>=l)break;r++;const p=(c[_.iso2]||{})[e];if(typeof p=="object"&&p!==null){this.currentKeyIsPlural=!0;break}}this.updateToggleUI(),a.innerHTML="";const d=this.currentKeyIsPlural,u=50;let m=0;for(const _ of i){if(m>=u)break;m++;const p=_.iso2,g=(c[p]||{})[e];let b="";const y={};if(typeof g=="string")b=g;else if(typeof g=="object"&&g!==null){b=g.singular||"";const T=["zero","one","two","few","many","other"],I=6;let L=0;for(const E of T){if(L>=I)break;L++,y[E]=g[E]||""}}const v=document.createElement("div");v.className="ct-trans-editor__lang-field";const w=document.createElement("label");w.textContent=`${_.native_name} (${p})`,v.appendChild(w);const x=document.createElement("div");x.className="ct-trans-editor__singular-wrap",x.style.display=d?"none":"block";const f=document.createElement("input");f.type="text",f.value=b,f.dataset.iso2=p,f.dataset.singular="true",f.addEventListener("input",()=>{this.debounceSaveTranslation(e,p),this.detectPlaceholders()}),x.appendChild(f),v.appendChild(x);const h=document.createElement("div");h.className="ct-trans-editor__plural-wrap",h.style.display=d?"block":"none";const B=["zero","one","two","few","many","other"],S=6;let F=0;for(const T of B){if(F>=S)break;F++;const I=document.createElement("div");I.className="ct-trans-editor__plural-form";const L=document.createElement("span");L.className="ct-trans-editor__plural-label",L.textContent=T;const E=document.createElement("input");E.type="text",E.value=y[T]||"",E.dataset.iso2=p,E.dataset.form=T,E.dataset.plural="true",E.addEventListener("input",()=>{this.debounceSaveTranslation(e,p),this.detectPlaceholders()}),I.appendChild(L),I.appendChild(E),h.appendChild(I)}v.appendChild(h),a.appendChild(v)}this.detectPlaceholders()}debounceSaveTranslation(e,t){this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.saveTranslation(e,t)},500)}async saveTranslation(e,t){const s=document.getElementById("bs_trans_lang_fields");if(!s)return;const n=s.querySelector(`input[data-iso2="${t}"][data-singular]`),a=n?n.value:"",o=s.querySelectorAll(`input[data-iso2="${t}"][data-plural="true"]`),c={},i=6;let l=0;for(const u of o){if(l>=i)break;l++,c[u.dataset.form]=u.value,u.value.trim()}let r;if(this.currentKeyIsPlural){r={singular:a};const u=["zero","one","two","few","many","other"],m=6;let _=0;for(const p of u){if(_>=m)break;_++,c[p]&&(r[p]=c[p])}}else r=a;const d=await this.ajaxPost("admin_save_translation",JSON.stringify({key:e,iso2:t,value:r}));d.success?window.ctToast.show("Saved","success"):window.ctToast.show(d.data?.message||"Error saving translation.","error")}initAddKeyModal(){const e=document.getElementById("bs_add_key_modal"),t=e?e.querySelector(".ct-add-key-modal__backdrop"):null,s=document.getElementById("bs_add_key_cancel"),n=document.getElementById("bs_add_key_confirm"),a=document.getElementById("bs_add_key_input");e&&(t&&t.addEventListener("click",()=>this.closeAddKeyModal()),s&&s.addEventListener("click",()=>this.closeAddKeyModal()),n&&n.addEventListener("click",()=>this.addTranslationKey()),a&&a.addEventListener("keydown",o=>{o.key==="Enter"&&this.addTranslationKey(),o.key==="Escape"&&this.closeAddKeyModal()}))}openAddKeyModal(){const e=document.getElementById("bs_add_key_modal"),t=document.getElementById("bs_add_key_input");e&&(e.style.display="flex",t&&(t.value="",t.focus()))}closeAddKeyModal(){const e=document.getElementById("bs_add_key_modal");e&&(e.style.display="none")}async addTranslationKey(){const e=document.getElementById("bs_add_key_input"),t=e?e.value:"";if(!t||!t.trim())return;const s=t.trim().toUpperCase().replace(/[^A-Z0-9_]/g,"_"),n=new FormData;n.append("action","admin_add_translation_key"),n.append("nonce",this.nonce),n.append("key",s),(await this.ajaxPostForm(n)).success&&(this.closeAddKeyModal(),await this.loadTranslationKeys(),this.selectKey(s))}async deleteCurrentKey(){if(!this.currentTransKey||!confirm(`Delete key "${this.currentTransKey}" from all languages?`))return;const e=new FormData;e.append("action","admin_delete_translation_key"),e.append("nonce",this.nonce),e.append("key",this.currentTransKey),(await this.ajaxPostForm(e)).success&&(this.currentTransKey="",document.getElementById("bs_trans_placeholder").style.display="block",document.getElementById("bs_trans_fields").style.display="none",await this.loadTranslationKeys())}updateToggleUI(){const e=document.getElementById("bs_trans_type_singular"),t=document.getElementById("bs_trans_type_plural");!e||!t||(this.currentKeyIsPlural?(e.classList.remove("ct-trans-type-toggle__btn--active"),t.classList.add("ct-trans-type-toggle__btn--active")):(e.classList.add("ct-trans-type-toggle__btn--active"),t.classList.remove("ct-trans-type-toggle__btn--active")))}toggleKeyType(e){const t=e==="plural";if(t===this.currentKeyIsPlural)return;this.currentKeyIsPlural=t,this.updateToggleUI();const s=document.getElementById("bs_trans_lang_fields");if(!s)return;const n=s.querySelectorAll(".ct-trans-editor__singular-wrap"),a=s.querySelectorAll(".ct-trans-editor__plural-wrap"),o=50;let c=0;for(const i of n){if(c>=o)break;c++,i.style.display=t?"none":"block"}c=0;for(const i of a){if(c>=o)break;c++,i.style.display=t?"block":"none"}this.detectPlaceholders()}async saveAllLanguagesForKey(e){const t=document.getElementById("bs_trans_lang_fields");if(!t)return;const s=t.querySelectorAll(".ct-trans-editor__lang-field"),n=50;let a=0;for(const o of s){if(a>=n)break;a++;const c=o.querySelector("input[data-singular]");if(!c)continue;const i=c.dataset.iso2;await this.saveTranslation(e,i)}}detectPlaceholders(){const e=document.getElementById("bs_trans_lang_fields");if(!e)return;const t=e.querySelectorAll('input[type="text"]'),s=new Set,n=/##([a-zA-Z0-9_]+)##/g,a=500;let o=0;for(const c of t){if(o>=a)break;o++,n.lastIndex=0;let i;for(;(i=n.exec(c.value))!==null;)s.add(i[1])}this.renderPlaceholderBadges(s)}renderPlaceholderBadges(e){const t=document.getElementById("bs_trans_placeholders"),s=document.getElementById("bs_trans_placeholder_list");if(!t||!s)return;if(e.size===0){t.style.display="none";return}t.style.display="flex",s.innerHTML="";const n=20;let a=0;for(const o of e){if(a>=n)break;a++;const c=document.createElement("span");c.className="ct-trans-placeholders__badge",c.textContent=`##${o}##`,s.appendChild(c)}}async exportTranslations(){const e=await this.ajaxPostSimple("admin_export_translations");if(e.success){const t=new Blob([JSON.stringify(e.data,null,2)],{type:"application/json"}),s=URL.createObjectURL(t),n=document.createElement("a");n.href=s,n.download="ct-translations-export.json",n.click(),URL.revokeObjectURL(s)}}async importTranslations(e){const t=e.target.files[0];if(!t)return;const s=await t.text(),n=await this.ajaxPost("admin_import_translations",s);n.success?(window.ctToast.show(n.data.message||"Translations imported.","success"),window.location.reload()):window.ctToast.show(n.data?.message||"Import failed.","error"),e.target.value=""}initPageTranslations(){const e=document.getElementById("bs_page_lang_filter");e&&(e.addEventListener("change",()=>this.loadPagesForLanguage(e.value)),e.value&&this.loadPagesForLanguage(e.value))}async loadPagesForLanguage(e){const t=document.getElementById("bs_page_list");if(!t)return;t.innerHTML='<p class="ct-page-trans__loading">Loading pages...</p>';const s=new FormData;s.append("action","admin_get_pages_by_language"),s.append("nonce",this.nonce),s.append("iso2",e);const n=await this.ajaxPostForm(s);if(!n.success){t.innerHTML="<p>Error loading pages.</p>";return}const a=n.data.pages||[];if(t.innerHTML="",a.length===0){t.innerHTML="<p>No pages found for this language.</p>";return}const o=200;let c=0;for(const i of a){if(c>=o)break;c++;const l=document.createElement("div");l.className="ct-page-trans__card";const r=document.createElement("div");r.className="ct-page-trans__card-header";const d=document.createElement("strong");d.className="ct-page-trans__card-title",d.textContent=i.title;const u=document.createElement("span");u.className="ct-page-trans__card-status ct-page-trans__card-status--"+this.escapeAttr(i.status),u.textContent=i.status;const m=document.createElement("span");m.className="ct-page-trans__card-slug",m.textContent="/"+(i.slug||"")+"/";const _=document.createElement("span");_.className="ct-page-trans__card-actions";const p=document.createElement("button");if(p.type="button",p.className="button button-small ct-page-trans__quick-edit-btn",p.textContent="Quick Edit",_.appendChild(p),i.edit_url){const k=document.createElement("a");k.href=i.edit_url,k.className="button button-small",k.target="_blank",k.textContent="Edit in WP",k.addEventListener("click",C=>C.stopPropagation()),_.appendChild(k)}r.appendChild(d),r.appendChild(u),r.appendChild(m),r.appendChild(_);const g=document.createElement("div");g.className="ct-page-trans__quick-edit",g.style.display="none";const b=document.createElement("div");b.className="ct-page-trans__quick-edit-group";const y=document.createElement("label");y.textContent="Title:";const v=document.createElement("input");v.type="text",v.className="ct-page-trans__title",v.value=i.title,b.appendChild(y),b.appendChild(v);const w=document.createElement("div");w.className="ct-page-trans__quick-edit-group";const x=document.createElement("label");x.textContent="Slug:";const f=document.createElement("input");f.type="text",f.className="ct-page-trans__slug",f.value=i.slug||"",w.appendChild(x),w.appendChild(f);const h=document.createElement("div");h.className="ct-page-trans__quick-edit-group";const B=document.createElement("label");B.textContent="Parent:";const S=document.createElement("select");S.className="ct-page-trans__parent";const F=document.createElement("option");F.value="0",F.textContent="(no parent)",S.appendChild(F);const T=200;let I=0;for(const k of a){if(I>=T)break;if(k.id===i.id)continue;I++;const C=document.createElement("option");C.value=k.id,C.textContent=k.title,k.id===i.parent_id&&(C.selected=!0),S.appendChild(C)}h.appendChild(B),h.appendChild(S);const L=document.createElement("div");L.className="ct-page-trans__quick-edit-buttons";const E=document.createElement("button");E.type="button",E.className="button button-primary button-small ct-page-trans__save",E.textContent="Save";const P=document.createElement("button");P.type="button",P.className="button button-small ct-page-trans__cancel",P.textContent="Cancel",L.appendChild(E),L.appendChild(P),g.appendChild(b),g.appendChild(w),g.appendChild(h),g.appendChild(L),l.appendChild(r),l.appendChild(g),p.addEventListener("click",k=>{k.stopPropagation();const C=g.style.display!=="none";g.style.display=C?"none":"flex",p.textContent=C?"Quick Edit":"Close"}),P.addEventListener("click",()=>{v.value=d.textContent,f.value=m.textContent.replace(/^\/|\/$/g,""),S.value=String(i.parent_id||0),g.style.display="none",p.textContent="Quick Edit"}),E.addEventListener("click",async()=>{E.disabled=!0,E.textContent="Saving...";const k=await this.ajaxPost("admin_save_page_translation",JSON.stringify({post_id:i.id,title:v.value,slug:f.value,parent_id:parseInt(S.value,10)||0}));if(E.disabled=!1,E.textContent="Save",k.success){const C=k.data.title||v.value,j=k.data.slug||f.value;d.textContent=C,m.textContent="/"+j+"/",v.value=C,f.value=j,k.data.parent_id!==void 0&&(i.parent_id=k.data.parent_id,S.value=String(k.data.parent_id)),g.style.display="none",p.textContent="Quick Edit"}}),t.appendChild(l)}}async ajaxPost(e,t){const s=new FormData;return s.append("action",e),s.append("nonce",this.nonce),s.append("input",t),this.ajaxPostForm(s)}async ajaxPostSimple(e){const t=new FormData;return t.append("action",e),t.append("nonce",this.nonce),this.ajaxPostForm(t)}async ajaxPostForm(e){try{return await(await fetch(this.ajaxUrl,{method:"POST",body:e})).json()}catch(t){return{success:!1,data:{message:t.message}}}}escapeHtml(e){const t=document.createElement("div");return t.textContent=e||"",t.innerHTML}escapeAttr(e){return(e||"").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}}const K=30,J=10;class V{constructor(e,t){this.nonce=e,this.ajaxUrl=t,this.currentPage=1,this.currentType="all",this.currentLang="",this.searchQuery="",this.debounceTimer=null,this.bindEvents();const s=document.getElementById("bs_seo_dashboard_lang_filter");s&&(this.currentLang=s.value),this.load(1)}bindEvents(){const e=document.getElementById("bs_seo_dashboard_type_filter");e&&e.addEventListener("change",()=>{this.currentType=e.value,this.currentPage=1,this.load(1)});const t=document.getElementById("bs_seo_dashboard_lang_filter");t&&t.addEventListener("change",()=>{this.currentLang=t.value,this.currentPage=1,this.load(1)});const s=document.getElementById("bs_seo_dashboard_search");s&&s.addEventListener("input",()=>{this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.searchQuery=s.value.trim(),this.currentPage=1,this.load(1)},400)});const n=document.getElementById("bs_seo_bulk_analyze");n&&n.addEventListener("click",()=>this.bulkAnalyze());const a=document.getElementById("bs_seo_ping_engines");a&&a.addEventListener("click",()=>this.pingEngines())}async load(e){this.currentPage=e||1;const t=new FormData;t.append("action","admin_get_seo_dashboard"),t.append("nonce",this.nonce),t.append("page",String(this.currentPage)),t.append("post_type",this.currentType),t.append("lang",this.currentLang),t.append("search",this.searchQuery);const s=await this.ajaxPostForm(t);if(!s.success)return;const n=s.data||{};this.renderCards(n.cards||{}),this.renderTable(n.items||[]),this.renderPagination(n.total_pages||1)}renderCards(e){const t=document.getElementById("bs_seo_dashboard_cards");if(!t)return;t.innerHTML="";const s=[{key:"total_pages",label:"Total Pages",icon:"file"},{key:"scored_above_70",label:"Score > 70",icon:"check"},{key:"missing_meta",label:"Missing Meta",icon:"warning"},{key:"noindex",label:"Noindex",icon:"lock"}];let n=0;for(const a of s){if(n>=J)break;n++;const o=document.createElement("div");o.className="ct-seo-dashboard__card";const c=document.createElement("span");c.className="ct-seo-dashboard__card-value",c.textContent=String(e[a.key]||0);const i=document.createElement("span");i.className="ct-seo-dashboard__card-label",i.textContent=a.label,o.appendChild(c),o.appendChild(i),t.appendChild(o)}}renderTable(e){const t=document.getElementById("bs_seo_dashboard_table");if(!t)return;if(!e||e.length===0){t.innerHTML='<p class="ct-seo-dashboard__empty">No items found.</p>';return}const s=document.createElement("table");s.className="ct-seo-dashboard__data-table";const n=document.createElement("thead"),a=document.createElement("tr"),o=["Title","Type","Score","Meta Title","Meta Desc","Focus KW","Robots"],c=10;let i=0;for(const d of o){if(i>=c)break;i++;const u=document.createElement("th");u.textContent=d,a.appendChild(u)}n.appendChild(a),s.appendChild(n);const l=document.createElement("tbody");let r=0;for(const d of e){if(r>=K)break;r++;const u=document.createElement("tr"),m=document.createElement("td"),_=document.createElement("a");_.href=d.edit_url||"#",_.target="_blank",_.textContent=d.title||"(no title)",m.appendChild(_),u.appendChild(m);const p=document.createElement("td");p.textContent=d.post_type||"",u.appendChild(p);const g=document.createElement("td"),b=document.createElement("span"),y=parseInt(d.score,10)||0;b.className="ct-seo-score-badge",y>=70?b.classList.add("ct-seo-score-badge--good"):y>=40?b.classList.add("ct-seo-score-badge--ok"):b.classList.add("ct-seo-score-badge--poor"),b.textContent=String(y),g.appendChild(b),u.appendChild(g);const v=document.createElement("td");v.textContent=d.meta_title?"Yes":"-",v.className=d.meta_title?"ct-seo-dash-yes":"ct-seo-dash-no",u.appendChild(v);const w=document.createElement("td");w.textContent=d.meta_description?"Yes":"-",w.className=d.meta_description?"ct-seo-dash-yes":"ct-seo-dash-no",u.appendChild(w);const x=document.createElement("td");x.textContent=d.focus_keyword||"-",u.appendChild(x);const f=document.createElement("td");f.textContent=d.robots||"index, follow",u.appendChild(f),l.appendChild(u)}s.appendChild(l),t.innerHTML="",t.appendChild(s)}renderPagination(e){const t=document.getElementById("bs_seo_dashboard_pagination");if(!t||(t.innerHTML="",e<=1))return;const s=20;let n=0;for(let a=1;a<=e&&!(n>=s);a++){n++;const o=document.createElement("button");o.type="button",o.className="ct-seo-dashboard__page-btn",a===this.currentPage&&o.classList.add("ct-seo-dashboard__page-btn--active"),o.textContent=String(a),o.addEventListener("click",()=>this.load(a)),t.appendChild(o)}}async bulkAnalyze(){const e=document.getElementById("bs_seo_bulk_analyze");e&&(e.disabled=!0,e.textContent="Analyzing...");const t=new FormData;t.append("action","admin_bulk_analyze_seo"),t.append("nonce",this.nonce);const s=await this.ajaxPostForm(t);e&&(e.disabled=!1,e.textContent="Bulk Analyze"),s.success?(window.ctToast.show(s.data.message||"Analysis complete.","success"),this.load(this.currentPage)):window.ctToast.show(s.data?.message||"Analysis failed.","error")}async pingEngines(){const e=document.getElementById("bs_seo_ping_engines");e&&(e.disabled=!0,e.textContent="Pinging...");const t=new FormData;t.append("action","admin_ping_search_engines"),t.append("nonce",this.nonce);const s=await this.ajaxPostForm(t);e&&(e.disabled=!1,e.textContent="Ping Search Engines"),s.success?window.ctToast.show(s.data.message||"Search engines pinged.","success"):window.ctToast.show(s.data?.message||"Ping failed.","error")}async ajaxPostForm(e){try{return await(await fetch(this.ajaxUrl,{method:"POST",body:e})).json()}catch(t){return{success:!1,data:{message:t.message}}}}}const W=500;class X{constructor(e,t){this.nonce=e,this.ajaxUrl=t,this.bindEvents(),this.load()}bindEvents(){const e=document.getElementById("bs_seo_redirect_add");e&&e.addEventListener("click",()=>this.handleAdd());const t=document.getElementById("bs_seo_redirects_export");t&&t.addEventListener("click",()=>this.exportRedirects());const s=document.getElementById("bs_seo_redirects_import");s&&s.addEventListener("click",()=>{document.getElementById("bs_seo_redirects_import_file")?.click()});const n=document.getElementById("bs_seo_redirects_import_file");n&&n.addEventListener("change",a=>this.importRedirects(a))}async load(){const e=new FormData;e.append("action","admin_load_seo_redirects"),e.append("nonce",this.nonce);const t=await this.ajaxPostForm(e);t.success&&t.data.redirects?this.renderTable(t.data.redirects):this.renderTable([])}renderTable(e){const t=document.querySelector("#bs_seo_redirects_table tbody");if(!t)return;if(t.innerHTML="",!e||e.length===0){const n=document.createElement("tr"),a=document.createElement("td");a.colSpan=5,a.textContent="No redirects configured.",a.className="ct-seo-redirects__empty",n.appendChild(a),t.appendChild(n);return}let s=0;for(const n of e){if(s>=W)break;s++;const a=document.createElement("tr"),o=document.createElement("td");o.textContent=n.from||"",o.className="ct-seo-redirects__cell-url",a.appendChild(o);const c=document.createElement("td");c.textContent=n.to||"",c.className="ct-seo-redirects__cell-url",a.appendChild(c);const i=document.createElement("td"),l=document.createElement("span");l.className="ct-seo-redirects__type-badge",l.textContent=String(n.type||301),i.appendChild(l),a.appendChild(i);const r=document.createElement("td");r.textContent=String(n.hits||0),a.appendChild(r);const d=document.createElement("td"),u=document.createElement("button");u.type="button",u.className="button button-small ct-seo-redirects__delete-btn",u.textContent="Delete",u.addEventListener("click",()=>this.deleteRedirect(n.from)),d.appendChild(u),a.appendChild(d),t.appendChild(a)}}async handleAdd(){const e=document.getElementById("bs_seo_redirect_from"),t=document.getElementById("bs_seo_redirect_to"),s=document.getElementById("bs_seo_redirect_type"),n=e?e.value.trim():"",a=t?t.value.trim():"",o=s?s.value:"301";if(!n||!a){window.ctToast.show("Both From and To fields are required.","error");return}await this.addRedirect(n,a,o),e&&(e.value=""),t&&(t.value="")}async addRedirect(e,t,s){const n=new FormData;n.append("action","admin_save_seo_redirect"),n.append("nonce",this.nonce),n.append("input",JSON.stringify({action_type:"add",from:e,to:t,type:s}));const a=await this.ajaxPostForm(n);a.success?(window.ctToast.show(a.data.message||"Redirect added.","success"),this.load()):window.ctToast.show(a.data?.message||"Failed to add redirect.","error")}async deleteRedirect(e){const t=new FormData;t.append("action","admin_save_seo_redirect"),t.append("nonce",this.nonce),t.append("input",JSON.stringify({action_type:"delete",from:e}));const s=await this.ajaxPostForm(t);s.success?(window.ctToast.show(s.data.message||"Redirect removed.","success"),this.load()):window.ctToast.show(s.data?.message||"Failed to remove redirect.","error")}async exportRedirects(){const e=new FormData;e.append("action","admin_load_seo_redirects"),e.append("nonce",this.nonce);const t=await this.ajaxPostForm(e);if(t.success&&t.data.redirects){const s=new Blob([JSON.stringify(t.data.redirects,null,2)],{type:"application/json"}),n=URL.createObjectURL(s),a=document.createElement("a");a.href=n,a.download="seo-redirects-export.json",a.click(),URL.revokeObjectURL(n)}}async importRedirects(e){const t=e.target.files[0];if(!t)return;const s=await t.text(),n=new FormData;n.append("action","admin_save_seo_redirect"),n.append("nonce",this.nonce),n.append("input",JSON.stringify({action_type:"import",data:s}));const a=await this.ajaxPostForm(n);a.success?(window.ctToast.show(a.data.message||"Redirects imported.","success"),this.load()):window.ctToast.show(a.data?.message||"Import failed.","error"),e.target.value=""}async ajaxPostForm(e){try{return await(await fetch(this.ajaxUrl,{method:"POST",body:e})).json()}catch(t){return{success:!1,data:{message:t.message}}}}}class M{static PRIORITIES=["auto","0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9","1.0"];static CHANGEFREQS=["auto","always","hourly","daily","weekly","monthly","yearly","never"];constructor(e,t){this.nonce=e,this.ajaxUrl=t,this._saveTimers=new Map,this._orderTimers=new Map,this._bindEvents(),this.loadSettings()}_bindEvents(){document.getElementById("bs_seo_sitemap_save")?.addEventListener("click",()=>this.save()),document.getElementById("bs_seo_sitemap_regenerate")?.addEventListener("click",()=>this.regenerate());const e=document.getElementById("bs_seo_sitemap_enabled");e&&e.addEventListener("change",()=>{this._applySitemapEnabledState(e.checked),this.save()})}async loadSettings(){const e=new FormData;e.append("action","admin_load_seo_global"),e.append("nonce",this.nonce);const t=await this.ajaxPostForm(e);if(!t.success||!t.data)return;const s=t.data,n=document.getElementById("bs_seo_sitemap_enabled");n&&(n.checked=s.sitemap_enabled==="on"||s.sitemap_enabled===!0,this._applySitemapEnabledState(n.checked));let a=[];if(s.sitemap_post_types)try{a=JSON.parse(s.sitemap_post_types)}catch{}this._enabledTypes=Array.isArray(a)?a:[],await this._loadTreeTypes()}async _loadTreeTypes(){const e=new FormData;e.append("action","admin_get_sitemap_tree_types"),e.append("nonce",this.nonce);const t=await this.ajaxPostForm(e);!t.success||!t.data||(this._treeData=t.data,this.renderTypeToggles(t.data.types),this.loadTree(t.data))}renderTypeToggles(e){const t=document.getElementById("bs_sitemap_type_toggles");if(!t)return;t.innerHTML="";const s=20;let n=0;for(const a of e){if(n>=s)break;if(n++,a.slug==="attachment")continue;const o=this._enabledTypes.length===0?a.enabled:this._enabledTypes.includes(a.slug),c=document.createElement("label");c.className="ct-sitemap-type-toggle";const i=document.createElement("input");i.type="checkbox",i.value=a.slug,i.checked=o,i.setAttribute("data-type-toggle",a.slug),i.addEventListener("change",()=>this.save()),c.appendChild(i),c.appendChild(document.createTextNode(` ${a.label} (${a.count})`)),t.appendChild(c)}}async save(){const e=document.getElementById("bs_seo_sitemap_enabled"),t=document.querySelectorAll("[data-type-toggle]"),s=[],n=20;let a=0;for(const l of t){if(a>=n)break;a++,l.checked&&s.push(l.value)}const o={sitemap_enabled:e?.checked?"on":"off",sitemap_excluded:"",sitemap_post_types:s},c=new FormData;c.append("action","admin_save_seo_sitemap"),c.append("nonce",this.nonce),c.append("input",JSON.stringify(o));const i=await this.ajaxPostForm(c);i.success?(window.ctToast?.show(i.data.message||"Sitemap settings saved.","success"),this._enabledTypes=s):window.ctToast?.show(i.data?.message||"Error saving sitemap settings.","error")}async regenerate(){const e=document.getElementById("bs_seo_sitemap_regenerate");e&&(e.disabled=!0,e.classList.add("is-regenerating"));const t=new FormData;t.append("action","admin_regenerate_sitemap"),t.append("nonce",this.nonce);const s=await this.ajaxPostForm(t);e&&(e.disabled=!1,e.classList.remove("is-regenerating")),s.success?(window.ctToast?.show(s.data.message||"Sitemap regenerated.","success"),this._saveTimers.clear(),this._orderTimers.clear()):window.ctToast?.show(s.data?.message||"Error regenerating sitemap.","error")}_applySitemapEnabledState(e){const t=document.querySelector("section.ct-sitemap-types"),s=document.getElementById("bs_seo_sitemap_regenerate"),n=document.querySelector('.ct-sitemap-subtabs__label[for="bs_sitemap_subtab_index"]'),a=document.querySelector(".ct-sitemap-subpanel--index");t&&(t.hidden=!e),s&&(s.disabled=!e),n&&n.classList.toggle("ct-sitemap-subtab--disabled",!e),a&&a.classList.toggle("ct-sitemap-subpanel--disabled",!e)}loadTree(e){const t=document.getElementById("bs_sitemap_tree_root");if(!t)return;t.innerHTML="";const{langs:s,types:n}=e;if(!s||s.length===0){t.textContent="No languages configured.";return}const a=s.filter(i=>i.iso2!=="");if(a.length<=1){const i=a.length===1?a[0].iso2:"",l=20;let r=0;for(const d of n){if(r>=l)break;r++,t.appendChild(this._buildTypeAccordion(d,i))}return}const o=50;let c=0;for(const i of a){if(c>=o)break;c++,t.appendChild(this._buildLangAccordion(i,n))}}_buildLangAccordion(e,t){const s=document.createElement("div");s.className="ct-sitemap-lang",s.dataset.lang=e.iso2;const n=document.createElement("button");n.type="button",n.className="ct-sitemap-lang__header",n.setAttribute("aria-expanded","false");const a=document.createElement("span");a.className="ct-sitemap-lang__chevron",a.textContent="▶";const o=document.createElement("span");o.className="ct-sitemap-lang__iso",o.textContent=e.iso2.toUpperCase(),n.appendChild(a),n.appendChild(document.createTextNode(" "+e.label+" ")),n.appendChild(o);const c=document.createElement("div");return c.className="ct-sitemap-lang__body",c.hidden=!0,n.addEventListener("click",()=>{const i=!c.hidden;c.hidden=i,n.setAttribute("aria-expanded",String(!i)),a.style.transform=i?"":"rotate(90deg)",!i&&c.childElementCount===0&&this.openLang(e.iso2,t,c)}),s.appendChild(n),s.appendChild(c),s}async openLang(e,t,s){s.innerHTML="";const n=20;let a=0;for(const d of t){if(a>=n)break;a++,s.appendChild(this._buildTypeAccordion(d,e))}const o=new FormData;o.append("action","admin_get_sitemap_lang_counts"),o.append("nonce",this.nonce),o.append("lang",e);const c=await this.ajaxPostForm(o);if(!c.success||!c.data||!c.data.counts)return;const{counts:i}=c.data,l=20;let r=0;for(const d of s.querySelectorAll(".ct-sitemap-type")){if(r>=l)break;r++;const u=d.dataset.type,m=d.querySelector(".ct-sitemap-count");m&&u!==void 0&&i[u]!==void 0&&(m.textContent=i[u])}}_buildTypeAccordion(e,t){const s=document.createElement("div");s.className="ct-sitemap-type",s.dataset.type=e.slug,s.dataset.lang=t;const n=document.createElement("button");n.type="button",n.className="ct-sitemap-type__header",n.setAttribute("aria-expanded","false");const a=document.createElement("span");a.className="ct-sitemap-type__chevron",a.textContent="▶";const o=document.createElement("span");o.className="ct-sitemap-count",o.textContent=e.count,n.appendChild(a),n.appendChild(document.createTextNode(" "+e.label+" ")),n.appendChild(o);const c=document.createElement("div");return c.className="ct-sitemap-type__body",c.hidden=!0,n.addEventListener("click",()=>{const i=!c.hidden;c.hidden=i,n.setAttribute("aria-expanded",String(!i)),a.style.transform=i?"":"rotate(90deg)",!i&&c.childElementCount===0&&this.openType(e.slug,t,c)}),s.appendChild(n),s.appendChild(c),s}async openType(e,t,s){s.innerHTML='<p class="ct-sitemap-spinner">Loading&#8230;</p>';const n=s.previousElementSibling,a=n?n.querySelector(".ct-sitemap-count"):null;a&&(a.textContent="…");const o=new FormData;o.append("action","admin_get_sitemap_tree_items"),o.append("nonce",this.nonce),o.append("type",e),o.append("lang",t);const c=await this.ajaxPostForm(o);if(!c.success||!c.data){s.innerHTML='<p class="ct-sitemap-error">Failed to load items.</p>',a&&(a.textContent="?");return}const{items:i}=c.data;if(s.innerHTML="",a&&(a.textContent=i?i.length:0),!i||i.length===0){s.innerHTML='<p class="ct-sitemap-empty">No items found.</p>';return}s.appendChild(this._buildItemTable(i,e,t))}_buildItemTable(e,t,s){const n=document.createElement("table");n.className="ct-sitemap-items";const a=document.createElement("thead");a.innerHTML=`<tr>
            <th class="ct-sitemap-items__handle-col" aria-label="Drag to reorder"></th>
            <th>Title</th>
            <th>URL</th>
            <th>Priority</th>
            <th>Changefreq</th>
            <th>Exclude</th>
            <th>Last Modified</th>
            <th></th>
        </tr>`,n.appendChild(a);const o=document.createElement("tbody"),c=200;let i=0;for(const l of e){if(i>=c)break;i++,o.appendChild(this.renderItemRow(l,t))}return this._bindDragAndDrop(o,t,s),n.appendChild(o),n}renderItemRow(e,t){const s=document.createElement("tr");s.dataset.itemId=String(e.id),s.draggable=!0,e.excluded&&s.classList.add("ct-sitemap-item--excluded");const n=document.createElement("td");n.className="ct-sitemap-items__handle",n.textContent="⠿",n.setAttribute("aria-hidden","true"),s.addEventListener("dragstart",f=>{f.dataTransfer.setData("text/plain",String(e.id)),f.dataTransfer.effectAllowed="move",s.classList.add("ct-sitemap-item--dragging")}),s.addEventListener("dragend",()=>{s.classList.remove("ct-sitemap-item--dragging")});const a=document.createElement("td");a.className="ct-sitemap-items__title";const o=document.createElement("a");o.href=e.edit_url||"#",o.target="_blank",o.rel="noopener",o.textContent=e.title||"(no title)",a.appendChild(o);const c=document.createElement("td");c.className="ct-sitemap-items__url-cell";const i=document.createElement("div");i.className="ct-sitemap-items__url";const l=document.createElement("span");l.className="ct-sitemap-items__url-text",l.textContent=e.url,l.title=e.url;const r=document.createElement("button");r.type="button",r.className="ct-sitemap-items__copy-btn",r.title="Copy URL",r.setAttribute("aria-label","Copy URL"),r.innerHTML="&#x2398;",r.addEventListener("click",()=>{navigator.clipboard.writeText(e.url).then(()=>{r.innerHTML="&#x2713;",setTimeout(()=>{r.innerHTML="&#x2398;"},1500)})});const d=document.createElement("a");d.href=e.url,d.target="_blank",d.rel="noopener",d.className="ct-sitemap-items__open-btn",d.title="Open URL",d.setAttribute("aria-label","Open URL"),d.innerHTML="&#x2197;",i.appendChild(l),i.appendChild(r),i.appendChild(d),c.appendChild(i);const u=document.createElement("td"),m=this._buildSelect(M.PRIORITIES,e.priority);m.dataset.field="priority",m.addEventListener("change",()=>this.scheduleAutoSave(e,t,s)),u.appendChild(m);const _=document.createElement("td"),p=this._buildSelect(M.CHANGEFREQS,e.changefreq);p.dataset.field="changefreq",p.addEventListener("change",()=>this.scheduleAutoSave(e,t,s)),_.appendChild(p);const g=document.createElement("td");g.className="ct-sitemap-items__exclude-cell";const b=document.createElement("label");b.className="ct-seo-toggle";const y=document.createElement("input");y.type="checkbox",y.checked=e.excluded,y.className="ct-seo-toggle__input",y.dataset.field="excluded",y.addEventListener("change",()=>{s.classList.toggle("ct-sitemap-item--excluded",y.checked),this.scheduleAutoSave(e,t,s)});const v=document.createElement("span");v.className="ct-seo-toggle__slider",b.appendChild(y),b.appendChild(v),g.appendChild(b);const w=document.createElement("td");w.className="ct-sitemap-items__lastmod",w.textContent=e.lastmod||"—";const x=document.createElement("td");return x.className="ct-sitemap-item-status",s.appendChild(n),s.appendChild(a),s.appendChild(c),s.appendChild(u),s.appendChild(_),s.appendChild(g),s.appendChild(w),s.appendChild(x),s._selPriority=m,s._selFreq=p,s._toggleInput=y,s}_bindDragAndDrop(e,t,s){e.addEventListener("dragover",n=>{n.preventDefault(),n.dataTransfer.dropEffect="move";const a=e.querySelector(".ct-sitemap-item--dragging");if(!a)return;for(const c of e.querySelectorAll(".ct-sitemap-item--drop-before"))c.classList.remove("ct-sitemap-item--drop-before");const o=this._getDragAfterElement(e,n.clientY);o?(o.classList.add("ct-sitemap-item--drop-before"),e.insertBefore(a,o)):e.appendChild(a)}),e.addEventListener("dragleave",n=>{if(!e.contains(n.relatedTarget))for(const a of e.querySelectorAll(".ct-sitemap-item--drop-before"))a.classList.remove("ct-sitemap-item--drop-before")}),e.addEventListener("drop",n=>{n.preventDefault();for(const a of e.querySelectorAll(".ct-sitemap-item--drop-before"))a.classList.remove("ct-sitemap-item--drop-before");this._scheduleOrderSave(e,t,s)})}_getDragAfterElement(e,t){const s=[...e.querySelectorAll("tr:not(.ct-sitemap-item--dragging)")];let n=null,a=Number.NEGATIVE_INFINITY;const o=500;let c=0;for(const i of s){if(c>=o)break;c++;const l=i.getBoundingClientRect(),r=t-l.top-l.height/2;r<0&&r>a&&(a=r,n=i)}return n}_scheduleOrderSave(e,t,s){const n=t+"_"+s,a=this._orderTimers.get(n);a!==void 0&&clearTimeout(a);const o=setTimeout(async()=>{const c=[...e.querySelectorAll("tr[data-item-id]")].map(l=>parseInt(l.dataset.itemId,10)),i=new FormData;i.append("action","admin_save_sitemap_order"),i.append("nonce",this.nonce),i.append("input",JSON.stringify({type:t,lang:s,ids:c})),await this.ajaxPostForm(i),this._orderTimers.delete(n)},800);this._orderTimers.set(n,o)}scheduleAutoSave(e,t,s){const n=this._saveTimers.get(e.id);n!==void 0&&clearTimeout(n);const a=s.querySelector(".ct-sitemap-item-status");a&&(a.textContent="Saving…",a.className="ct-sitemap-item-status ct-sitemap-item-status--saving");const o=setTimeout(()=>this.saveItem(e,t,s),600);this._saveTimers.set(e.id,o)}async saveItem(e,t,s){const n=s._selPriority?.value??"auto",a=s._selFreq?.value??"auto",o=s._toggleInput?.checked??!1,c=new FormData;c.append("action","admin_save_sitemap_item"),c.append("nonce",this.nonce),c.append("input",JSON.stringify({id:e.id,type:t,priority:n,changefreq:a,excluded:o}));const i=await this.ajaxPostForm(c),l=s.querySelector(".ct-sitemap-item-status");this._saveTimers.delete(e.id),i.success?l&&(l.textContent="✓ Saved",l.className="ct-sitemap-item-status ct-sitemap-item-status--saved",setTimeout(()=>{l.textContent=""},2500)):l&&(l.textContent="✗ Error",l.className="ct-sitemap-item-status ct-sitemap-item-status--error")}_buildPagination(e,t,s,n,a){const o=document.createElement("div");o.className="ct-sitemap-pagination";const c=document.createElement("button");c.type="button",c.textContent="← Prev",c.disabled=e<=1,c.addEventListener("click",()=>this.openType(s,n,e-1,a));const i=document.createElement("span");i.className="ct-sitemap-pagination__info",i.textContent=`Page ${e} / ${t}`;const l=document.createElement("button");return l.type="button",l.textContent="Next →",l.disabled=e>=t,l.addEventListener("click",()=>this.openType(s,n,e+1,a)),o.appendChild(c),o.appendChild(i),o.appendChild(l),o}_buildSelect(e,t){const s=document.createElement("select");s.className="ct-seo-form__select ct-sitemap-select";const n=20;let a=0;for(const o of e){if(a>=n)break;a++;const c=document.createElement("option");c.value=o,c.textContent=o,o===t&&(c.selected=!0),s.appendChild(c)}return s}async ajaxPostForm(e){try{return await(await fetch(this.ajaxUrl,{method:"POST",body:e})).json()}catch(t){return{success:!1,data:{message:String(t.message)}}}}}class ${constructor(e,t){this.nonce=e,this.ajaxUrl=t,this.bindEvents(),this.loadSettings()}bindEvents(){const e=document.getElementById("bs_seo_llms_save");e&&e.addEventListener("click",()=>this.save());const t=document.getElementById("bs_seo_llms_enabled");t&&t.addEventListener("change",()=>this.loadPreview())}async loadSettings(){const e=new FormData;e.append("action","admin_load_seo_global"),e.append("nonce",this.nonce);const t=await this.ajaxPostForm(e);if(!t.success||!t.data)return;const s=t.data,n=document.getElementById("bs_seo_llms_enabled");n&&s.llms_enabled!==void 0&&(n.checked=!!s.llms_enabled);const a=document.getElementById("bs_seo_llms_custom");if(a&&s.llms_custom&&(a.value=s.llms_custom),s.llms_preview){const o=document.getElementById("bs_seo_llms_preview");o&&(o.textContent=s.llms_preview)}else this.loadPreview()}async loadPreview(){const e=new FormData;e.append("action","admin_load_seo_global"),e.append("nonce",this.nonce);const t=await this.ajaxPostForm(e);if(t.success&&t.data&&t.data.llms_preview){const s=document.getElementById("bs_seo_llms_preview");s&&(s.textContent=t.data.llms_preview)}}async save(){const e={llms_enabled:!!document.getElementById("bs_seo_llms_enabled")?.checked,llms_custom:document.getElementById("bs_seo_llms_custom")?.value||""},t=new FormData;t.append("action","admin_save_seo_llms"),t.append("nonce",this.nonce),t.append("input",JSON.stringify(e));const s=await this.ajaxPostForm(t);s.success?(window.ctToast.show(s.data.message||"LLMs.txt settings saved.","success"),this.loadPreview()):window.ctToast.show(s.data?.message||"Error saving LLMs.txt settings.","error")}async ajaxPostForm(e){try{return await(await fetch(this.ajaxUrl,{method:"POST",body:e})).json()}catch(t){return{success:!1,data:{message:t.message}}}}}class G{constructor(){this.section=document.querySelector(".ct-seo-section"),this.section&&(this.nonce=this.section.dataset.nonce||"",this.ajaxUrl=this.section.dataset.ajaxUrl||"",this.dashboard=new V(this.nonce,this.ajaxUrl),this.redirects=new X(this.nonce,this.ajaxUrl),this.sitemapCtrl=new M(this.nonce,this.ajaxUrl),this.llmsCtrl=new $(this.nonce,this.ajaxUrl),this.initGlobal(),this.initSocial(),this.initBreadcrumbs())}initGlobal(){const e=document.getElementById("bs_seo_global_save");e&&e.addEventListener("click",()=>this.saveGlobal());const t=this.section.querySelectorAll(".ct-seo-placeholder-btn"),s=10;let n=0;for(const c of t){if(n>=s)break;n++,c.addEventListener("click",()=>{const i=document.getElementById("bs_seo_title_template");if(!i)return;const l=c.dataset.placeholder||"",r=i.selectionStart||i.value.length,d=i.value.substring(0,r),u=i.value.substring(r);i.value=d+l+u,i.focus(),i.setSelectionRange(r+l.length,r+l.length)})}const a=document.getElementById("bs_seo_kg_logo_btn");a&&a.addEventListener("click",()=>this.openMediaPicker("bs_seo_kg_logo","bs_seo_kg_logo_preview","bs_seo_kg_logo_remove"));const o=document.getElementById("bs_seo_kg_logo_remove");o&&o.addEventListener("click",()=>this.clearMediaPicker("bs_seo_kg_logo","bs_seo_kg_logo_preview","bs_seo_kg_logo_remove")),this.loadGlobal()}async loadGlobal(){const e=await this.ajaxPostSimple("admin_load_seo_global");if(!e.success||!e.data)return;const t=e.data;this.setInputValue("bs_seo_title_template",t.title_template),this.setInputValue("bs_seo_separator",t.separator),this.setInputValue("bs_seo_default_description",t.default_description),this.setInputValue("bs_seo_default_keywords",t.default_keywords),this.setInputValue("bs_seo_kg_name",t.kg_name),this.setInputValue("bs_seo_kg_url",t.kg_url);const s=document.getElementById("bs_seo_kg_type");if(s&&t.kg_type&&(s.value=t.kg_type),t.kg_logo){document.getElementById("bs_seo_kg_logo").value=t.kg_logo;const n=document.getElementById("bs_seo_kg_logo_preview"),a=document.getElementById("bs_seo_kg_logo_remove");n&&(n.src=t.kg_logo,n.style.display="block"),a&&(a.style.display="inline-block")}}async saveGlobal(){const e={title_template:this.getInputValue("bs_seo_title_template"),separator:this.getInputValue("bs_seo_separator"),default_description:this.getInputValue("bs_seo_default_description"),default_keywords:this.getInputValue("bs_seo_default_keywords"),kg_type:this.getInputValue("bs_seo_kg_type"),kg_name:this.getInputValue("bs_seo_kg_name"),kg_logo:this.getInputValue("bs_seo_kg_logo"),kg_url:this.getInputValue("bs_seo_kg_url")},t=await this.ajaxPost("admin_save_seo_global",JSON.stringify(e));t.success?window.ctToast.show(t.data.message||"Global SEO settings saved.","success"):window.ctToast.show(t.data?.message||"Error saving settings.","error")}initSocial(){const e=document.getElementById("bs_seo_social_save");e&&e.addEventListener("click",()=>this.saveSocial());const t=document.getElementById("bs_seo_og_image_btn");t&&t.addEventListener("click",()=>this.openMediaPicker("bs_seo_og_image","bs_seo_og_image_preview","bs_seo_og_image_remove"));const s=document.getElementById("bs_seo_og_image_remove");s&&s.addEventListener("click",()=>this.clearMediaPicker("bs_seo_og_image","bs_seo_og_image_preview","bs_seo_og_image_remove")),this.loadSocial()}async loadSocial(){const e=await this.ajaxPostSimple("admin_load_seo_global");if(!e.success||!e.data)return;const t=e.data;this.setInputValue("bs_seo_og_sitename",t.og_sitename),this.setInputValue("bs_seo_twitter_username",t.twitter_username),this.setInputValue("bs_seo_pinterest_verify",t.pinterest_verify),this.setInputValue("bs_seo_social_profiles",t.social_profiles);const s=document.getElementById("bs_seo_twitter_card_type");if(s&&t.twitter_card_type&&(s.value=t.twitter_card_type),t.og_image){document.getElementById("bs_seo_og_image").value=t.og_image;const n=document.getElementById("bs_seo_og_image_preview"),a=document.getElementById("bs_seo_og_image_remove");n&&(n.src=t.og_image,n.style.display="block"),a&&(a.style.display="inline-block")}}async saveSocial(){const e={og_image:this.getInputValue("bs_seo_og_image"),og_sitename:this.getInputValue("bs_seo_og_sitename"),twitter_username:this.getInputValue("bs_seo_twitter_username"),twitter_card_type:this.getInputValue("bs_seo_twitter_card_type"),pinterest_verify:this.getInputValue("bs_seo_pinterest_verify"),social_profiles:this.getInputValue("bs_seo_social_profiles")},t=await this.ajaxPost("admin_save_seo_social",JSON.stringify(e));t.success?window.ctToast.show(t.data.message||"Social settings saved.","success"):window.ctToast.show(t.data?.message||"Error saving social settings.","error")}initBreadcrumbs(){const e=document.getElementById("bs_seo_breadcrumbs_save");e&&e.addEventListener("click",()=>this.saveBreadcrumbs()),this.loadBreadcrumbs()}async loadBreadcrumbs(){const e=await this.ajaxPostSimple("admin_load_seo_global");if(!e.success||!e.data)return;const t=e.data,s=document.getElementById("bs_seo_breadcrumbs_enabled");s&&(s.checked=!!t.breadcrumbs_enabled),this.setInputValue("bs_seo_breadcrumbs_separator",t.breadcrumbs_separator),this.setInputValue("bs_seo_breadcrumbs_home_label",t.breadcrumbs_home_label);const n=document.getElementById("bs_seo_breadcrumbs_pages");n&&t.breadcrumbs_pages!==void 0&&(n.checked=!!t.breadcrumbs_pages);const a=document.getElementById("bs_seo_breadcrumbs_posts");a&&t.breadcrumbs_posts!==void 0&&(a.checked=!!t.breadcrumbs_posts)}async saveBreadcrumbs(){const e={breadcrumbs_enabled:!!document.getElementById("bs_seo_breadcrumbs_enabled")?.checked,breadcrumbs_separator:this.getInputValue("bs_seo_breadcrumbs_separator"),breadcrumbs_home_label:this.getInputValue("bs_seo_breadcrumbs_home_label"),breadcrumbs_pages:!!document.getElementById("bs_seo_breadcrumbs_pages")?.checked,breadcrumbs_posts:!!document.getElementById("bs_seo_breadcrumbs_posts")?.checked},t=await this.ajaxPost("admin_save_seo_breadcrumbs",JSON.stringify(e));t.success?window.ctToast.show(t.data.message||"Breadcrumb settings saved.","success"):window.ctToast.show(t.data?.message||"Error saving breadcrumb settings.","error")}openMediaPicker(e,t,s){if(typeof wp>"u"||!wp.media)return;const n=wp.media({title:"Choose Image",multiple:!1,library:{type:"image"}});n.on("select",()=>{const o=n.state().get("selection").first().toJSON().url||"",c=document.getElementById(e);c&&(c.value=o);const i=document.getElementById(t);i&&(i.src=o,i.style.display=o?"block":"none");const l=document.getElementById(s);l&&(l.style.display=o?"inline-block":"none")}),n.open()}clearMediaPicker(e,t,s){const n=document.getElementById(e);n&&(n.value="");const a=document.getElementById(t);a&&(a.style.display="none");const o=document.getElementById(s);o&&(o.style.display="none")}getInputValue(e){const t=document.getElementById(e);return t&&t.value||""}setInputValue(e,t){const s=document.getElementById(e);s&&t!==void 0&&t!==null&&(s.value=t)}async ajaxPost(e,t){const s=new FormData;return s.append("action",e),s.append("nonce",this.nonce),s.append("input",t),this.ajaxPostForm(s)}async ajaxPostSimple(e){const t=new FormData;return t.append("action",e),t.append("nonce",this.nonce),this.ajaxPostForm(t)}async ajaxPostForm(e){try{return await(await fetch(this.ajaxUrl,{method:"POST",body:e})).json()}catch(t){return{success:!1,data:{message:t.message}}}}}class A{static MAX_TOASTS=5;static DURATION_MS=4e3;static ICONS={success:`<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="10" cy="10" r="10" fill="currentColor" opacity="0.15"/>
            <path d="M6 10.5L8.5 13L14 7.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>`,warning:`<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M10 2L1 18H19L10 2Z" fill="currentColor" opacity="0.15" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>
            <path d="M10 8V12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <circle cx="10" cy="15" r="1" fill="currentColor"/>
        </svg>`,error:`<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="10" cy="10" r="10" fill="currentColor" opacity="0.15"/>
            <path d="M7 7L13 13M13 7L7 13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>`};constructor(){this.container=null,this.toasts=[],this.ensureContainer()}ensureContainer(){this.container||(this.container=document.createElement("div"),this.container.className="ct-toast-container",this.container.setAttribute("aria-live","polite"),this.container.setAttribute("role","status"),document.body.appendChild(this.container))}show(e,t){q(typeof e=="string","Toast message must be a string"),q(["success","warning","error"].includes(t),"Toast type must be success, warning, or error"),this.ensureContainer(),this.toasts.length>=A.MAX_TOASTS&&this.dismiss(this.toasts[0]);const s=document.createElement("div");s.className=`ct-toast ct-toast--${t}`;const n=document.createElement("span");n.className="ct-toast__icon",n.innerHTML=A.ICONS[t]||A.ICONS.error;const a=document.createElement("span");a.className="ct-toast__message",a.textContent=e;const o=document.createElement("button");o.className="ct-toast__close",o.type="button",o.setAttribute("aria-label","Close notification"),o.innerHTML=`<svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 3L11 11M11 3L3 11" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>`,o.addEventListener("click",()=>this.dismiss(s));const c=document.createElement("div");c.className="ct-toast__progress";const i=document.createElement("div");i.className="ct-toast__progress-bar",c.appendChild(i),s.appendChild(n),s.appendChild(a),s.appendChild(o),s.appendChild(c),this.container.appendChild(s),this.toasts.push(s),requestAnimationFrame(()=>{s.classList.add("ct-toast--visible"),i.style.transition=`width ${A.DURATION_MS}ms linear`,i.style.width="0%"}),s._dismissTimer=setTimeout(()=>{this.dismiss(s)},A.DURATION_MS)}dismiss(e){if(!e||!e.parentNode)return;e._dismissTimer&&(clearTimeout(e._dismissTimer),e._dismissTimer=null),e.classList.remove("ct-toast--visible"),e.classList.add("ct-toast--exiting");const t=this.toasts.indexOf(e);t!==-1&&this.toasts.splice(t,1),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300)}}function q(N,e){N||console.warn("[Toast assert]",e)}class z{constructor(){window.ctToast=new A,this.admin=new U,this.languages=new H,this.seo=new G}}document.addEventListener("DOMContentLoaded",()=>{new z});
