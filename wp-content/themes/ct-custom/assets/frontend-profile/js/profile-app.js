const p="ct_auth_token",h={EMAIL_REGEX:/^[^\s@]+@[^\s@]+\.[^\s@]+$/,PASSWORD_RULES:{"min-length":n=>n.length>=8,lowercase:n=>/[a-z]/.test(n),uppercase:n=>/[A-Z]/.test(n),digit:n=>/\d/.test(n),special:n=>/[^a-zA-Z0-9]/.test(n)},USERNAME_RULES:{"username-min":n=>n.length>=4,"username-chars":n=>n.length===0||/^[a-zA-Z0-9._-]+$/.test(n),"username-special":n=>(n.match(/[._-]/g)||[]).length<=2},CODE_REGEX:/^\d{6}$/};class S{constructor(t){this._cacheVersion=t||"0"}getToken(){return localStorage.getItem(p)}setToken(t){localStorage.setItem(p,t)}clearToken(){localStorage.removeItem(p)}}class L{constructor(t,s,e){this._restUrl=t,this._nonce=s,this._store=e,this._onUnauthorized=null}setUnauthorizedHandler(t){this._onUnauthorized=t}setNonce(t){this._nonce=t}post(t,s){return this._request("POST",t,s,!1)}postAuth(t,s){return this._request("POST",t,s,!0)}getAuth(t){const s=this._store.getToken(),e={"X-WP-Nonce":this._nonce};return s&&(e.Authorization="Bearer "+s),fetch(this._restUrl+t,{method:"GET",headers:e,credentials:"same-origin"}).then(a=>(a.status===401&&this._onUnauthorized&&this._onUnauthorized(),a.json()))}uploadAuth(t,s){const e=this._store.getToken(),a={"X-WP-Nonce":this._nonce};return e&&(a.Authorization="Bearer "+e),fetch(this._restUrl+t,{method:"POST",headers:a,credentials:"same-origin",body:s}).then(r=>r.json())}_request(t,s,e,a){const r={"Content-Type":"application/json","X-WP-Nonce":this._nonce};if(a){const i=this._store.getToken();i&&(r.Authorization="Bearer "+i)}return fetch(this._restUrl+s,{method:t,headers:r,credentials:"same-origin",body:JSON.stringify(e)}).then(i=>i.json())}}const b=30,g=10;class E{bindFields(t,s){const e=t.querySelectorAll("[data-ct-validate-required], [data-ct-validate-password], [data-ct-validate-email], [data-ct-validate-match], [data-ct-validate-code], [data-ct-validate-username]");for(let a=0;a<e.length&&a<b;a++){const r=e[a];r.addEventListener("input",()=>{this._validateField(r,t),s&&s(this.isFormValid(t))}),r.addEventListener("blur",()=>{this._validateField(r,t)})}}isFormValid(t){const s=t.querySelectorAll("[data-ct-validate-required], [data-ct-validate-password], [data-ct-validate-email], [data-ct-validate-match], [data-ct-validate-code], [data-ct-validate-username]");let e=0;for(let a=0;a<s.length&&a<b;a++){const r=s[a];if(e++,!this._isFieldValid(r,t))return!1}return e>0}_validateField(t,s){if(t.value,t.hasAttribute("data-ct-validate-password")&&this._validatePasswordRules(t,s),t.name==="current_password"){const e=s.querySelector('input[name="new_password"]');e&&e.hasAttribute("data-ct-validate-password")&&this._validatePasswordRules(e,s)}if(t.hasAttribute("data-ct-validate-username")&&this._validateUsernameRules(t),t.hasAttribute("data-ct-validate-match")&&this._updateMatchUI(t,s),t.name){const e=s.querySelector('[data-ct-validate-match="'+t.name+'"]');e&&this._updateMatchUI(e,s)}}_updateMatchUI(t,s){const e=t.getAttribute("data-ct-validate-match"),a=s.querySelector('input[name="'+e+'"]');if(!a)return;const r=t.value,i=r===a.value&&r.length>0;t.classList.toggle("ct-auth-form__input--valid",i),t.classList.toggle("ct-auth-form__input--invalid",r.length>0&&!i);const o=t.closest(".ct-auth-form__field").querySelector(".ct-auth-form__match-hint");o&&(o.classList.toggle("ct-auth-form__match-hint--pass",i),o.classList.toggle("ct-auth-form__match-hint--fail",r.length>0&&!i),o.classList.toggle("ct-auth-form__match-hint--hidden",r.length===0))}_validatePasswordRules(t,s){const e=t.value,a=t.closest(".ct-auth-form__field"),r=a?a.querySelector(".ct-auth-form__validation"):null;if(!r)return;r.classList.toggle("ct-auth-form__validation--hidden",e.length===0);const i=r.querySelectorAll(".ct-auth-form__rule");for(let o=0;o<i.length&&o<g;o++){const l=i[o],c=l.getAttribute("data-rule");if(c==="different"){const _=l.getAttribute("data-rule-compare");if(_&&s){const f=s.querySelector('input[name="'+_+'"]'),m=f?f.value:"",v=e.length>0&&m.length>0,A=v&&e!==m,y=v&&e===m;l.classList.toggle("ct-auth-form__rule--pass",A),l.classList.toggle("ct-auth-form__rule--info",y),l.classList.remove("ct-auth-form__rule--fail")}continue}if(!c||!h.PASSWORD_RULES[c])continue;const d=h.PASSWORD_RULES[c](e);l.classList.toggle("ct-auth-form__rule--pass",d),l.classList.toggle("ct-auth-form__rule--fail",e.length>0&&!d)}}_validateUsernameRules(t){const s=t.value,e=t.closest(".ct-auth-form__field"),a=e?e.querySelector(".ct-auth-form__validation"):null;if(!a)return;a.classList.toggle("ct-auth-form__validation--hidden",s.length===0);const r=a.querySelectorAll(".ct-auth-form__rule");for(let i=0;i<r.length&&i<g;i++){const o=r[i],l=o.getAttribute("data-rule");if(!l||!h.USERNAME_RULES[l])continue;const c=h.USERNAME_RULES[l](s);o.classList.toggle("ct-auth-form__rule--pass",c),o.classList.toggle("ct-auth-form__rule--fail",s.length>0&&!c)}}_isFieldValid(t,s){const e=t.value.trim();if(t.hasAttribute("data-ct-validate-required")&&e.length===0)return!1;if(t.hasAttribute("data-ct-validate-min")){const a=parseInt(t.getAttribute("data-ct-validate-min"),10);if(e.length<a)return!1}if(t.hasAttribute("data-ct-validate-email")&&!h.EMAIL_REGEX.test(e))return!1;if(t.hasAttribute("data-ct-validate-password")){const a=h.PASSWORD_RULES,r=Object.keys(a);for(let l=0;l<r.length&&l<g;l++)if(!a[r[l]](e))return!1;const i=t.closest(".ct-auth-form__field"),o=i?i.querySelector('.ct-auth-form__rule[data-rule="different"]'):null;if(o){const l=o.getAttribute("data-rule-compare");if(l){const c=s.querySelector('input[name="'+l+'"]');if(c&&c.value.length>0&&e===c.value)return!1}}}if(t.hasAttribute("data-ct-validate-username")){const a=h.USERNAME_RULES,r=Object.keys(a);for(let i=0;i<r.length&&i<g;i++)if(!a[r[i]](e))return!1}if(t.hasAttribute("data-ct-validate-match")){const a=t.getAttribute("data-ct-validate-match"),r=s.querySelector('input[name="'+a+'"]');if(r&&e!==r.value)return!1}return!(t.hasAttribute("data-ct-validate-code")&&!h.CODE_REGEX.test(e))}}const M=10;class P{constructor(){this._validator=new E}bind(t){if(!t)return;const s=t.querySelector(".ct-auth-form");if(!s)return;const e=s.querySelector(".ct-auth-form__submit--disabled");e?(this._validator.bindFields(s,a=>{e.disabled=!a,e.classList.toggle("ct-auth-form__submit--disabled",!a)}),this._bindEnterSubmit(s,e)):this._validator.bindFields(s,null),this._bindPasswordToggles(s)}_bindEnterSubmit(t,s){t.addEventListener("keydown",e=>{e.key==="Enter"&&e.target.tagName!=="TEXTAREA"&&(e.preventDefault(),s.disabled||s.click())})}_bindPasswordToggles(t){const s=t.querySelectorAll(".ct-auth-form__password-toggle");for(let e=0;e<s.length&&e<M;e++){const a=s[e],r=a.closest(".ct-auth-form__password-wrap");if(!r)continue;const i=r.querySelector("input");i&&a.addEventListener("click",()=>{const o=i.type==="text";i.type=o?"password":"text",a.classList.toggle("ct-auth-form__password-toggle--active",!o)})}}getValidator(){return this._validator}}const U=100,q=100;class T{constructor(t,s,e){this._api=t,this._showMessage=s,this._setLoading=e}handleAvatarUpload(t){const s=t.querySelector(".ct-auth-form__avatar-file-input");s&&(s.onchange=()=>{const e=s.files[0];if(!e)return;const a=new FormData;a.append("avatar",e),this._setLoading(t,!0),this._api.uploadAuth("profile/upload-avatar",a).then(r=>{if(this._setLoading(t,!1),r.success&&r.data){const i=t.querySelector(".ct-auth-form__avatar-img");i&&r.data.avatar_url&&(i.style.backgroundImage="url("+r.data.avatar_url+")",i.innerHTML=""),this._showMessage(t,"success",r.message||"Avatar uploaded.")}else this._showMessage(t,"error",r.message||"Upload failed.")}).catch(()=>{this._setLoading(t,!1),this._showMessage(t,"error","An error occurred. Please try again.")}),s.value=""},s.click())}saveProfile(t,s){const e=t.querySelector('input[name="first_name"]'),a=t.querySelector('input[name="last_name"]');if(!e||!a)return;const r=e.value.trim(),i=a.value.trim();if(!r||!i){this._showMessage(t,"error","Please fill in both name fields.");return}this._setLoading(t,!0),this._api.postAuth("profile/update",{first_name:r,last_name:i}).then(o=>{this._setLoading(t,!1),o.success?(this._showMessage(t,"success",o.message||"Profile updated."),s&&o.data&&s(o.data.display_name)):this._showMessage(t,"error",o.message||"Update failed.")}).catch(()=>{this._setLoading(t,!1),this._showMessage(t,"error","An error occurred. Please try again.")})}loadUserMessages(t){const s=t.querySelector("#ct_profile_messages");s&&this._api.getAuth("contact/user-messages").then(e=>{if(!e.success||!e.data||!e.data.messages){s.innerHTML='<p class="ct-auth-form__no-messages fs14">No messages yet.</p>';return}const a=e.data.messages;if(a.length===0){s.innerHTML='<p class="ct-auth-form__no-messages fs14">No messages yet.</p>';return}let r="";const i=Math.min(a.length,U);for(let o=0;o<i;o++){const l=a[o],c=new Date(l.date).toLocaleDateString();if(r+='<div class="ct-auth-form__message-card">',r+='<div class="ct-auth-form__message-card-header">',r+='<span class="ct-auth-form__message-card-date">'+this._escapeHtml(c)+"</span>",r+='<span class="ct-auth-form__message-card-pointer">'+this._escapeHtml(l.pointer)+"</span>",r+="</div>",r+='<p class="ct-auth-form__message-card-body fs14">'+this._escapeHtml(l.body)+"</p>",l.replies&&l.replies.length>0){const d=Math.min(l.replies.length,q);for(let _=0;_<d;_++){const f=l.replies[_],m=new Date(f.date).toLocaleDateString();r+='<div class="ct-auth-form__message-reply">',r+='<div class="ct-auth-form__message-reply-header">',r+="<strong>"+this._escapeHtml(f.author_name)+"</strong>",r+="<span>"+this._escapeHtml(m)+"</span>",r+="</div>",r+='<p class="m0">'+this._escapeHtml(f.body)+"</p>",r+="</div>"}}r+="</div>"}s.innerHTML=r}).catch(()=>{s.innerHTML='<p class="ct-auth-form__no-messages fs14">Could not load messages.</p>'})}_escapeHtml(t){if(typeof t!="string")return"";const s=document.createElement("div");return s.textContent=t,s.innerHTML}changePassword(t,s){const e=t.querySelector("[data-ct-password-section]")||t,a=t.querySelector('input[name="current_password"]'),r=t.querySelector('input[name="new_password"]'),i=t.querySelector('input[name="new_password_confirm"]');if(!a||!r||!i)return;const o=a.value,l=r.value,c=i.value;if(!o||!l||!c){this._showMessage(e,"error","Please fill in all password fields.");return}if(o===l){this._showMessage(e,"error","New password must be different from your current password.");return}if(l!==c){this._showMessage(e,"error","New passwords do not match.");return}if(l.length<8){this._showMessage(e,"error","Password must be at least 8 characters.");return}this._setLoading(e,!0),this._api.postAuth("profile/change-password",{current_password:o,new_password:l,new_password_confirm:c}).then(d=>{this._setLoading(e,!1),d.success?(this._showMessage(e,"success",d.message||"Password changed."),a.value="",r.value="",i.value="",s&&s()):this._showMessage(e,"error",d.message||"Password change failed.")}).catch(()=>{this._setLoading(e,!1),this._showMessage(e,"error","An error occurred. Please try again.")})}}function u(n,t){if(!n)throw new Error("Assertion failed: "+(t||""))}class w{constructor(){u(typeof document<"u","document must exist"),u(typeof window<"u","window must exist"),this._card=document.querySelector(".ct-profile-card"),this._card&&(this._restUrl=this._card.getAttribute("data-rest-url")||"",this._nonce=this._card.getAttribute("data-nonce")||"",this._cacheVersion=this._card.getAttribute("data-cache-version")||"0",this._authUrl=this._card.getAttribute("data-auth-url")||"/login-register/",u(typeof this._restUrl=="string","restUrl must be a string"),u(typeof this._nonce=="string","nonce must be a string"),this._profileMessagesLoaded=!1,this._overlay=null,this._initSubSystems(),this._bindForm(),this._bindActions(),this._bindProfileTabs())}_initSubSystems(){this._store=new S(this._cacheVersion),this._api=new L(this._restUrl,this._nonce,this._store),this._binder=new P,this._profile=new T(this._api,this._showMessage.bind(this),this._setLoading.bind(this)),this._api.setUnauthorizedHandler(()=>{window.location.href=this._authUrl})}_bindForm(){u(this._card instanceof HTMLElement,"card must be HTMLElement"),this._binder.bind(this._card)}_bindActions(){u(typeof this._card.addEventListener=="function","addEventListener must exist"),u(this._card!==null,"card must exist"),this._card.addEventListener("click",t=>{const s=t.target.closest("[data-ct-auth-action]");if(!s)return;t.preventDefault();const e=s.getAttribute("data-ct-auth-action");this._handleAction(e)})}_handleAction(t){switch(u(typeof t=="string","action must be a string"),u(t.length>0,"action must not be empty"),t){case"save-profile":this._submitSaveProfile();break;case"change-password":this._submitChangePassword();break;case"upload-avatar":this._handleAvatarUpload();break;case"logout":this._submitLogout();break}}_bindProfileTabs(){const t=this._card.querySelectorAll("[data-ct-profile-tab]"),s=5;let e=0;t.forEach(a=>{e>=s||(e++,a.addEventListener("click",()=>{this._switchProfileTab(a.getAttribute("data-ct-profile-tab"),t)}))})}_switchProfileTab(t,s){if(!t)return;const e=5;let a=0;s.forEach(o=>{if(a>=e)return;a++;const l=o.getAttribute("data-ct-profile-tab")===t;o.classList.toggle("ct-auth-form__tab--active",l),o.setAttribute("aria-selected",l?"true":"false")});const r=this._card.querySelectorAll("[data-ct-profile-panel]"),i=5;a=0,r.forEach(o=>{if(a>=i)return;a++;const l=o.getAttribute("data-ct-profile-panel")===t;o.classList.toggle("ct-auth-form__tab-panel--active",l),o.style.display=l?"":"none"}),t==="messages"&&!this._profileMessagesLoaded&&(this._profileMessagesLoaded=!0,this._profile.loadUserMessages(this._card))}_submitSaveProfile(){this._profile.saveProfile(this._card,t=>{this._updateDisplayName(t)})}_submitChangePassword(){this._profile.changePassword(this._card,()=>{this._store.clearToken(),this._blockPage(),setTimeout(()=>{window.location.href=this._authUrl},1500)})}_handleAvatarUpload(){this._profile.handleAvatarUpload(this._card)}_submitLogout(){this._store.clearToken(),this._api.post("logout",{}).then(()=>{window.location.reload()}).catch(()=>{window.location.reload()})}_updateDisplayName(t){const s=document.querySelector(".ct-auth-links");if(!s)return;const e=s.querySelector(".ct-auth-links__greeting");e&&(e.textContent=t)}_showMessage(t,s,e){if(!t||!(t instanceof HTMLElement))return;const a=t.querySelector(".ct-auth-form__messages");if(!a)return;a.innerHTML="";const r=document.createElement("div");r.className="ct-auth-form__message fs14 ct-auth-form__message--"+s,r.textContent=e,a.appendChild(r),a.scrollIntoView({behavior:"smooth",block:"nearest"})}_setLoading(t,s){if(!t||!(t instanceof HTMLElement))return;const e=t.querySelector(".ct-auth-form__submit");e&&(e.disabled=s,s?(e.classList.add("ct-auth-form__submit--loading"),this._blockPage()):(e.classList.remove("ct-auth-form__submit--loading"),this._unblockPage()))}_blockPage(){if(this._overlay)return;const t=document.createElement("div");t.style.cssText="position:fixed;inset:0;z-index:99999;cursor:not-allowed;",document.body.appendChild(t),this._overlay=t}_unblockPage(){this._overlay&&(this._overlay.remove(),this._overlay=null)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{new w}):new w;
