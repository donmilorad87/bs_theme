const g="ct_auth_token";const v=["login","register","forgot-password","activation-code","reset-code","reset-password"],b=["login","register"],d={EMAIL_REGEX:/^[^\s@]+@[^\s@]+\.[^\s@]+$/,PASSWORD_RULES:{"min-length":c=>c.length>=8,lowercase:c=>/[a-z]/.test(c),uppercase:c=>/[A-Z]/.test(c),digit:c=>/\d/.test(c),special:c=>/[^a-zA-Z0-9]/.test(c)},USERNAME_RULES:{"username-min":c=>c.length>=4,"username-chars":c=>c.length===0||/^[a-zA-Z0-9._-]+$/.test(c),"username-special":c=>(c.match(/[._-]/g)||[]).length<=2},CODE_REGEX:/^\d{6}$/};class P{constructor(e){this._cacheVersion=e||"0"}getToken(){return localStorage.getItem(g)}setToken(e){localStorage.setItem(g,e)}clearToken(){localStorage.removeItem(g)}}class M{constructor(e,s,t){this._restUrl=e,this._nonce=s,this._store=t,this._onUnauthorized=null}setUnauthorizedHandler(e){this._onUnauthorized=e}setNonce(e){this._nonce=e}post(e,s){return this._request("POST",e,s,!1)}postAuth(e,s){return this._request("POST",e,s,!0)}getAuth(e){const s=this._store.getToken(),t={"X-WP-Nonce":this._nonce};return s&&(t.Authorization="Bearer "+s),fetch(this._restUrl+e,{method:"GET",headers:t,credentials:"same-origin"}).then(r=>(r.status===401&&this._onUnauthorized&&this._onUnauthorized(),r.json()))}uploadAuth(e,s){const t=this._store.getToken(),r={"X-WP-Nonce":this._nonce};return t&&(r.Authorization="Bearer "+t),fetch(this._restUrl+e,{method:"POST",headers:r,credentials:"same-origin",body:s}).then(a=>a.json())}_request(e,s,t,r){const a={"Content-Type":"application/json","X-WP-Nonce":this._nonce};if(r){const i=this._store.getToken();i&&(a.Authorization="Bearer "+i)}return fetch(this._restUrl+s,{method:e,headers:a,credentials:"same-origin",body:JSON.stringify(t)}).then(i=>i.json())}}const A=30,f=10;class k{bindFields(e,s){const t=e.querySelectorAll("[data-ct-validate-required], [data-ct-validate-password], [data-ct-validate-email], [data-ct-validate-match], [data-ct-validate-code], [data-ct-validate-username]");for(let r=0;r<t.length&&r<A;r++){const a=t[r];a.addEventListener("input",()=>{this._validateField(a,e),s&&s(this.isFormValid(e))}),a.addEventListener("blur",()=>{this._validateField(a,e)})}}isFormValid(e){const s=e.querySelectorAll("[data-ct-validate-required], [data-ct-validate-password], [data-ct-validate-email], [data-ct-validate-match], [data-ct-validate-code], [data-ct-validate-username]");let t=0;for(let r=0;r<s.length&&r<A;r++){const a=s[r];if(t++,!this._isFieldValid(a,e))return!1}return t>0}_validateField(e,s){if(e.value,e.hasAttribute("data-ct-validate-password")&&this._validatePasswordRules(e,s),e.name==="current_password"){const t=s.querySelector('input[name="new_password"]');t&&t.hasAttribute("data-ct-validate-password")&&this._validatePasswordRules(t,s)}if(e.hasAttribute("data-ct-validate-username")&&this._validateUsernameRules(e),e.hasAttribute("data-ct-validate-match")&&this._updateMatchUI(e,s),e.name){const t=s.querySelector('[data-ct-validate-match="'+e.name+'"]');t&&this._updateMatchUI(t,s)}}_updateMatchUI(e,s){const t=e.getAttribute("data-ct-validate-match"),r=s.querySelector('input[name="'+t+'"]');if(!r)return;const a=e.value,i=a===r.value&&a.length>0;e.classList.toggle("ct-auth-form__input--valid",i),e.classList.toggle("ct-auth-form__input--invalid",a.length>0&&!i);const n=e.closest(".ct-auth-form__field").querySelector(".ct-auth-form__match-hint");n&&(n.classList.toggle("ct-auth-form__match-hint--pass",i),n.classList.toggle("ct-auth-form__match-hint--fail",a.length>0&&!i),n.classList.toggle("ct-auth-form__match-hint--hidden",a.length===0))}_validatePasswordRules(e,s){const t=e.value,r=e.closest(".ct-auth-form__field"),a=r?r.querySelector(".ct-auth-form__validation"):null;if(!a)return;a.classList.toggle("ct-auth-form__validation--hidden",t.length===0);const i=a.querySelectorAll(".ct-auth-form__rule");for(let n=0;n<i.length&&n<f;n++){const o=i[n],l=o.getAttribute("data-rule");if(l==="different"){const _=o.getAttribute("data-rule-compare");if(_&&s){const w=s.querySelector('input[name="'+_+'"]'),m=w?w.value:"",p=t.length>0&&m.length>0,S=p&&t!==m,L=p&&t===m;o.classList.toggle("ct-auth-form__rule--pass",S),o.classList.toggle("ct-auth-form__rule--info",L),o.classList.remove("ct-auth-form__rule--fail")}continue}if(!l||!d.PASSWORD_RULES[l])continue;const u=d.PASSWORD_RULES[l](t);o.classList.toggle("ct-auth-form__rule--pass",u),o.classList.toggle("ct-auth-form__rule--fail",t.length>0&&!u)}}_validateUsernameRules(e){const s=e.value,t=e.closest(".ct-auth-form__field"),r=t?t.querySelector(".ct-auth-form__validation"):null;if(!r)return;r.classList.toggle("ct-auth-form__validation--hidden",s.length===0);const a=r.querySelectorAll(".ct-auth-form__rule");for(let i=0;i<a.length&&i<f;i++){const n=a[i],o=n.getAttribute("data-rule");if(!o||!d.USERNAME_RULES[o])continue;const l=d.USERNAME_RULES[o](s);n.classList.toggle("ct-auth-form__rule--pass",l),n.classList.toggle("ct-auth-form__rule--fail",s.length>0&&!l)}}_isFieldValid(e,s){const t=e.value.trim();if(e.hasAttribute("data-ct-validate-required")&&t.length===0)return!1;if(e.hasAttribute("data-ct-validate-min")){const r=parseInt(e.getAttribute("data-ct-validate-min"),10);if(t.length<r)return!1}if(e.hasAttribute("data-ct-validate-email")&&!d.EMAIL_REGEX.test(t))return!1;if(e.hasAttribute("data-ct-validate-password")){const r=d.PASSWORD_RULES,a=Object.keys(r);for(let o=0;o<a.length&&o<f;o++)if(!r[a[o]](t))return!1;const i=e.closest(".ct-auth-form__field"),n=i?i.querySelector('.ct-auth-form__rule[data-rule="different"]'):null;if(n){const o=n.getAttribute("data-rule-compare");if(o){const l=s.querySelector('input[name="'+o+'"]');if(l&&l.value.length>0&&t===l.value)return!1}}}if(e.hasAttribute("data-ct-validate-username")){const r=d.USERNAME_RULES,a=Object.keys(r);for(let i=0;i<a.length&&i<f;i++)if(!r[a[i]](t))return!1}if(e.hasAttribute("data-ct-validate-match")){const r=e.getAttribute("data-ct-validate-match"),a=s.querySelector('input[name="'+r+'"]');if(a&&t!==a.value)return!1}return!(e.hasAttribute("data-ct-validate-code")&&!d.CODE_REGEX.test(t))}}const E=10;class q{constructor(){this._validator=new k}bind(e){if(!e)return;const s=e.querySelector(".ct-auth-form");if(!s)return;const t=s.querySelector(".ct-auth-form__submit--disabled");t?(this._validator.bindFields(s,r=>{t.disabled=!r,t.classList.toggle("ct-auth-form__submit--disabled",!r)}),this._bindEnterSubmit(s,t)):this._validator.bindFields(s,null),this._bindPasswordToggles(s)}_bindEnterSubmit(e,s){e.addEventListener("keydown",t=>{t.key==="Enter"&&t.target.tagName!=="TEXTAREA"&&(t.preventDefault(),s.disabled||s.click())})}_bindPasswordToggles(e){const s=e.querySelectorAll(".ct-auth-form__password-toggle");for(let t=0;t<s.length&&t<E;t++){const r=s[t],a=r.closest(".ct-auth-form__password-wrap");if(!a)continue;const i=a.querySelector("input");i&&r.addEventListener("click",()=>{const n=i.type==="text";i.type=n?"password":"text",r.classList.toggle("ct-auth-form__password-toggle--active",!n)})}}getValidator(){return this._validator}}function h(c,e){if(!c)throw new Error("Assertion failed: "+(e||""))}class y{constructor(){h(typeof document<"u","document must exist"),h(typeof window<"u","window must exist"),this._card=document.querySelector(".ct-auth-card"),this._card&&(this._restUrl=this._card.getAttribute("data-rest-url")||"",this._nonce=this._card.getAttribute("data-nonce")||"",this._cacheVersion=this._card.getAttribute("data-cache-version")||"0",this._homeUrl=this._card.getAttribute("data-home-url")||"/",h(typeof this._restUrl=="string","restUrl must be a string"),h(typeof this._nonce=="string","nonce must be a string"),this._flowData={},this._overlay=null,this._initSubSystems(),this._bindAllForms(),this._bindActions(),this._handleHashNavigation())}_initSubSystems(){this._store=new P(this._cacheVersion),this._api=new M(this._restUrl,this._nonce,this._store),this._binder=new q,this._api.setUnauthorizedHandler(()=>{this._flowData={},this._showForm("login")})}_bindAllForms(){h(this._card instanceof HTMLElement,"card must be HTMLElement");const e=this._card.querySelectorAll("[data-ct-auth-form]"),s=v.length;for(let t=0;t<e.length&&t<s;t++)this._binder.bind(e[t])}_bindActions(){h(typeof this._card.addEventListener=="function","addEventListener must exist"),h(this._card!==null,"card must exist"),this._card.addEventListener("click",e=>{const s=e.target.closest("[data-ct-auth-action]");if(!s)return;e.preventDefault();const t=s.getAttribute("data-ct-auth-action");this._handleAction(t)}),this._card.addEventListener("click",e=>{const s=e.target.closest("[data-ct-auth-tab]");if(!s)return;e.preventDefault();const t=s.getAttribute("data-ct-auth-tab");this._showForm(t)})}_handleHashNavigation(){window.location.hash==="#register"&&this._showForm("register")}_handleAction(e){switch(h(typeof e=="string","action must be a string"),h(e.length>0,"action must not be empty"),e){case"show-forgot":this._showForm("forgot-password");break;case"show-login":this._showForm("login");break;case"show-register":this._showForm("register");break;case"back-to-login":this._flowData={},this._showForm("login");break;case"login":this._submitLogin();break;case"register":this._submitRegister();break;case"forgot":this._submitForgotPassword();break;case"verify-activation":this._submitVerifyActivation();break;case"verify-reset-code":this._submitVerifyResetCode();break;case"reset-password":this._submitResetPassword();break;case"resend-reset-code":this._resendResetCode();break;case"resend-activation-code":this._resendActivationCode();break}}_showForm(e){h(typeof e=="string","name must be a string");const s=this._card.querySelectorAll("[data-ct-auth-form]"),t=v.length;for(let o=0;o<s.length&&o<t;o++){const l=s[o].getAttribute("data-ct-auth-form")===e;s[o].classList.toggle("ct-auth-card__panel--active",l)}const r=this._isTabForm(e),a=this._card.querySelector(".ct-auth-card__tabs"),i=this._card.querySelector("[data-ct-auth-back-bar]");if(a&&(a.style.display=r?"":"none"),i&&(i.style.display=r?"none":""),r){const o=this._card.querySelectorAll("[data-ct-auth-tab]"),l=5;for(let u=0;u<o.length&&u<l;u++){const _=o[u].getAttribute("data-ct-auth-tab")===e;o[u].classList.toggle("ct-auth-card__tab--active",_),o[u].setAttribute("aria-selected",_?"true":"false")}}this._injectFlowData(e);const n=this._getActivePanel();if(n){this._clearMessages(n);const o=n.querySelector(".ct-auth-form__input:not([readonly])");o&&o.focus()}}_getActivePanel(){return this._card.querySelector(".ct-auth-card__panel--active")}_isTabForm(e){for(let s=0;s<b.length;s++)if(b[s]===e)return!0;return!1}_injectFlowData(e){const s=this._getActivePanel();if(s){if(e==="activation-code"||e==="reset-code"){const t=s.querySelector('input[name="email"]');t&&this._flowData.email&&(t.value=this._flowData.email)}if(e==="reset-password"){const t=s.querySelector('input[name="reset_token"]');t&&this._flowData.reset_token&&(t.value=this._flowData.reset_token)}}}_submitLogin(){const e=this._getActivePanel();if(!e)return;const s=e.querySelector('input[name="username_or_email"]'),t=e.querySelector('input[name="password"]');if(!s||!t)return;const r=s.value.trim(),a=t.value;if(!r||!a){this._showMessage(e,"error","Please fill in all fields.");return}this._setLoading(e,!0),this._clearMessages(e),this._blockPage(),this._api.post("login",{username_or_email:r,password:a}).then(i=>{i.success&&i.data?(i.data.token&&this._store.setToken(i.data.token),i.data.nonce&&(this._nonce=i.data.nonce,this._api.setNonce(i.data.nonce)),this._redirectAfterLogin()):(this._setLoading(e,!1),this._unblockPage(),i.data&&i.data.requires_activation?(this._flowData.email=i.data.email||"",this._showForm("activation-code")):this._showMessage(e,"error",i.message||"Login failed."))}).catch(()=>{this._setLoading(e,!1),this._unblockPage(),this._showMessage(e,"error","An error occurred. Please try again.")})}_submitRegister(){const e=this._getActivePanel();if(!e)return;const s={username:e.querySelector('input[name="username"]'),email:e.querySelector('input[name="email"]'),first_name:e.querySelector('input[name="first_name"]'),last_name:e.querySelector('input[name="last_name"]'),password:e.querySelector('input[name="password"]'),password_confirm:e.querySelector('input[name="password_confirm"]')};if(!s.username||!s.email)return;const t={},r=Object.keys(s);for(let a=0;a<r.length&&a<20;a++)s[r[a]]&&(t[r[a]]=s[r[a]].value.trim());if(!t.username||!t.email||!t.first_name||!t.last_name||!t.password||!t.password_confirm){this._showMessage(e,"error","Please fill in all fields.");return}if(t.password!==t.password_confirm){this._showMessage(e,"error","Passwords do not match.");return}if(t.password.length<8){this._showMessage(e,"error","Password must be at least 8 characters.");return}this._setLoading(e,!0),this._clearMessages(e),this._blockPage(),this._api.post("register",t).then(a=>{if(this._setLoading(e,!1),this._unblockPage(),a.success){const i=a.data&&a.data.email?a.data.email:t.email;this._flowData.email=i,this._showForm("activation-code")}else this._showMessage(e,"error",a.message||"Registration failed.")}).catch(()=>{this._setLoading(e,!1),this._unblockPage(),this._showMessage(e,"error","An error occurred. Please try again.")})}_submitForgotPassword(){const e=this._getActivePanel();if(!e)return;const s=e.querySelector('input[name="email"]');if(!s)return;const t=s.value.trim();if(!t){this._showMessage(e,"error","Please enter your email address.");return}this._setLoading(e,!0),this._clearMessages(e),this._blockPage(),this._api.post("forgot-password",{email:t}).then(()=>{this._setLoading(e,!1),this._unblockPage(),this._flowData.email=t,this._showForm("reset-code")}).catch(()=>{this._setLoading(e,!1),this._unblockPage(),this._showMessage(e,"error","An error occurred. Please try again.")})}_resendResetCode(){const e=this._getActivePanel();if(!e)return;const s=this._flowData.email||"";if(!s){this._showMessage(e,"error","Session expired. Please start over.");return}this._setLoading(e,!0),this._clearMessages(e),this._api.post("forgot-password",{email:s}).then(()=>{this._setLoading(e,!1),this._showMessage(e,"success","A new code has been sent to your email.");const t=e.querySelector('input[name="code"]');t&&(t.value="",t.focus())}).catch(()=>{this._setLoading(e,!1),this._showMessage(e,"error","An error occurred. Please try again.")})}_resendActivationCode(){const e=this._getActivePanel();if(!e)return;const s=this._flowData.email||"";if(!s){this._showMessage(e,"error","Session expired. Please start over.");return}this._setLoading(e,!0),this._clearMessages(e),this._api.post("resend-activation",{email:s}).then(()=>{this._setLoading(e,!1),this._showMessage(e,"success","A new activation code has been sent to your email.");const t=e.querySelector('input[name="code"]');t&&(t.value="",t.focus())}).catch(()=>{this._setLoading(e,!1),this._showMessage(e,"error","An error occurred. Please try again.")})}_submitVerifyActivation(){const e=this._getActivePanel();if(!e)return;const s=e.querySelector('input[name="code"]'),t=e.querySelector('input[name="email"]');if(!s||!t)return;const r=s.value.trim(),a=t.value.trim();if(!r||!a){this._showMessage(e,"error","Please enter the 6-digit code.");return}this._setLoading(e,!0),this._clearMessages(e),this._api.post("verify-activation",{email:a,code:r}).then(i=>{this._setLoading(e,!1),i.success?(this._showMessage(e,"success",i.message||"Account activated! You can now log in."),this._flowData={},setTimeout(()=>{this._showForm("login")},1500)):this._showMessage(e,"error",i.message||"Invalid code.")}).catch(()=>{this._setLoading(e,!1),this._showMessage(e,"error","An error occurred. Please try again.")})}_submitVerifyResetCode(){const e=this._getActivePanel();if(!e)return;const s=e.querySelector('input[name="code"]'),t=e.querySelector('input[name="email"]');if(!s||!t)return;const r=s.value.trim(),a=t.value.trim();if(!r||!a){this._showMessage(e,"error","Please enter the 6-digit code.");return}this._setLoading(e,!0),this._clearMessages(e),this._api.post("verify-reset-code",{email:a,code:r}).then(i=>{this._setLoading(e,!1),i.success&&i.data&&i.data.reset_token?(this._flowData.reset_token=i.data.reset_token,this._showForm("reset-password")):this._showMessage(e,"error",i.message||"Invalid code.")}).catch(()=>{this._setLoading(e,!1),this._showMessage(e,"error","An error occurred. Please try again.")})}_submitResetPassword(){const e=this._getActivePanel();if(!e)return;const s=e.querySelector('input[name="new_password"]'),t=e.querySelector('input[name="new_password_confirm"]'),r=e.querySelector('input[name="reset_token"]');if(!s||!t||!r)return;const a=s.value,i=t.value,n=r.value;if(!a||!i){this._showMessage(e,"error","Please fill in all password fields.");return}if(a!==i){this._showMessage(e,"error","Passwords do not match.");return}if(a.length<8){this._showMessage(e,"error","Password must be at least 8 characters.");return}if(!n){this._showMessage(e,"error","Reset session expired. Please start over.");return}this._setLoading(e,!0),this._clearMessages(e),this._api.post("reset-password",{reset_token:n,new_password:a,new_password_confirm:i}).then(o=>{this._setLoading(e,!1),o.success?(this._showMessage(e,"success",o.message||"Password reset! You can now log in."),this._flowData={},this._blockPage(),setTimeout(()=>{window.location.href=window.location.pathname},1500)):this._showMessage(e,"error",o.message||"Password reset failed.")}).catch(()=>{this._setLoading(e,!1),this._showMessage(e,"error","An error occurred. Please try again.")})}_redirectAfterLogin(){h(typeof window.location<"u","window.location must exist");const s=new URLSearchParams(window.location.search).get("redirect_to");s?window.location.href=s:window.location.href=this._homeUrl}_showMessage(e,s,t){if(!e||!(e instanceof HTMLElement))return;const r=e.querySelector(".ct-auth-form__messages");if(!r)return;r.innerHTML="";const a=document.createElement("div");a.className="ct-auth-form__message fs14 ct-auth-form__message--"+s,a.textContent=t,r.appendChild(a)}_clearMessages(e){if(!e)return;const s=e.querySelector(".ct-auth-form__messages");s&&(s.innerHTML="")}_setLoading(e,s){if(!e||!(e instanceof HTMLElement))return;const t=e.querySelector(".ct-auth-form__submit");t&&(t.disabled=s,s?t.classList.add("ct-auth-form__submit--loading"):t.classList.remove("ct-auth-form__submit--loading"))}_blockPage(){if(this._overlay)return;const e=document.createElement("div");e.style.cssText="position:fixed;inset:0;z-index:99999;cursor:not-allowed;",document.body.appendChild(e),this._overlay=e}_unblockPage(){this._overlay&&(this._overlay.remove(),this._overlay=null)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{new y}):new y;
