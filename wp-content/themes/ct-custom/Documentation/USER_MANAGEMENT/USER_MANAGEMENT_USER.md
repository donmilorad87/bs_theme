# BS Custom â€” User Management System (Developer Guide)

> How the authentication, registration, password reset, and profile system works in the BS Custom theme.

---

## Quick Start

### 1. Registration

1. The user navigates to the **Login Register** page (uses the `login-register.php` template)
2. Clicks the **Register** tab
3. Fills in: username, email, first name, last name, password, and password confirmation
4. On submit, the system creates a WordPress subscriber account with `ct_account_active = 0`
5. A **6-digit activation code** is emailed to the user (valid for 30 minutes)
6. The UI automatically switches to the **Activation Code** panel
7. The user enters the code, and on success the account is activated (`ct_account_active = 1`)
8. The user is redirected to the **Sign In** panel

### 2. Login

1. The user enters their username (or email) and password on the **Sign In** panel
2. On success, a JWT token is issued and stored in `localStorage` under the key `ct_auth_token`
3. A WP REST nonce is also returned for cookie-based auth fallback
4. The browser redirects to the home page (or to `redirect_to` if present in the query string)
5. If the account is inactive, the system automatically resends an activation code and shows the activation panel

### 3. Forgot Password

1. From the Sign In panel, the user clicks **Forgot Password**
2. Enters their email address
3. The system always responds with success (to prevent email enumeration)
4. If the email is registered, a **6-digit reset code** is sent (valid for 15 minutes)
5. The user enters the code on the **Reset Code** panel
6. On success, a short-lived JWT reset token is issued (valid for 10 minutes)
7. The user sets a new password on the **Reset Password** panel
8. On success, a confirmation email is sent and the user is redirected to Sign In

### 4. Profile

1. The user navigates to the **Profile** page (uses the `profile.php` template)
2. Non-logged-in users are redirected to the auth page
3. Available actions:
   - **Edit name**: Update first name and last name
   - **Upload avatar**: Upload a profile image (JPEG, PNG, GIF, WebP; max 5 MB)
   - **Change password**: Requires current password, new password, and confirmation
   - **View messages**: See contact messages and admin replies

### 5. Logout

1. The header contains a logout link (bound by `AuthHeader`)
2. On click, the JWT token is cleared from `localStorage` and a logout API call is made
3. The page reloads, and the user is no longer authenticated

---

## Configuration

### JWT Settings

JWT configuration is stored in the WordPress option `bs_custom_jwt_auth` as a JSON string.

| Setting | Key | Default | Description |
|---------|-----|---------|-------------|
| Secret key | `secret` | `''` (empty) | HMAC-SHA256 signing key. Must be at least 16 characters. |
| Expiration | `expiration_hours` | `24` | Token lifetime in hours for login tokens. |

The JWT payload includes:

```json
{
    "iss": "https://your-site.com",
    "iat": 1700000000,
    "exp": 1700086400,
    "user_id": 42
}
```

Reset tokens use a separate payload with `email` and `purpose: "password_reset"` claims, and a 10-minute TTL.

**Algorithm**: HS256 (HMAC-SHA256)
**Max token length**: 4096 characters
**Library**: `firebase/php-jwt`

To configure the JWT secret, set the `bs_custom_jwt_auth` option in the database:

```json
{
    "secret": "your-secret-key-at-least-16-chars",
    "expiration_hours": 24
}
```

### Email / SMTP Settings

Email configuration is stored in the WordPress option `bs_custom_email_config` as a JSON string. The system uses PHPMailer with direct SMTP transport.

| Setting | Key | Default | Description |
|---------|-----|---------|-------------|
| SMTP host | `host` | `''` | SMTP server hostname (e.g., `smtp.gmail.com`) |
| SMTP port | `port` | `587` | SMTP server port |
| Username | `username` | `''` | SMTP authentication username |
| Password | `password` | `''` | SMTP authentication password |
| Encryption | `encryption` | `tls` | `tls`, `ssl`, or empty for none |
| From email | `from_email` | Admin email | Sender email address |
| From name | `from_name` | Site name | Sender display name |

Emails are sent as HTML with a plain-text alternative (auto-generated by stripping HTML tags). When `WP_DEBUG` is enabled, PHPMailer errors are written to `error_log`.

---

## Page Access Control

The system provides three Gutenberg blocks for controlling page access. When placed on a page, the `PageAccessControl` class intercepts the request on `template_redirect` and redirects the visitor if they do not meet the requirement.

### Available Blocks

| Block Name | Behavior |
|------------|----------|
| `ct-custom/unprotected-page` | **Guests only**. Logged-in users are redirected to the profile page. |
| `ct-custom/protected-page` | **Logged-in users only**. Guests are redirected to the auth (login) page. |
| `ct-custom/admin-page` | **Admins only**. Guests go to the auth page. Non-admin users go to the home page. |

### How to Use

1. Open a page in the **Block Editor** (Gutenberg)
2. Add one of the access control blocks anywhere in the page content
3. The block does not render any visible output; it only controls redirect behavior
4. The check runs on every frontend request to a singular page via `template_redirect`

### Redirect Destinations

- **Unprotected page** (logged-in user visits): Redirects to `bs_custom_get_profile_page_url()`
- **Protected page** (guest visits): Redirects to `bs_custom_get_auth_page_url()`
- **Admin page** (guest visits): Redirects to `bs_custom_get_auth_page_url()`
- **Admin page** (non-admin logged-in user visits): Redirects to `ct_get_language_home_url()`

### Page Templates

The two main auth templates also perform their own access checks:

- **`login-register.php`**: Redirects logged-in users to the profile page
- **`profile.php`**: Redirects non-logged-in users to the auth page

---

## Validation Rules

### Password Requirements

Enforced by the `PasswordValidator` trait (server-side) and `auth-config.js` `VALIDATION.PASSWORD_RULES` (client-side):

| Rule | Description |
|------|-------------|
| Minimum length | At least **8 characters** |
| Lowercase | At least one lowercase letter (`a-z`) |
| Uppercase | At least one uppercase letter (`A-Z`) |
| Digit | At least one digit (`0-9`) |
| Special character | At least one non-alphanumeric character |

Additional password rules on specific endpoints:

- **Reset Password**: The new password must not be the same as the current password
- **Profile Change Password**: The new password must differ from the current password; the current password must be verified first

### Username Requirements

Enforced by the `Register` endpoint (server-side) and `VALIDATION.USERNAME_RULES` (client-side):

| Rule | Description |
|------|-------------|
| Minimum length | At least **4 characters** |
| Allowed characters | Letters, numbers, hyphens (`-`), underscores (`_`), and dots (`.`) only |
| Max special characters | At most **2** special characters (from `- _ .`) per username |

### Email Validation

- Server-side: Uses WordPress `is_email()` function
- Client-side: Regex pattern `/^[^\s@]+@[^\s@]+\.[^\s@]+$/`

### Verification Codes

- **Format**: 6-digit zero-padded numeric string (e.g., `042891`)
- **Activation code TTL**: 30 minutes
- **Reset code TTL**: 15 minutes
- Codes are stored as WordPress transients and verified with timing-safe comparison (`hash_equals`)

---

## Frontend JS Integration

The frontend auth system is built with vanilla ES6 classes, bundled by Vite. There are no framework dependencies.

### Entry Points

| File | Template | Purpose |
|------|----------|---------|
| `auth-page.js` | `login-register.php` | Drives the auth page state machine (login, register, forgot password, activation, reset) |
| `auth-header.js` | All pages (via header) | Handles the logout button in the site header |

### Module Architecture (`auth/` directory)

| Module | Responsibility |
|--------|---------------|
| `auth-config.js` | Constants: form names, validation rules, localStorage key (`ct_auth_token`) |
| `auth-store.js` | localStorage wrapper for JWT token (`getToken`, `setToken`, `clearToken`) |
| `auth-api.js` | REST client with `post()` (nonce auth), `postAuth()` (JWT auth), `getAuth()`, and `uploadAuth()` (file upload) |
| `auth-form-binder.js` | Binds validation events, Enter-key submission, and password visibility toggles to server-rendered form panels |
| `auth-validator.js` | Real-time rule-based validation engine. Validates fields on `input` and `blur` events using `data-ct-validate-*` attributes |
| `auth-profile.js` | Profile page actions: avatar upload, name save, password change, and message loading |

### Auth Page State Machine

`AuthPage` manages six form panels as a state machine:

```
LOGIN <---> REGISTER       (tab switching)
LOGIN  ---> FORGOT_PASSWORD
LOGIN  ---> ACTIVATION_CODE (when account is inactive)
FORGOT_PASSWORD ---> RESET_CODE
RESET_CODE ---> RESET_PASSWORD
ACTIVATION_CODE ---> LOGIN  (after successful activation)
RESET_PASSWORD ---> LOGIN   (after successful reset)
```

**Tab forms** (`login`, `register`): Show the tab bar at the top.
**Flow forms** (`forgot-password`, `activation-code`, `reset-code`, `reset-password`): Hide the tab bar and show a "Return to Sign In" back button.

Flow data (email, reset token) is passed between panels via the `_flowData` object and injected into hidden form fields when switching panels.

### Authentication Flow (JS side)

1. **Public requests** (login, register, forgot password, verify codes): Use `AuthApi.post()` which sends the `X-WP-Nonce` header
2. **Protected requests** (profile update, password change, avatar upload): Use `AuthApi.postAuth()` or `AuthApi.uploadAuth()` which add the `Authorization: Bearer <token>` header
3. On login success, the JWT token is stored via `AuthStore.setToken()` and the nonce is updated
4. On logout, `AuthStore.clearToken()` is called and a `POST /logout` request is made
5. On 401 responses, the unauthorized handler resets flow data and returns to the login form

### Validation Attributes (HTML)

The `AuthValidator` reads these `data-` attributes from form inputs:

| Attribute | Purpose |
|-----------|---------|
| `data-ct-validate-required` | Field must not be empty |
| `data-ct-validate-password` | Validates against all password rules (shows checklist UI) |
| `data-ct-validate-username` | Validates against all username rules (shows checklist UI) |
| `data-ct-validate-email` | Must match email regex |
| `data-ct-validate-match="field_name"` | Value must match another field (e.g., confirm password) |
| `data-ct-validate-code` | Must be a 6-digit numeric string |
| `data-ct-validate-min="N"` | Minimum character length |

---

## REST API Endpoints

All auth endpoints are registered under the `ct-auth/v1` namespace.

### Authentication Endpoints

| Method | Path | Auth | Description |
|--------|------|------|-------------|
| POST | `/wp-json/ct-auth/v1/login` | Public | Authenticate with username/email and password. Returns JWT token and nonce. |
| POST | `/wp-json/ct-auth/v1/register` | Public | Create a new subscriber account. Sends activation code email. |
| POST | `/wp-json/ct-auth/v1/logout` | JWT or Cookie | Log out the current user. Destroys the WordPress session. |
| POST | `/wp-json/ct-auth/v1/forgot-password` | Public | Request a password reset code. Always returns success. |
| POST | `/wp-json/ct-auth/v1/verify-activation` | Public | Verify a 6-digit activation code and activate the account. |
| POST | `/wp-json/ct-auth/v1/resend-activation` | Public | Resend the activation code. Always returns success. |
| POST | `/wp-json/ct-auth/v1/verify-reset-code` | Public | Verify a 6-digit reset code. Returns a short-lived JWT reset token. |
| POST | `/wp-json/ct-auth/v1/reset-password` | Public (reset token) | Set a new password using the reset token. |

### Profile Endpoints

| Method | Path | Auth | Description |
|--------|------|------|-------------|
| POST | `/wp-json/ct-auth/v1/profile/update` | JWT or Cookie | Update first name and last name. |
| POST | `/wp-json/ct-auth/v1/profile/change-password` | JWT or Cookie | Change password (requires current password). |
| POST | `/wp-json/ct-auth/v1/profile/upload-avatar` | JWT or Cookie | Upload avatar image (multipart/form-data, field name: `avatar`). |

### Authentication Methods

Protected endpoints accept two authentication methods (checked in order):

1. **JWT Bearer token**: `Authorization: Bearer <token>` header
2. **WordPress cookie**: Standard WordPress login cookie (fallback)

The permission callback `ct_jwt_or_cookie_permission_check` tries JWT first (if an `Authorization` header is present), then falls back to cookie auth. Public endpoints use `__return_true` as their permission callback.

### Rate Limiting

Rate limits are enforced via WordPress transients:

| Endpoint | Limit | Window | Tracked By |
|----------|-------|--------|------------|
| Login | 5 attempts | 5 minutes | IP address |
| Register | 3 attempts | 1 hour | IP address |
| Forgot Password | 3 attempts | 1 hour | Email address |
| Resend Activation | 3 attempts | 1 hour | Email address |
| Verify Activation | 5 attempts | 5 minutes | IP address |
| Verify Reset Code | 5 attempts | 5 minutes | IP address |
| Upload Avatar | 5 uploads | 1 minute | User ID |

When rate-limited, the API returns HTTP `429` with a human-readable wait time message (e.g., "2 minute(s) and 30 second(s)").

**Anti-enumeration**: The `forgot-password` and `resend-activation` endpoints always return `200 OK` with a generic success message regardless of whether the email exists, preventing attackers from discovering valid email addresses.

### Request / Response Format

All endpoints accept `Content-Type: application/json` (except avatar upload which uses `multipart/form-data`).

**Success response:**

```json
{
    "success": true,
    "message": "Human-readable message.",
    "data": { }
}
```

**Error response:**

```json
{
    "success": false,
    "message": "Human-readable error message."
}
```

### Login Response Data

```json
{
    "success": true,
    "data": {
        "display_name": "John Doe",
        "nonce": "abc123def456",
        "token": "eyJhbGciOiJIUzI1NiIs..."
    }
}
```

### Inactive Account Response (Login, HTTP 403)

```json
{
    "success": false,
    "message": "Please activate your account. A new activation code has been sent to your email.",
    "data": {
        "requires_activation": true,
        "email": "user@example.com"
    }
}
```

---

## Troubleshooting

### JWT Secret Not Configured

**Symptom**: Login succeeds but no token is returned (empty string). Protected endpoints fail with 401.

**Cause**: The `bs_custom_jwt_auth` option is missing or the `secret` value is empty or shorter than 16 characters.

**Fix**: Set the option in the database with a strong secret key:

```sql
UPDATE wp_options
SET option_value = '{"secret":"your-secret-key-minimum-16-chars","expiration_hours":24}'
WHERE option_name = 'bs_custom_jwt_auth';
```

When `WP_DEBUG` is enabled, the error `[CT_JWT_Service] JWT secret is not configured or too short.` will appear in the PHP error log.

### Emails Not Sending

**Symptom**: Registration succeeds but no activation email arrives. Password reset codes are not received.

**Possible causes and fixes**:

1. **SMTP not configured**: Check that the `bs_custom_email_config` option has valid `host`, `username`, and `password` values
2. **Wrong port or encryption**: Common configs: port `587` with `tls`, or port `465` with `ssl`
3. **Firewall blocking outbound SMTP**: Ensure the server allows outbound connections on the SMTP port
4. **PHPMailer errors**: Enable `WP_DEBUG` and check for `[CT_Mail_Service] PHPMailer error:` messages in the error log
5. **Spam folder**: Check the recipient's spam/junk folder

### Rate Limiting Issues

**Symptom**: The user receives "Too many attempts" errors (HTTP 429).

**Cause**: Rate limits are tracked via WordPress transients. Exceeding the limit locks the user out for the duration of the window.

**Fix for development/testing**: Delete the relevant transients from the database:

```sql
DELETE FROM wp_options
WHERE option_name LIKE '_transient_ct_login_attempts_%'
   OR option_name LIKE '_transient_timeout_ct_login_attempts_%';
```

Replace `ct_login_attempts_` with the relevant prefix (`ct_register_attempts_`, `ct_forgot_attempts_`, `ct_verify_activation_`, `ct_verify_reset_`, `ct_resend_activation_`, `ct_avatar_upload_`).

### Account Not Activating

**Symptom**: The user enters the activation code but gets "Invalid or expired activation code."

**Possible causes**:

1. **Code expired**: Activation codes are valid for 30 minutes. The user should click "Resend" to get a fresh code
2. **Typo**: The code is 6 digits. Ensure no extra spaces
3. **Multiple codes sent**: Only the most recently generated code is valid. Earlier codes are overwritten
4. **Rate limited**: After 5 failed verification attempts within 5 minutes, the IP is rate-limited

### Protected Pages Not Redirecting

**Symptom**: A page with an access control block is visible to unauthorized users.

**Possible causes**:

1. **Block not present in content**: The access control block must be placed in the page's block editor content. It is checked via `has_block()`
2. **Not a singular page**: The redirect logic only runs on singular pages (`is_singular()`)
3. **Caching**: A page cache plugin may be serving a cached version. Exclude auth-controlled pages from the cache

### Token Expired

**Symptom**: The user was logged in but protected API calls start returning 401.

**Cause**: The JWT token has expired (default: 24 hours after issuance).

**Fix**: The user must log in again. The frontend unauthorized handler automatically redirects to the login form when a 401 is received on a protected request.

### Avatar Upload Fails

**Symptom**: "Failed to upload avatar" or "File must be less than 5MB."

**Constraints**:

- **Max file size**: 5 MB
- **Allowed types**: `image/jpeg`, `image/png`, `image/gif`, `image/webp`
- **Rate limit**: 5 uploads per minute per user
- The file is uploaded to the WordPress media library and the attachment ID is stored in user meta as `ct_avatar_id`

### Debug Logging

When `WP_DEBUG` is enabled, all auth endpoints log key events to `error_log` with the format:

```
[CT_REST_Login] Auth failed: user not found for login=baduser
[CT_REST_Register] Rate limited: IP=192.168.1.100
[CT_REST_ForgotPassword] Rate limited: email=user@example.com
```

These logs appear in the PHP error log (e.g., `docker logs` output when running in Docker, or the configured error log file).
